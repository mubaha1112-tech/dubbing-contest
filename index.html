<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ±æ­¥-å¥‡å£°å¦™æƒ³ Firstleap Voice Magic</title>
    <style>
        /* ================= ä¿æŒåŸæœ‰çš„æ—¶å°šå¯çˆ±é£æ ¼æ ·å¼ ================= */
        :root {
            --bg-cream: #F9F6E8;
            --card-white: #ffffff;
            --monster-green: #7BC043;
            --rabbit-pink: #FF8E8E;
            --rabbit-red: #EE5253;
            --pear-yellow: #F9CA24;
            --text-dark: #2d3436;
            --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
            --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
        }

        body { 
            font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--bg-cream);
            margin: 0; 
            padding: 20px 10px; 
            text-align: center; 
            color: var(--text-dark);
        }
        
        .container { 
            background: var(--card-white); 
            padding: 25px 20px; 
            border-radius: 30px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.08); 
            max-width: 600px; 
            margin: 0 auto; 
            position: relative; 
            border: 5px solid #fff;
            transition: all 0.3s ease;
        }

        /* === å¤´éƒ¨æ ·å¼ === */
        .header-banner {
            width: 100%;
            border-radius: 20px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
            min-height: 100px; background: #eee;
        }
        .header-banner img {
            width: 100%;
            height: auto;
            display: block;
            mix-blend-mode: multiply; 
        }

        h1 { 
            color: var(--rabbit-red); 
            font-size: 26px; 
            margin: 10px 0 25px; 
            text-shadow: 2px 2px 0px #ffe3e3;
            font-weight: 900;
            letter-spacing: 1px;
            position: relative;
            display: inline-block;
        }
        h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
        h1::before { content: "ğŸµ"; position: absolute; left: -25px; top: 10px; font-size: 20px; animation: bounce 2s infinite reverse; }

        /* ================= æ§ä»¶æ ·å¼ ================= */
        .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
        .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }

        select { 
            width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px; 
            font-size: 16px; background: #fafafa; outline: none; transition: 0.3s; color: #555; font-weight: bold;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 18px;
        }
        select:focus { border-color: var(--pear-yellow); background-color: #fff; }
        
        .btn { 
            display: block; width: 100%; padding: 16px; border: none; border-radius: 25px; 
            font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px; 
            transition: all 0.2s; box-shadow: var(--shadow-3d); position: relative; overflow: hidden;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .btn:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); } 
        .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        
        .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
        .btn-stop { 
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); 
            animation: pulse 1.5s infinite; 
            position: relative; z-index: 1002;
        }
        
        .btn-group { display: flex; gap: 15px; margin-top: 15px; }
        /* ä¿®æ”¹ï¼šä¸‹è½½æŒ‰é’®æ ·å¼ï¼Œå»é™¤flexå±…ä¸­ï¼Œç”¨blockä¿è¯ç‚¹å‡»åŒºåŸŸ */
        .btn-download { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            text-decoration: none; 
            line-height: 1.5; 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: #fff; 
            font-weight: bold; 
            border-radius: 25px; 
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); 
            font-size: 18px;
            padding: 16px;
            border: none;
        }
        .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* ================= è§†é¢‘åŒºåŸŸ ================= */
        #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
        video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; outline: none; border: 4px solid #fff; object-fit: contain; }
        video:fullscreen { border: none; border-radius: 0; width: 100%; height: 100%; }
        canvas { display: none; }
        
        .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }
        
        .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
        .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

        /* ================= å½•åˆ¶æ—¶çš„å…¨å±æ ·å¼ ================= */
        body.recording-mode {
            overflow: hidden; background: #000; padding: 0;
        }
        body.recording-mode .container {
            max-width: 100%; height: 100vh; border-radius: 0; border: none;
            padding: 0; display: flex; flex-direction: column; justify-content: center;
            background: #000;
        }
        body.recording-mode .header-banner, 
        body.recording-mode h1,
        body.recording-mode .step-label,
        body.recording-mode select,
        body.recording-mode #searchBtn,
        body.recording-mode #playBtn,
        body.recording-mode .tip,
        body.recording-mode .status-text {
            display: none !important;
        }
        body.recording-mode #video-container {
            margin: 0; height: 100%; width: 100%; display: flex; 
            align-items: center; justify-content: center; background: #000;
        }
        body.recording-mode #mainVideo {
            max-height: 85vh; border: none; box-shadow: none; width: 100%;
        }
        body.recording-mode #actionBtn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 60%; max-width: 200px; z-index: 1001;
        }

        /* ================= åŠ è½½å±‚ ================= */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            display: none; align-items: center; justify-content: center; flex-direction: column;
            border-radius: 20px; backdrop-filter: blur(3px);
        }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= å€’è®¡æ—¶ & è¿›åº¦æ¡é®ç½© ================= */
        .overlay-fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 142, 142, 0.95); 
            z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(5px); text-align: center;
        }
        
        .countdown-number {
            font-size: 150px; color: #fff; font-weight: 900;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            font-family: "Arial Rounded MT Bold", "Comic Sans MS", sans-serif;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container { width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px; }
        .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
        
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<!-- å€’è®¡æ—¶å±‚ -->
<div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
</div>

<!-- è§†é¢‘å‹åˆ¶è¿›åº¦å±‚ -->
<div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">è§†é¢‘åˆæˆä¸­...<br><span style="font-size:16px; opacity:0.8;">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
</div>

<div class="container">
    <div class="header-banner">
        <!-- è¯·æ›¿æ¢è¿™é‡Œçš„å›¾ç‰‡é“¾æ¥ -->
        <img src="header.png" alt="Firstleap Elves" onerror="this.parentElement.style.background='#ddd'">
    </div>

    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">å¥‡å£°å¦™æƒ³é…éŸ³ç§€</span></h1>
    
    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
        <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
        <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <div id="video-container">
        <div id="loaderOverlay" class="loader-overlay">
            <div class="spinner"></div>
            <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
        </div>

        <video id="mainVideo" playsinline controls controlsList="nodownload" crossOrigin="anonymous">
            <source src="" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
        </video>
        
        <div class="tip">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·åŠ¡å¿…ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°å•¸å«ï¼</div>
        <div class="status-text" id="statusText"></div>

        <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>

        <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>
        
        <canvas id="processCanvas"></canvas>
    </div>

    <!-- ç»“æœåŒºåŸŸï¼šé»˜è®¤éšè—ï¼Œåªæœ‰å½“è§†é¢‘å®Œå…¨ç”Ÿæˆåæ‰ä¼šæ˜¾ç¤º -->
    <div id="resultArea" class="preview-box">
        <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
        <p style="font-size:12px; color:#999; margin-bottom:15px;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>
        
        <!-- ç»“æœè§†é¢‘ -->
        <video id="previewVideo" style="width:100%; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); background:#000;" controls playsinline></video>
        
        <div class="btn-group">
            <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
            <!-- ä¿®æ”¹ï¼šä¸‹è½½æŒ‰é’®ç›´æ¥ä½¿ç”¨ download å±æ€§ï¼Œç‚¹å‡»å³å¯è§¦å‘ -->
            <a id="downloadLink" class="btn btn-download" target="_blank">ğŸ’¾ ä¿å­˜è§†é¢‘ (Save MP4)</a>
        </div>
        
        <div style="font-size:10px; color:#999; margin-top:15px; text-align:center;">
            * å¦‚æœç‚¹å‡»æ— ååº”ï¼Œè¯·å°è¯•é•¿æŒ‰ä¸Šæ–¹çš„è§†é¢‘é€‰æ‹©"ä¿å­˜"
        </div>
    </div>
</div>

<script>
    // ================= æ•°æ®é…ç½®åŒº =================
    const videoDatabase = {
        "K2A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4", 
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4", 
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4",
            "", "", "" 
        ],
        "K2B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4",
            "", "", ""
        ],
        "K3A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4",
            "", "", ""
        ],
        "K3B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4",
            "", "", ""
        ],
        "G0": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"
        ],
        "G1A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4", 
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"
        ],
        "G1B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023453394e0d4dd.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"
        ],
        "G2A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4",
            ""
        ],
        "G2B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4",
            "", "", ""
        ],
        "G3A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4",
            "", "", ""
        ],
        "G3B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4",
            "", "", "", "", ""
        ],
        "G4A": [
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4",
            "", "", ""
        ],
        "G4B": [
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4",
            "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4",
            "", "", ""
        ]
    };

    // ================= å˜é‡åŒº =================
    let mediaRecorder;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let sourceVideo = null;
    let sourceMic = null;
    let dest = null;
    let micGainNode = null;   
    let videoGainNode = null; 
    let isRecording = false;
    let recordedMimeType = ''; 
    let animationFrameId = null;

    // ================= åˆå§‹åŒ– =================
    const levels = Object.keys(videoDatabase);
    const levelSelect = document.getElementById("levelSelect");
    levels.forEach(lvl => {
        let option = document.createElement("option");
        option.value = lvl;
        option.text = lvl;
        levelSelect.appendChild(option);
    });

    function updateUnits() {
        const lvl = document.getElementById("levelSelect").value;
        const unitSelect = document.getElementById("unitSelect");
        unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
        unitSelect.disabled = true;
        
        if (lvl && videoDatabase[lvl]) {
            let hasUnits = false;
            for (let i = 0; i < videoDatabase[lvl].length; i++) {
                 if (videoDatabase[lvl][i] && videoDatabase[lvl][i] !== "") {
                     let option = document.createElement("option");
                     option.value = i;
                     option.text = "Unit " + (i + 1);
                     unitSelect.appendChild(option);
                     hasUnits = true;
                 }
            }
            if(hasUnits) unitSelect.disabled = false;
        }
    }

    function findVideo() {
        const lvl = document.getElementById("levelSelect").value;
        const unitIndex = document.getElementById("unitSelect").value;
        const videoContainer = document.getElementById("video-container");
        const videoPlayer = document.getElementById("mainVideo");
        const loader = document.getElementById("loaderOverlay");
        const actionBtn = document.getElementById("actionBtn");
        const playBtn = document.getElementById("playBtn"); 

        if (!lvl || unitIndex === "") {
            alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼");
            return;
        }

        const url = videoDatabase[lvl][unitIndex];
        
        document.getElementById("resultArea").style.display = "none";
        
        actionBtn.style.display = "none";
        actionBtn.className = "btn btn-record";
        actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
        
        playBtn.style.display = "none"; 
        
        videoContainer.style.display = "block";
        loader.style.display = "flex";
        
        videoPlayer.src = url;
        videoPlayer.load();
        videoPlayer.volume = 1.0; 

        videoPlayer.onprogress = function() {
            if (videoPlayer.buffered.length > 0) {
                const duration = videoPlayer.duration;
                const buffered = videoPlayer.buffered.end(0);
                if (duration > 0) {
                    const percent = Math.min(100, Math.floor((buffered / duration) * 100));
                    document.getElementById("loadingText").innerText = "è§†é¢‘ç¼“å†²ä¸­ " + percent + "%";
                }
            }
        };

        videoPlayer.oncanplaythrough = function() {
            loader.style.display = "none";
            actionBtn.style.display = "block";
            playBtn.style.display = "block"; 
            document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•ï¼Œå¯å…ˆé¢„è§ˆï¼Œæˆ–ç›´æ¥é…éŸ³";
        };

        videoPlayer.onended = function() {
            if(!isRecording) playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
        };

        videoPlayer.onplay = function() {
            if (!isRecording) playBtn.innerHTML = "â¸ï¸ æš‚åœæ’­æ”¾ Pause";
        };
        videoPlayer.onpause = function() {
            if (!isRecording) playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
        };

        videoPlayer.onerror = function() {
            loader.style.display = "none";
            alert("è§†é¢‘åŠ è½½å¤±è´¥ã€‚åŸå› å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–è·¨åŸŸé™åˆ¶ã€‚\nå¦‚æœè§†é¢‘æ— æ³•åŠ è½½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨CORSè®¾ç½®ã€‚");
            document.getElementById("statusText").innerText = "âŒ è§†é¢‘åŠ è½½å¤±è´¥";
        };
        
        videoContainer.scrollIntoView({behavior: "smooth"});
    }

    function togglePreview() {
        const video = document.getElementById("mainVideo");
        if (video.paused) {
            video.volume = 1.0; 
            video.muted = false;
            video.play();
        } else {
            video.pause();
        }
    }

    function resetRecording() {
        document.getElementById("resultArea").style.display = "none";
        
        const actionBtn = document.getElementById("actionBtn");
        actionBtn.style.display = "block";
        actionBtn.className = "btn btn-record";
        actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
        
        document.getElementById("playBtn").style.display = "block"; 
        document.getElementById("playBtn").innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
        document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®ï¼Œè¯·ç‚¹å‡»æŒ‰é’®å†æ¬¡é…éŸ³";
        
        const mainVideo = document.getElementById("mainVideo");
        mainVideo.currentTime = 0;
        mainVideo.pause();
        mainVideo.controls = true;
        
        exitFullscreenMode();

        const preview = document.getElementById("previewVideo");
        if(preview.src) {
            URL.revokeObjectURL(preview.src);
            preview.src = "";
        }
        
        document.getElementById("video-container").scrollIntoView({behavior: "smooth"});
    }

    // ================= æ ¸å¿ƒå½•åˆ¶é€»è¾‘ =================

    function getBestMimeType() {
        const types = [
            "video/mp4;codecs=avc1",      // iOS/Safari ä¼˜å…ˆ
            "video/mp4",                  
            "video/webm;codecs=h264",     
            "video/webm;codecs=vp9",      
            "video/webm"                  
        ];
        for (const type of types) {
            if (MediaRecorder.isTypeSupported(type)) {
                console.log("Using MIME type:", type);
                return type;
            }
        }
        return "";
    }

    function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            prepareAndStartRecording();
        }
    }

    async function prepareAndStartRecording() {
        const video = document.getElementById("mainVideo");
        if (video.readyState < 2) {
            alert("è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæ¯•");
            return;
        }

        try {
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: true, 
                    noiseSuppression: true, 
                    autoGainControl: true 
                } 
            });
        } catch (err) {
            alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼è¯·åœ¨æ‰‹æœºè®¾ç½®/æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½¿ç”¨éº¦å…‹é£ã€‚");
            return;
        }

        // å€’è®¡æ—¶
        const overlay = document.getElementById('countdown-overlay');
        const text = document.getElementById('countdownText');
        let count = 3;
        
        overlay.style.display = 'flex';
        text.innerText = count;
        text.style.animation = 'none';
        text.offsetHeight; 
        text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                text.innerText = count;
                text.style.animation = 'none';
                text.offsetHeight; 
                text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            } else {
                clearInterval(timer);
                text.innerText = "GO!";
                setTimeout(() => {
                    overlay.style.display = 'none';
                    enterFullscreenMode(); 
                    executeActualRecording();
                }, 500);
            }
        }, 1000);
    }

    function enterFullscreenMode() {
        document.body.classList.add('recording-mode');
        const docElm = document.documentElement;
        if (docElm.requestFullscreen) { docElm.requestFullscreen().catch(e=>{}); }
        else if (docElm.mozRequestFullScreen) { docElm.mozRequestFullScreen().catch(e=>{}); }
        else if (docElm.webkitRequestFullScreen) { docElm.webkitRequestFullScreen().catch(e=>{}); }
    }

    function exitFullscreenMode() {
        document.body.classList.remove('recording-mode');
        if (document.exitFullscreen) { document.exitFullscreen().catch(e=>{}); }
        else if (document.mozCancelFullScreen) { document.mozCancelFullScreen().catch(e=>{}); }
        else if (document.webkitCancelFullScreen) { document.webkitCancelFullScreen().catch(e=>{}); }
    }

    async function executeActualRecording() {
        const video = document.getElementById("mainVideo");
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");
        const status = document.getElementById("statusText");
        const actionBtn = document.getElementById("actionBtn");
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx || audioCtx.state === 'closed') {
            audioCtx = new AudioContext();
        } else if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }
        
        video.currentTime = 0;
        video.muted = false; 
        video.volume = 1.0; 
        video.controls = false;
        
        try { 
            await video.play(); 
        } catch (e) { 
            alert("è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»å±å¹•"); 
            video.controls = true; 
            return; 
        }

        const MAX_WIDTH = 1280;
        let w = video.videoWidth;
        let h = video.videoHeight;
        
        if (w > MAX_WIDTH) {
            h = Math.round(h * (MAX_WIDTH / w));
            w = MAX_WIDTH;
        }
        
        canvas.width = w;
        canvas.height = h;

        dest = audioCtx.createMediaStreamDestination();
        micGainNode = audioCtx.createGain();
        videoGainNode = audioCtx.createGain();
        
        micGainNode.gain.value = 3.0; 
        videoGainNode.gain.value = 0.2; 

        sourceMic = audioCtx.createMediaStreamSource(micStream);
        sourceMic.connect(micGainNode);
        micGainNode.connect(dest);

        try {
            if (!video._audioSourceNode) {
                sourceVideo = audioCtx.createMediaElementSource(video);
                video._audioSourceNode = sourceVideo;
            } else {
                sourceVideo = video._audioSourceNode;
            }
            sourceVideo.connect(videoGainNode);
            videoGainNode.connect(dest);
            sourceVideo.connect(audioCtx.destination); 
        } catch (e) { console.error("Audio routing error:", e); }

        try {
            canvasStream = canvas.captureStream(30); 
        } catch(e) {
             console.error(e);
             alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Canvas å½•åˆ¶ã€‚");
             stopRecording();
             return;
        }

        const mixedAudioTrack = dest.stream.getAudioTracks()[0];
        if (!mixedAudioTrack || canvasStream.getVideoTracks().length === 0) {
             alert("æ— æ³•è·å–éŸ³è§†é¢‘æµï¼Œè¯·ç¡®ä¿å…è®¸æƒé™");
             stopRecording();
             return;
        }

        const combinedStream = new MediaStream([
            canvasStream.getVideoTracks()[0],
            mixedAudioTrack
        ]);

        recordedMimeType = getBestMimeType();
        if (!recordedMimeType) {
            alert("æ‚¨çš„è®¾å¤‡æš‚ä¸æ”¯æŒç½‘é¡µå½•åˆ¶ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Safariã€‚");
            stopRecording();
            return;
        }

        try {
            mediaRecorder = new MediaRecorder(combinedStream, { 
                mimeType: recordedMimeType, 
                videoBitsPerSecond: 2500000 
            });
        } catch (e) {
            console.error("Recorder init fail:", e);
            mediaRecorder = new MediaRecorder(combinedStream);
        }

        recordedChunks = [];
        mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
                recordedChunks.push(e.data);
            }
        };
        
        mediaRecorder.onstop = () => {
             console.log("Recorder stopped.");
             // å…³é”®ä¿®æ”¹ï¼šå½•åˆ¶åœæ­¢åç«‹å³å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»ï¼ŒåŠ¨ç”»ç»“æŸåæ‰ç”Ÿæˆ Blob å¹¶æ˜¾ç¤ºæŒ‰é’®
             startProcessingAnimation(); 
        };

        isRecording = true;
        
        drawToCanvas(video, ctx, canvas);
        
        mediaRecorder.start(1000); 
        
        document.getElementById("playBtn").style.display = "none"; 
        actionBtn.innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ (Stop)";
        actionBtn.className = "btn btn-stop";
        
        status.innerText = "ğŸ”´ å½•åˆ¶ä¸­ (Recording)...";
        status.style.color = "#FF0000";
        
        video.onended = stopRecording; 
    }

    function drawToCanvas(video, ctx, canvas) {
        if (!isRecording) {
            cancelAnimationFrame(animationFrameId);
            return;
        }
        
        try {
            if (video.readyState >= 2 && !video.paused && !video.ended) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
        } catch (e) { 
            console.error("Canvas Draw Error:", e);
            isRecording = false;
            exitFullscreenMode();
            alert("å½•åˆ¶ä¸­æ–­ï¼šè·¨åŸŸé™åˆ¶(CORS)ã€‚è¯·è”ç³»ç®¡ç†å‘˜ç»™è§†é¢‘æœåŠ¡å™¨æ·»åŠ  'Access-Control-Allow-Origin: *' å¤´ã€‚");
            stopRecording();
            return;
        }
        
        animationFrameId = requestAnimationFrame(() => drawToCanvas(video, ctx, canvas));
    }

    function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        cancelAnimationFrame(animationFrameId);

        exitFullscreenMode();

        const video = document.getElementById("mainVideo");
        const actionBtn = document.getElementById("actionBtn");

        video.pause();
        video.controls = true;

        // åœæ­¢ Recorder
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
        }

        if (micStream) micStream.getTracks().forEach(track => track.stop());
        
        actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
        actionBtn.className = "btn btn-record";
        
        document.getElementById("statusText").innerText = "âœ¨ è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...";
        document.getElementById("statusText").style.color = "var(--pear-yellow)";
    }

    // ================= å‹åˆ¶è¿›åº¦ & ç»“æœå±•ç¤º =================

    function startProcessingAnimation() {
        // ç¡®ä¿ Result åŒºåŸŸæ˜¯éšè—çš„
        document.getElementById("resultArea").style.display = "none";
        
        const overlay = document.getElementById('processing-overlay');
        const bar = document.getElementById('progressBar');
        const text = document.getElementById('progressText');
        
        overlay.style.display = 'flex';
        let progress = 0;
        bar.style.width = '0%';
        text.innerText = '0%';

        const interval = setInterval(() => {
            // æ¨¡æ‹Ÿè¿›åº¦
            progress += Math.floor(Math.random() * 5) + 2; 
            if (progress > 100) progress = 100;

            bar.style.width = progress + '%';
            text.innerText = progress + '%';

            if (progress >= 100) {
                clearInterval(interval);
                // è¿›åº¦æ¡èµ°å®Œåï¼Œè°ƒç”¨ç”Ÿæˆé€»è¾‘
                setTimeout(() => {
                    generateVideoAndShowResult(overlay); 
                }, 500);
            }
        }, 50); 
    }

    function generateVideoAndShowResult(overlay) {
        if(recordedChunks.length === 0) {
            overlay.style.display = 'none';
            alert("å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©ºã€‚å¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰è·å–åˆ°ç”»é¢æˆ–å£°éŸ³ã€‚");
            return;
        }

        try {
            // 1. åˆ›å»º Blob
            let type = recordedMimeType || 'video/webm';
            const blob = new Blob(recordedChunks, { type: type });
            
            // 2. ç”Ÿæˆ URL
            const url = URL.createObjectURL(blob);
            
            // 3. è®¾ç½®é¢„è§ˆè§†é¢‘æº
            const preview = document.getElementById("previewVideo");
            preview.src = url;
            
            // 4. é…ç½®ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById("downloadLink");
            let filename = `Firstleap_Voice_${Date.now()}.mp4`; // é»˜è®¤åç¼€
            
            // ç»‘å®š href å’Œ download å±æ€§
            downloadBtn.href = url;
            downloadBtn.download = filename;
            
            // 5. UI åˆ‡æ¢
            document.getElementById("actionBtn").style.display = "none";
            overlay.style.display = 'none'; // éšè—é®ç½©
            
            const resultArea = document.getElementById("resultArea");
            resultArea.style.display = "block"; // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultArea.scrollIntoView({behavior: "smooth"});
            
            document.getElementById("statusText").innerText = "ğŸ‰ åˆ¶ä½œæˆåŠŸï¼Excellent!";
            
        } catch(e) {
            console.error(e);
            overlay.style.display = 'none';
            alert("è§†é¢‘ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•");
        }
    }

</script>

</body>
</html>
