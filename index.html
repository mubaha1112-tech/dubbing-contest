<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Firstleap Voice Magic â€” Android Chrome å…¼å®¹ç‰ˆ</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:#FAF6EE; margin:0; padding:18px; color:#222; }
    .card { max-width:720px; margin:10px auto; background:#fff; padding:18px; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
    h1 { margin:0 0 12px; color:#E74C5E; font-size:22px; }
    select,button { font-size:16px; padding:10px 14px; border-radius:10px; border:1px solid #eee; }
    button { cursor:pointer; }
    #video-container { margin-top:12px; display:block; }
    video { width:100%; max-height:420px; background:#000; border-radius:12px; }
    #controls { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .hint { margin-top:12px; color:#666; font-size:13px; }
    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9999; color:#fff; font-size:20px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Firstleap Voice Magic â€” Android Chrome ä¼˜åŒ–</h1>

    <label>é€‰æ‹©è§†é¢‘ï¼ˆç¤ºä¾‹ï¼‰</label>
    <select id="videoSelect">
      <option value="">-- è¯·é€‰æ‹© --</option>
      <option value="https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4">ç¤ºä¾‹è§†é¢‘ 1</option>
      <option value="https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4">ç¤ºä¾‹è§†é¢‘ 2</option>
    </select>

    <div id="video-container">
      <video id="mainVideo" controls playsinline webkit-playsinline crossOrigin="anonymous"></video>
    </div>

    <div id="controls">
      <button id="loadBtn">åŠ è½½è§†é¢‘</button>
      <button id="startBtn" disabled>å¼€å§‹é…éŸ³ï¼ˆå½•åˆ¶ï¼‰</button>
      <button id="stopBtn" disabled>åœæ­¢å¹¶åˆæˆ</button>
      <a id="downloadLink" style="display:none;"></a>
    </div>

    <div class="hint" id="status">çŠ¶æ€ï¼šç­‰å¾…åŠ è½½è§†é¢‘ã€‚</div>
    <div class="hint">æç¤ºï¼šæ¨èä½©æˆ´è€³æœºã€‚Android Chrome ä¼šä¼˜å…ˆå½•åˆ¶ webmï¼ˆVP8/VP9 + Opusï¼‰ï¼Œè¿™æ˜¯å¯æ’­æ”¾ä¸”ç¨³å®šçš„æ ¼å¼ã€‚</div>
  </div>

  <div id="overlay" class="overlay">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™â€¦</div>

<script>
/*
  æ ¸å¿ƒç­–ç•¥ï¼š
  1. åŠ è½½ video å¹¶è®¾ç½® crossOrigin="anonymous"ï¼ˆæœåŠ¡å™¨éœ€æ”¯æŒ CORSï¼‰ã€‚
  2. å½•åˆ¶æ—¶ä¼˜å…ˆä½¿ç”¨ video.captureStream() è·å–è§†é¢‘è½¨é“ï¼ˆè¿™é¿å… canvas é»‘å¸§ï¼‰ã€‚
  3. ä½¿ç”¨ AudioContext æ··åˆéº¦å…‹é£ä¸ video çš„éŸ³é¢‘ï¼ˆè‹¥è§†é¢‘éŸ³é¢‘å›  CORS æ— æ³•è®¿é—®ï¼Œåˆ™é€€å›ä»…éº¦å…‹é£ï¼‰ã€‚
  4. å—…æ¢æœ€åˆé€‚çš„ mimeTypeï¼ˆä¼˜å…ˆ webm vp9/vp8ï¼‰ï¼Œå¹¶ç”¨ MediaRecorder è¿›è¡Œå½•åˆ¶ã€‚
  5. ç»“æŸåç”Ÿæˆ Blob å¹¶è§¦å‘ä¸‹è½½ï¼ˆåç¼€ä¸å®é™… mime ä¸€è‡´ï¼Œä¸å¼ºè¡Œæ”¹åä¸º mp4ï¼‰ã€‚
*/

const loadBtn = document.getElementById('loadBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadLink = document.getElementById('downloadLink');
const mainVideo = document.getElementById('mainVideo');
const videoSelect = document.getElementById('videoSelect');
const statusEl = document.getElementById('status');
const overlay = document.getElementById('overlay');

let audioCtx = null;
let micStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let mixedStream = null;
let finalBlob = null;
let finalMime = '';
let finalExt = '';

function logStatus(s) { statusEl.innerText = 'çŠ¶æ€ï¼š' + s; console.log('[Status]', s); }

// è¯·æ±‚éº¦å…‹é£æƒé™å¹¶ç¼“å­˜ Stream
async function ensureMic() {
  if (micStream) return micStream;
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true }});
    return micStream;
  } catch (e) {
    throw new Error('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£æƒé™ã€‚');
  }
}

loadBtn.addEventListener('click', () => {
  const url = videoSelect.value;
  if (!url) { alert('è¯·é€‰æ‹©è§†é¢‘'); return; }
  mainVideo.src = url;
  mainVideo.crossOrigin = 'anonymous';
  mainVideo.load();
  logStatus('æ­£åœ¨åŠ è½½è§†é¢‘â€¦');
  mainVideo.oncanplaythrough = () => {
    logStatus('è§†é¢‘å·²åŠ è½½ï¼Œå¯é¢„è§ˆã€‚å‡†å¤‡å¼€å§‹å½•åˆ¶ã€‚');
    startBtn.disabled = false;
  };
  mainVideo.onerror = (e) => {
    logStatus('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ CORS æˆ–ç½‘ç»œé—®é¢˜ã€‚æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¯¦æƒ…ã€‚'); console.error(e);
  };
});

// é€‰æ‹©åˆé€‚çš„ mimeTypeï¼ˆAndroid Chrome é€šå¸¸æ”¯æŒ webm;codecs=vp8,opusï¼‰
function chooseMime() {
  const candidates = [
    'video/webm;codecs=vp9,opus',
    'video/webm;codecs=vp8,opus',
    'video/webm;codecs=vp9',
    'video/webm;codecs=vp8',
    'video/webm'
  ];
  for (const c of candidates) {
    if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)) {
      return c;
    }
  }
  // fallback
  return '';
}

// åœ¨å¼€å§‹å½•åˆ¶å‰åˆ›å»ºæ··åˆæµï¼švideoï¼ˆä¼˜å…ˆ video.captureStreamï¼‰ + audioï¼ˆmic + video audio if allowedï¼‰
async function prepareMixedStream() {
  // ç¡®ä¿ AudioContext
  if (!audioCtx || audioCtx.state === 'closed') {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch(e) {}
  }

  // Ensure mic
  let mic = null;
  try { mic = await ensureMic(); } catch (err) {
    throw err;
  }

  // 1) è·å–è§†é¢‘è½¨ï¼ˆä¼˜å…ˆ video.captureStreamï¼‰
  let videoStream = null;
  try {
    // ç¡®ä¿ video åœ¨æ’­æ”¾ï¼ˆcaptureStream åœ¨æŸäº›æµè§ˆå™¨éœ€è¦ video æœ‰æ’­æ”¾çŠ¶æ€ï¼‰
    if (mainVideo.paused) {
      // å°æŠ€å·§ï¼šå°è¯•é™éŸ³å¹¶ play -> then pause later
      mainVideo.muted = true;
      await mainVideo.play().catch(e => { /* autoplay may be blocked; continue */ });
      mainVideo.pause();
      mainVideo.muted = false;
    }
    if (typeof mainVideo.captureStream === 'function') {
      videoStream = mainVideo.captureStream(30); // 30fps
      console.log('ä½¿ç”¨ video.captureStream()');
    }
  } catch (e) {
    console.warn('video.captureStream() å¤±è´¥ï¼Œå°è¯•å›é€€åˆ° canvasï¼›é”™è¯¯ï¼š', e);
  }

  // å¦‚æœ video.captureStream ä¸å¯ç”¨ï¼Œä½¿ç”¨ canvas å›é€€ï¼ˆå…¼å®¹æ€§æ¬¡ä¼˜ï¼‰
  if (!videoStream) {
    const canvas = document.createElement('canvas');
    canvas.width = mainVideo.videoWidth || 640;
    canvas.height = mainVideo.videoHeight || 360;
    const ctx = canvas.getContext('2d');
    // å¼€å¯ç»˜åˆ¶å¾ªç¯
    let rafId;
    const draw = () => {
      try { ctx.drawImage(mainVideo, 0, 0, canvas.width, canvas.height); } catch(e) { /* å¯èƒ½å›  CORS å¯¼è‡´å¼‚å¸¸ */ }
      rafId = requestAnimationFrame(draw);
    };
    draw();
    videoStream = canvas.captureStream(30);
    console.log('ä½¿ç”¨ canvas.captureStream() å›é€€æ–¹æ¡ˆ');
    // å½“æœ€ç»ˆåœæ­¢æ—¶è®°å¾— cancelAnimationFrame(rafId)ï¼ˆåœ¨åé¢ stop ä¸­å¤„ç†ï¼‰
    videoStream._rafId = rafId;
  }

  // 2) éŸ³é¢‘æ··åˆï¼šæŠŠéº¦å…‹é£ + è§†é¢‘çš„éŸ³é¢‘ï¼ˆå¦‚æœå¯è¡Œï¼‰åˆè¿›ä¸€ä¸ª MediaStreamDestination
  const dest = audioCtx.createMediaStreamDestination();

  // mic source
  const micSource = audioCtx.createMediaStreamSource(mic);
  const micGain = audioCtx.createGain(); micGain.gain.value = 1.2;
  micSource.connect(micGain); micGain.connect(dest);

  // video audio source: å¯èƒ½å›  CORS è¢«ç¦ç”¨ï¼ˆä¼šæŠ›å¼‚å¸¸ï¼‰ï¼Œæ‰€ä»¥è¦ try-catch
  try {
    // éœ€è¦ video æœ‰ crossOrigin å¹¶ä¸”æœåŠ¡å™¨å…è®¸ CORSï¼Œå¦åˆ™è¿™é‡Œä¼šå¤±è´¥
    const videoSource = audioCtx.createMediaElementSource(mainVideo);
    const videoGain = audioCtx.createGain(); videoGain.gain.value = 0.6;
    videoSource.connect(videoGain); videoGain.connect(dest);
    // ä¹Ÿè¾“å‡ºåˆ°æœ¬åœ°è®¾å¤‡ï¼Œä¾¿äºå®æ—¶ç›‘å¬ï¼ˆè‹¥ä¸æƒ³å¬å¯æ³¨é‡Šï¼‰
    videoGain.connect(audioCtx.destination);
    console.log('æˆåŠŸæ¥å…¥ video çš„åŸå£°åˆ° AudioContextï¼ˆæ³¨æ„ï¼šæœåŠ¡å™¨éœ€å…è®¸ CORSï¼‰');
  } catch (e) {
    console.warn('æ— æ³•æ¥å…¥ video çš„éŸ³é¢‘ï¼ˆå¯èƒ½æ˜¯ CORS æˆ–ä¸æ”¯æŒï¼‰ã€‚ä»…ä½¿ç”¨éº¦å…‹é£å½•éŸ³ã€‚', e);
  }

  // 3) ç»„åˆæœ€ç»ˆæµï¼švideo track(s) + audio tracks from dest
  const final = new MediaStream();
  // video tracks
  videoStream.getVideoTracks().forEach(t => final.addTrack(t));
  // audio tracks (from dest)
  dest.stream.getAudioTracks().forEach(t => final.addTrack(t));

  // keep references for later cleanup
  final._videoStream = videoStream;
  final._audioDest = dest;
  return final;
}

startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;
  downloadLink.style.display = 'none';
  recordedChunks = [];
  overlay.style.display = 'flex';
  logStatus('å‡†å¤‡å½•åˆ¶â€¦ è¯·ä¿è¯éº¦å…‹é£æƒé™å·²å…è®¸');

  try {
    mixedStream = await prepareMixedStream();
  } catch (err) {
    overlay.style.display = 'none';
    alert(err.message || 'æ— æ³•å‡†å¤‡å½•åˆ¶éŸ³é¢‘ã€‚');
    startBtn.disabled = false;
    stopBtn.disabled = true;
    return;
  }

  // é€‰æ‹© mime
  const mime = chooseMime();
  const options = {};
  if (mime) options.mimeType = mime;
  // bitrate å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
  options.videoBitsPerSecond = 2_000_000;

  try {
    mediaRecorder = new MediaRecorder(mixedStream, options);
  } catch (e) {
    console.error('MediaRecorder åˆå§‹åŒ–å¤±è´¥ï¼Œå°è¯•æ—  optionsã€‚', e);
    try { mediaRecorder = new MediaRecorder(mixedStream); }
    catch (err) { overlay.style.display = 'none'; alert('æµè§ˆå™¨ä¸æ”¯æŒ MediaRecorderã€‚'); console.error(err); return; }
  }

  finalMime = mediaRecorder.mimeType || mime || 'video/webm';
  finalExt = finalMime.includes('webm') ? 'webm' : (finalMime.includes('mp4') ? 'mp4' : 'webm');

  mediaRecorder.ondataavailable = (ev) => {
    if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
  };
  mediaRecorder.onstart = () => {
    overlay.style.display = 'none';
    logStatus('å½•åˆ¶å·²å¼€å§‹ï¼Œæ­£åœ¨å½•åˆ¶ä¸­â€¦');
    // ä¿è¯è§†é¢‘ä»å¤´å¼€å§‹æ’­æ”¾
    try { mainVideo.currentTime = 0; mainVideo.play().catch(()=>{}); } catch(e){}
  };
  mediaRecorder.onerror = (e) => { console.error('recorder error', e); };
  mediaRecorder.start(200); // 200ms åˆ‡ç‰‡
});

stopBtn.addEventListener('click', () => {
  stopBtn.disabled = true;
  logStatus('åœæ­¢å½•åˆ¶å¹¶åˆæˆæ–‡ä»¶â€¦');
  overlay.style.display = 'flex';

  try {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  } catch (e) { console.warn(e); }

  // åœæ­¢å¹¶æ¸…ç†æµï¼ˆç­‰å¾… recorder.onstop è§¦å‘åå¤„ç† blobï¼‰
  // onstop é‡Œè¿›è¡Œç”Ÿæˆæ–‡ä»¶ä¸ä¸‹è½½ç»‘å®š
  mediaRecorder.onstop = () => {
    console.log('recorder stopped, chunks:', recordedChunks.length);
    // ç”Ÿæˆ blob
    finalBlob = new Blob(recordedChunks, { type: finalMime || 'video/webm' });
    // æ£€æŸ¥å¤§å°
    if (!finalBlob || finalBlob.size < 2000) {
      overlay.style.display = 'none';
      logStatus('åˆæˆå¤±è´¥ï¼ˆæ–‡ä»¶è¿‡å°ï¼‰ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æˆ–é‡è¯•ã€‚');
      alert('å½•åˆ¶å¤±è´¥ï¼Œç”Ÿæˆæ–‡ä»¶è¿‡å°ï¼ˆå¯èƒ½æ˜¯ CORSã€æƒé™æˆ–å½•åˆ¶é€»è¾‘é—®é¢˜ï¼‰ã€‚');
      startBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }

    const fileUrl = URL.createObjectURL(finalBlob);
    const now = Date.now();
    const filename = `Firstleap_Dub_${now}.${finalExt}`;

    downloadLink.href = fileUrl;
    downloadLink.download = filename;
    downloadLink.style.display = 'inline-block';
    downloadLink.innerText = 'ğŸ’¾ ç‚¹å‡»ä¸‹è½½è§†é¢‘';
    downloadLink.onclick = () => {
      // é‡Šæ”¾ URL å»¶è¿Ÿ
      setTimeout(() => { URL.revokeObjectURL(fileUrl); }, 10000);
    };

    // ä¹ŸæŠŠåˆæˆç»“æœæ”¾åˆ° preview videoï¼ˆè¦†ç›– mainVideoï¼‰ï¼Œè®©ç”¨æˆ·ç¡®è®¤
    try {
      const preview = document.createElement('video');
      preview.controls = true;
      preview.playsInline = true;
      preview.src = fileUrl;
      preview.style.width = '100%';
      const container = document.getElementById('video-container');
      // ç§»é™¤æ—§çš„ previewï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¹¶æ’å…¥æ–° preview
      const old = document.getElementById('recordPreview');
      if (old) old.remove();
      preview.id = 'recordPreview';
      container.appendChild(preview);
      preview.play().catch(()=>{});
    } catch (e) { console.warn('é¢„è§ˆæ’å…¥å¤±è´¥', e); }

    overlay.style.display = 'none';
    logStatus(`åˆæˆå®Œæˆï¼š${Math.round(finalBlob.size/1024)} KBï¼ˆæ ¼å¼ï¼š${finalMime}ï¼‰`);
    startBtn.disabled = false;
    stopBtn.disabled = true;

    // cleanup captured streams/tracks
    try {
      if (mixedStream) {
        mixedStream.getTracks().forEach(t => t.stop());
        // if we used videoStream with _rafId, cancel it
        if (mixedStream._videoStream && mixedStream._videoStream._rafId) {
          cancelAnimationFrame(mixedStream._videoStream._rafId);
        }
      }
    } catch (e) { console.warn(e); }
  };
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', () => {
  try {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    if (micStream) micStream.getTracks().forEach(t=>t.stop());
    if (mixedStream) mixedStream.getTracks().forEach(t=>t.stop());
  } catch(e){}
});
</script>
</body>
</html>
