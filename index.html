<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic (Pro Edition)</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* æ¬¢è¿å±ä¸åŠ¨ç”» */
    .welcome-screen {
      position: fixed; inset: 0; z-index: 100000;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
      opacity: 1; transition: opacity .6s ease, visibility .6s ease; visibility: visible;
    }
    .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .welcome-bgvideo {
      position: absolute; inset: 0; width: 100%; height: 100%;
      object-fit: cover; filter: saturate(1.1) contrast(1.05) brightness(0.9);
    }
    .welcome-overlay { position: relative; z-index: 2; text-align: center; color: #fff; padding: 20px; }
    .welcome-title { font-weight: 900; font-size: 34px; text-shadow: 3px 3px 0 rgba(0,0,0,0.18); animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2); }
    .welcome-subtitle { margin-top: 8px; font-size: 16px; animation: fadeIn .8s ease .2s both; }
    .welcome-cta {
      margin-top: 18px; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px;
      border-radius: 999px; background: rgba(255,255,255,0.18); color: #fff; font-weight: 800;
      border: 1px solid rgba(255,255,255,0.35); backdrop-filter: blur(6px); cursor: pointer;
      animation: fadeIn .8s ease .35s both;
    }
    .welcome-skip {
      position: absolute; right: 12px; top: 12px; z-index: 3; padding: 8px 12px;
      border-radius: 999px; border: 1px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.25);
      color: #fff; font-size: 12px; font-weight: 700; backdrop-filter: blur(3px); cursor: pointer;
    }
    @keyframes titlePop { 0% { transform: translateY(6px) scale(.92); opacity: 0; } 60% { transform: translateY(-2px) scale(1.02); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }

    /* æ ‡é¢˜ */
    h1 {
      color: var(--rabbit-red); font-size: 26px; margin: 10px 0 25px;
      text-shadow: 2px 2px 0px #ffe3e3; font-weight: 900; letter-spacing: 1px;
      position: relative; display: inline-block;
    }
    h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
    h1::before { content: "ğŸµ"; position: absolute; left: -25px; top: 10px; font-size: 20px; animation: bounce 2s infinite reverse; }

    /* æ§ä»¶ */
    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }
    select {
      width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px;
      font-size: 16px; background: #fafafa; outline: none; font-weight: bold; color: #555;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat; background-position: right 15px center; background-size: 18px; -webkit-appearance: none;
    }
    .btn {
      display: block; width: 100%; padding: 16px; border: none; border-radius: 25px;
      font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px;
      box-shadow: var(--shadow-3d); position: relative; overflow: hidden; transition: all 0.2s;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); animation: pulse 1.5s infinite; position: relative; z-index: 1002; }
    .btn-share { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); flex: 1; display: flex; align-items: center; justify-content: center; }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* è§†é¢‘åŒºåŸŸ */
    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; border-radius: 20px; overflow: hidden; }
    video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; outline: none; object-fit: contain; }
    
    /* === çŠ¶æ€æç¤ºæ¡†æ ·å¼ (Requirement 2) === */
    .status-badge {
      position: absolute; top: 15px; left: 15px; z-index: 20;
      background: rgba(0, 0, 0, 0.65); color: #fff;
      padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: bold;
      backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
      display: none; pointer-events: none; letter-spacing: 0.5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .status-badge span.dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

    /* å½•åˆ¶æ¨¡å¼å…¨å±æ ·å¼ */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container {
      max-width: 100%; height: 100vh; border-radius: 0; border: none;
      padding: calc(env(safe-area-inset-top, 0px) + 20px) 0 calc(env(safe-area-inset-bottom, 0px) + 80px);
      display: flex; flex-direction: column; align-items: center; background: #000;
    }
    body.recording-mode .step-label, body.recording-mode select, body.recording-mode #searchBtn,
    body.recording-mode #playBtn, body.recording-mode .tip, body.recording-mode .status-text,
    body.recording-mode h1 { display: none !important; }
    
    body.recording-mode #video-container {
      margin: 0; width: 100%; flex: 1; display: flex; align-items: center; justify-content: center; background: #000;
      border-radius: 0;
    }
    /* åœ¨å…¨å±æ¨¡å¼ä¸‹ï¼ŒçŠ¶æ€æ¡çš„ä½ç½®å¾®è°ƒ */
    body.recording-mode .status-badge { top: 30px; left: 20px; font-size: 16px; padding: 10px 20px; }

    #processCanvas { display: none; }
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }

    .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
    .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; }
    
    /* è¦†ç›–å±‚ */
    .record-overlay { position: absolute; top: 15px; right: 15px; display: none; gap: 6px; z-index: 999; }
    .record-overlay .btn { padding: 6px 12px; border-radius: 8px; font-size: 13px; margin: 0; width: auto; box-shadow: none; }
    
    .loader-overlay {
      position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 10;
      display: none; align-items: center; justify-content: center; flex-direction: column;
      border-radius: 20px;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--rabbit-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .overlay-fullscreen {
      position: fixed; inset: 0; background: rgba(255, 142, 142, 0.95); z-index: 9999;
      display: none; align-items: center; justify-content: center; flex-direction: column;
      backdrop-filter: blur(5px);
    }
    .countdown-number { font-size: 120px; color: #fff; font-weight: 900; animation: popIn 0.8s; }
    .overlay-text { font-size: 20px; color: #fff; margin-top: 20px; font-weight: bold; }
    .progress-container { width: 70%; height: 10px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; }
    .progress-bar { width: 0%; height: 100%; background: #fff; transition: width 0.2s; }
    
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body class="welcome-active">

  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen">
    <button class="welcome-skip" id="welcomeSkipBtn">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop>
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic</div>
      <div class="welcome-subtitle">é…éŸ³ç§€ (Share Edition)</div>
      <div><button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button></div>
    </div>
  </div>

  <!-- å€’è®¡æ—¶é®ç½© -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
  </div>

  <!-- å¤„ç†ä¸­é®ç½© -->
  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 50px;">âš™ï¸</div>
    <div class="overlay-text">
        è§†é¢‘ç”Ÿæˆä¸­...<br><span style="font-size:14px; opacity:0.8; font-weight:normal;">Making Magic Happen...</span>
    </div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  </div>

  <div class="container">
    <h1>Firstleap Voice Magic</h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()"><option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option></select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled><option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option></select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <!-- è§†é¢‘æ’­æ”¾ä¸å½•åˆ¶å®¹å™¨ -->
    <div id="video-container">
      <!-- çŠ¶æ€æç¤ºæ¡† (Requirement 2) -->
      <div id="recordStatusBadge" class="status-badge">
        <span class="dot" style="background:#F9CA24;"></span><span id="statusBadgeText">å‡†å¤‡å°±ç»ª</span>
      </div>

      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">è§†é¢‘åŠ è½½ä¸­...</div>
      </div>

      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous">
        <source src="" type="video/mp4">
      </video>

      <div id="recordOverlay" class="record-overlay">
        <button id="pauseToggleBtn" class="btn" style="background:#6c7dff; color:#fff;" onclick="togglePauseDuringRecording()">æš‚åœ</button>
      </div>

      <canvas id="processCanvas"></canvas>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶åŒº -->
    <div class="tip">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·åŠ¡å¿…ä½©æˆ´è€³æœºï¼</div>
    <div class="status-text" id="statusText"></div>

    <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
    <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>

    <!-- ç»“æœé¢„è§ˆåŒº -->
    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <video id="previewVideo" style="width:100%; border-radius:15px; background:#000;" controls playsinline></video>
      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <button id="shareBtn" class="btn btn-share" onclick="handleShareOrDownload()">ğŸ“¤ åˆ†äº«/ä¿å­˜è§†é¢‘</button>
        <a id="downloadLinkFallback" style="display:none;"></a>
      </div>
    </div>
  </div>

  <script>
    /* ================= æ•°æ®åº“ ================= */
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4", "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4"],
      "K2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4", "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4"],
      "K3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4", "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4"],
      "G1A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4", "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4"]
    };

    /* ================= å…¨å±€å˜é‡ ================= */
    let mediaRecorder, recordedChunks = [];
    let audioCtx, micStream, canvasStream, videoStream;
    let micGainNode, videoGainNode, dest;
    let isRecording = false, isIntroMode = false;
    let animationFrameId;
    let introImageObj = null;
    let processingInterval;
    let finalBlob = null, finalObjectURL = '';

    /* ================= åˆå§‹åŒ– ================= */
    (function init() {
      // æ¬¢è¿é¡µé€»è¾‘
      const welcome = document.getElementById('welcome');
      const closeWelcome = () => { welcome.classList.add('hidden'); document.body.classList.remove('welcome-active'); setTimeout(()=>welcome.style.display='none', 600); };
      document.getElementById('welcomeEnterBtn').addEventListener('click', async () => { await initAudio(); closeWelcome(); });
      document.getElementById('welcomeSkipBtn').addEventListener('click', closeWelcome);

      // é¢„åŠ è½½ intro å›¾ç‰‡ (Requirement 1)
      introImageObj = new Image();
      introImageObj.crossOrigin = "anonymous";
      introImageObj.src = "intro.png"; // å¿…é¡»ç¡®ä¿åŒçº§ç›®å½•ä¸‹æœ‰æ­¤å›¾ç‰‡

      // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
      const levelSelect = document.getElementById("levelSelect");
      Object.keys(videoDatabase).forEach(lvl => {
        let opt = document.createElement("option");
        opt.value = lvl; opt.text = lvl;
        levelSelect.appendChild(opt);
      });
    })();

    async function initAudio() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!audioCtx) audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
        return true;
      } catch (e) { alert("æ— æ³•è·å–éº¦å…‹é£æƒé™"); return false; }
    }

    function updateUnits() {
      const lvl = document.getElementById("levelSelect").value;
      const uSel = document.getElementById("unitSelect");
      uSel.innerHTML = '<option value="">-- é€‰æ‹©å•å…ƒ --</option>';
      uSel.disabled = true;
      if (lvl && videoDatabase[lvl]) {
        videoDatabase[lvl].forEach((url, i) => {
          if(url) { let opt = document.createElement("option"); opt.value = i; opt.text = "Unit " + (i+1); uSel.appendChild(opt); }
        });
        uSel.disabled = false;
      }
    }

    /* ================= è§†é¢‘æ§åˆ¶ ================= */
    function findVideo() {
      const lvl = document.getElementById("levelSelect").value;
      const idx = document.getElementById("unitSelect").value;
      if (!lvl || idx === "") { alert("è¯·é€‰æ‹©å®Œæ•´ä¿¡æ¯"); return; }
      
      const url = videoDatabase[lvl][idx];
      const v = document.getElementById("mainVideo");
      resetUI();
      
      document.getElementById("video-container").style.display = "block";
      document.getElementById("loaderOverlay").style.display = "flex";
      updateStatusBadge(true, "è§†é¢‘åŠ è½½ä¸­...", "#F9CA24");

      v.src = url;
      v.load();
      v.oncanplaythrough = () => {
        document.getElementById("loaderOverlay").style.display = "none";
        document.getElementById("actionBtn").style.display = "block";
        document.getElementById("playBtn").style.display = "block";
        document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•";
        updateStatusBadge(false);
        // åˆå§‹åŒ– Canvas å°ºå¯¸
        const c = document.getElementById("processCanvas");
        c.width = v.videoWidth || 640;
        c.height = v.videoHeight || 360;
      };
      v.onerror = () => alert("è§†é¢‘åŠ è½½å¤±è´¥");
    }

    function togglePreview() {
      const v = document.getElementById("mainVideo");
      const btn = document.getElementById("playBtn");
      if(v.paused) { v.play(); btn.innerText = "â¸ï¸ æš‚åœæ’­æ”¾"; } else { v.pause(); btn.innerText = "â–¶ï¸ é¢„è§ˆåŸç‰‡"; }
    }

    /* ================= æ ¸å¿ƒå½•åˆ¶é€»è¾‘ ================= */
    async function toggleRecording() {
      if (isRecording) stopRecording();
      else startRecordingSequence();
    }

    async function startRecordingSequence() {
      if (!micStream && !(await initAudio())) return;
      
      // 1. å€’è®¡æ—¶
      document.getElementById('countdown-overlay').style.display = 'flex';
      let count = 3;
      const timer = setInterval(() => {
        document.getElementById('countdownText').innerText = count;
        if (count-- <= 0) {
          clearInterval(timer);
          document.getElementById('countdown-overlay').style.display = 'none';
          enterFullscreen();
          executeActualRecording(); // å¼€å§‹å½•åˆ¶
        }
      }, 1000);
    }

    async function executeActualRecording() {
      const video = document.getElementById("mainVideo");
      const canvas = document.getElementById("processCanvas");
      const ctx = canvas.getContext("2d");

      // å‡†å¤‡éŸ³é¢‘èŠ‚ç‚¹
      if(audioCtx.state === 'suspended') await audioCtx.resume();
      dest = audioCtx.createMediaStreamDestination();
      micGainNode = audioCtx.createGain(); micGainNode.gain.value = 0; // åˆå§‹é™éŸ³
      videoGainNode = audioCtx.createGain(); videoGainNode.gain.value = 0;
      
      const sourceMic = audioCtx.createMediaStreamSource(micStream);
      sourceMic.connect(micGainNode).connect(dest);
      
      try {
        if (!video._source) video._source = audioCtx.createMediaElementSource(video);
        video._source.connect(videoGainNode).connect(dest);
      } catch(e) {} // é˜²æ­¢é‡å¤è¿æ¥é”™è¯¯
      dest.connect(audioCtx.destination); // ç›‘å¬

      // å‡†å¤‡å½•åˆ¶æµ (Canvas + Audio)
      canvasStream = canvas.captureStream(30);
      const combinedStream = new MediaStream([
        canvasStream.getVideoTracks()[0],
        dest.stream.getAudioTracks()[0]
      ]);

      // å…¼å®¹æ€§ MIME Type
      const mime = MediaRecorder.isTypeSupported("video/mp4;codecs=avc1") ? "video/mp4;codecs=avc1" : "video/webm";
      mediaRecorder = new MediaRecorder(combinedStream, { mimeType: mime, videoBitsPerSecond: 2500000 });
      recordedChunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = processVideo;

      // å¯åŠ¨å½•åˆ¶
      mediaRecorder.start();
      isRecording = true;
      
      // === é˜¶æ®µ 1: å½•åˆ¶ç‰‡å¤´ (Requirement 1 & 2) ===
      isIntroMode = true;
      updateStatusBadge(true, "âœ¨ ç‰‡å¤´å½•åˆ¶ä¸­...", "#F9CA24"); // æç¤ºçŠ¶æ€
      drawLoop(video, ctx, canvas);
      
      // 3ç§’ååˆ‡æ¢åˆ°æ­£ç‰‡
      setTimeout(() => {
        if(!isRecording) return;
        isIntroMode = false;
        
        // å¼€å¯éŸ³é¢‘ï¼Œæ’­æ”¾è§†é¢‘
        micGainNode.gain.value = 1.0; 
        videoGainNode.gain.value = 1.0;
        video.currentTime = 0;
        video.controls = false;
        video.play();
        
        // æ›´æ–°çŠ¶æ€ (Requirement 2)
        updateStatusBadge(true, "ğŸ™ï¸ æ­£åœ¨é…éŸ³ä¸­...", "#EE5253");
        document.getElementById("actionBtn").innerText = "â¹ï¸ å®Œæˆé…éŸ³";
        document.getElementById("actionBtn").className = "btn btn-stop";
        document.getElementById("recordOverlay").style.display = "flex"; // æ˜¾ç¤ºæš‚åœæŒ‰é’®
        
        video.onended = stopRecording;
      }, 3000);
    }

    function drawLoop(video, ctx, canvas) {
      if (!isRecording) { cancelAnimationFrame(animationFrameId); return; }
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (isIntroMode) {
        // === ç»˜åˆ¶ç‰‡å¤´ ===
        if (introImageObj && introImageObj.complete && introImageObj.naturalWidth !== 0) {
          ctx.drawImage(introImageObj, 0, 0, canvas.width, canvas.height);
        } else {
          // å…œåº•ï¼šå¦‚æœæ²¡æœ‰ intro.pngï¼Œç»˜åˆ¶ä¸€ä¸ªå½©è‰²èƒŒæ™¯
          ctx.fillStyle = "#FF8E8E";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#FFF";
          ctx.font = "bold 60px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("Firstleap Magic", canvas.width/2, canvas.height/2);
        }
      } else {
        // === ç»˜åˆ¶è§†é¢‘ ===
        if (!video.paused && !video.ended) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
      }
      animationFrameId = requestAnimationFrame(() => drawLoop(video, ctx, canvas));
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false; isIntroMode = false;
      const v = document.getElementById("mainVideo");
      v.pause();
      mediaRecorder.stop(); // è§¦å‘ onstop -> processVideo
      exitFullscreen();
      
      updateStatusBadge(false);
      document.getElementById("recordOverlay").style.display = "none";
      document.getElementById("actionBtn").disabled = true;
    }

    function processVideo() {
      const overlay = document.getElementById('processing-overlay');
      const bar = document.getElementById('progressBar');
      overlay.style.display = 'flex';
      
      let progress = 0;
      clearInterval(processingInterval);
      processingInterval = setInterval(() => {
        progress += 5; bar.style.width = progress + '%';
        if (progress >= 100) {
          clearInterval(processingInterval);
          setTimeout(() => {
            overlay.style.display = 'none';
            showResult();
          }, 500);
        }
      }, 50);
    }

    function showResult() {
      const blob = new Blob(recordedChunks, { type: "video/mp4" });
      finalBlob = blob;
      finalObjectURL = URL.createObjectURL(blob);
      
      const prev = document.getElementById("previewVideo");
      prev.src = finalObjectURL;
      
      document.getElementById("resultArea").style.display = "block";
      document.getElementById("video-container").style.display = "none";
      document.getElementById("actionBtn").style.display = "none";
      document.getElementById("playBtn").style.display = "none";
      document.getElementById("statusText").innerText = "";
      
      document.getElementById("resultArea").scrollIntoView({behavior:"smooth"});
    }

    /* ================= è¾…åŠ©åŠŸèƒ½ ================= */
    function resetUI() {
      document.getElementById("resultArea").style.display = "none";
      const btn = document.getElementById("actionBtn");
      btn.style.display = "none"; btn.className = "btn btn-record"; btn.innerText = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³"; btn.disabled = false;
      document.getElementById("statusText").innerText = "";
    }
    
    function resetRecording() {
      resetUI();
      document.getElementById("video-container").style.display = "block";
      document.getElementById("actionBtn").style.display = "block";
      document.getElementById("playBtn").style.display = "block";
      document.getElementById("mainVideo").controls = true;
    }

    // æ§åˆ¶å·¦ä¸Šè§’çŠ¶æ€æç¤ºæ¡† (Requirement 2)
    function updateStatusBadge(show, text, dotColor) {
      const badge = document.getElementById("recordStatusBadge");
      const txt = document.getElementById("statusBadgeText");
      const dot = badge.querySelector(".dot");
      
      if (show) {
        badge.style.display = "block";
        txt.innerText = text;
        if (dotColor) dot.style.background = dotColor;
      } else {
        badge.style.display = "none";
      }
    }

    function handleShareOrDownload() {
      if (!finalBlob) return;
      const file = new File([finalBlob], `VoiceShow_${Date.now()}.mp4`, { type: "video/mp4" });
      if (navigator.share && navigator.canShare && navigator.canShare({files:[file]})) {
        navigator.share({ files: [file], title: 'æˆ‘çš„é…éŸ³ä½œå“' }).catch(console.error);
      } else {
        const a = document.getElementById("downloadLinkFallback");
        a.href = finalObjectURL;
        a.download = file.name;
        a.click();
      }
    }

    function togglePauseDuringRecording() {
      const v = document.getElementById("mainVideo");
      const btn = document.getElementById("pauseToggleBtn");
      if (v.paused) { v.play(); btn.innerText = "æš‚åœ"; } 
      else { v.pause(); btn.innerText = "ç»§ç»­"; }
    }

    function enterFullscreen() {
      document.body.classList.add('recording-mode');
      const el = document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
    }
    function exitFullscreen() {
      document.body.classList.remove('recording-mode');
      if(document.exitFullscreen) document.exitFullscreen().catch(()=>{});
    }
  </script>
</body>
</html>
