<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice MagicV3</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* å…¨å±æ¬¢è¿åŠ¨ç”» */
    .welcome-screen {
      position: fixed;
      inset: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
      overflow: hidden;
      opacity: 1;
      transition: opacity .6s ease, visibility .6s ease;
      visibility: visible;
    }
    .welcome-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .welcome-bgvideo {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.1) contrast(1.05) brightness(0.9);
    }
    .welcome-overlay {
      position: relative;
      z-index: 2;
      text-align: center;
      color: #fff;
      padding: 20px;
    }
    .welcome-title {
      font-weight: 900;
      font-size: 34px;
      letter-spacing: 1px;
      text-shadow: 3px 3px 0 rgba(0,0,0,0.18);
      animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2);
    }
    .welcome-subtitle {
      margin-top: 8px;
      font-size: 16px;
      opacity: .95;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.12);
      animation: fadeIn .8s ease .2s both;
    }
    .welcome-cta {
      margin-top: 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      color: #fff;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,0.35);
      backdrop-filter: blur(6px);
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, background .2s ease;
      animation: fadeIn .8s ease .35s both;
    }
    .welcome-cta:active { transform: translateY(1px) scale(0.99); }
    .welcome-skip {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 3;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.5);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      backdrop-filter: blur(3px);
    }
    .confetti {
      position: absolute;
      bottom: -20px;
      width: 8px; height: 14px;
      border-radius: 3px;
      opacity: .9;
      animation-name: riseSpin;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes titlePop {
      0% { transform: translateY(6px) scale(.92); opacity: 0; }
      60% { transform: translateY(-2px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px) }
      to { opacity: 1; transform: translateY(0) }
    }
    @keyframes riseSpin {
      0% { transform: translateY(0) rotate(0deg); opacity: .0; }
      10% { opacity: .9; }
      100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
    }

    /* æ ‡é¢˜ */
    h1 {
      color: var(--rabbit-red);
      font-size: 26px;
      margin: 10px 0 25px;
      text-shadow: 2px 2px 0px #ffe3e3;
      font-weight: 900;
      letter-spacing: 1px;
      position: relative;
      display: inline-block;
    }
    h1::after {
      content: "âœ¨";
      position: absolute;
      right: -25px;
      top: 0;
      font-size: 20px;
      animation: bounce 2s infinite;
    }
    h1::before {
      content: "ğŸµ";
      position: absolute;
      left: -25px;
      top: 10px;
      font-size: 20px;
      animation: bounce 2s infinite reverse;
    }

    /* æ§ä»¶æ ·å¼ */
    .step-label {
      text-align: left;
      margin: 15px 0 5px 5px;
      font-weight: bold;
      color: #888;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    .step-badge {
      background: var(--pear-yellow);
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 12px;
    }
    select {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      border: 2px solid #eee;
      border-radius: 18px;
      font-size: 16px;
      background: #fafafa;
      outline: none;
      transition: 0.3s;
      color: #555;
      font-weight: bold;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 18px;
    }
    select:focus { border-color: var(--pear-yellow); background-color: #fff; }

    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 25px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      color: white;
      margin-top: 15px;
      transition: all 0.2s;
      box-shadow: var(--shadow-3d);
      position: relative;
      overflow: hidden;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled {
      background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none;
    }
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play {
      background: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
      display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
    }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      animation: pulse 1.5s infinite; position: relative; z-index: 1002;
    }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }
    .btn-download {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      text-decoration: none; line-height: 1.5; flex: 1; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
      font-size: 18px; padding: 16px; border: none;
    }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* è§†é¢‘åŒºåŸŸ */
    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video {
      width: 100%;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      background: #000;
      outline: none;
      border: 4px solid #fff;
      object-fit: contain;
    }
    video:fullscreen { border: none; border-radius: 0; width: 100%; height: 100%; }
    
    /* å…³é”®ä¿®å¤ï¼šåœ¨å½•åˆ¶æ¨¡å¼ä¸‹ï¼Œå¼ºåˆ¶éšè—videoçš„æ‰€æœ‰åŸç”Ÿæ§ä»¶ */
    body.recording-mode video::-webkit-media-controls {
        display: none !important;
    }
    body.recording-mode video::-webkit-media-controls-enclosure {
        display: none !important;
    }

    #processCanvas { display: none; }
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }

    .preview-box {
      margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px;
      display: none; background: #fffcf0;
    }
    .tip {
      font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px;
      border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    .headphone-tip {
      margin: 8px 0 0 0;
      background: #fff3e0;
      color: #8b6a00;
      padding: 10px 12px;
      border-radius: 10px;
      text-align: left;
      font-size: 13px;
    }

    /* å½•åˆ¶æ—¶å…¨å±ï¼ˆä¿®å¤ç«–å±åç§»ï¼‰ */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container {
      max-width: 100%;
      height: 100vh; /* fallback */
      border-radius: 0; border: none;
      padding: calc(env(safe-area-inset-top, 0px) + 8px) 10px calc(env(safe-area-inset-bottom, 0px) + 80px);
      display: flex; flex-direction: column; align-items: center; background: #000;
    }
    @supports (height: 100svh) {
      body.recording-mode .container { height: 100svh; }
    }
    @supports (height: 100dvh) {
      body.recording-mode .container { height: 100dvh; }
    }
    body.recording-mode .step-label,
    body.recording-mode select,
    body.recording-mode #searchBtn,
    body.recording-mode #playBtn,
    body.recording-mode .tip,
    body.recording-mode .status-text,
    body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container {
      margin: 0;
      width: 100%;
      display: flex;
      flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ï¼Œè§†é¢‘å‚ç›´å±…ä¸­ */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    body.recording-mode #mainVideo {
      width: 100%;
      height: auto;
      max-height: 100%;
      border: none; box-shadow: none;
    }
    /* å–æ¶ˆå…¨å±åä¸‹æ–¹çš„å®Œæˆé…éŸ³æŒ‰é’®ï¼ˆéšè—åº•éƒ¨æŒ‰é’®ï¼‰ */
    body.recording-mode #actionBtn { display: none; }

    /* å åŠ è¦†ç›–å±‚ */
    .record-overlay {
      position: absolute;
      top: 8px; right: 8px;
      display: none;
      gap: 6px;
      z-index: 999;
      pointer-events: auto;
    }
    .record-overlay .btn {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      border: none;
    }
    .record-overlay .pause { background: #6c7dff; color: white; }

    /* åŠ è½½å±‚ */
    .loader-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px);
    }
    .spinner {
      border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red);
      border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* å€’è®¡æ—¶ & è¿›åº¦æ¡é®ç½© */
    .overlay-fullscreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 142, 142, 0.95);
      z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column;
      backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box;
    }
    .countdown-number {
      font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
      font-family: "Arial Rounded MT Bold", "Comic Sans MS", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
    .progress-container {
      width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px;
    }
    .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    /* ç¦æ­¢æ»šåŠ¨æ—¶éšè—é¡µé¢æ ‡é¢˜ç­‰ */
    body.welcome-active { overflow: hidden; }

    /* ç®€æ˜“é™å™ªï¼šè‹¥ç”¨æˆ·åå¥½å‡å°‘åŠ¨ç”»ï¼Œç¦ç”¨å¤§å¤šæ•°åŠ¨ç”» */
    @media (prefers-reduced-motion: reduce) {
      .welcome-screen, .welcome-title, .welcome-subtitle, .confetti, .welcome-cta { animation: none !important; }
    }
    
    /* éº¦å…‹é£æˆæƒå¤±è´¥çš„æç¤ºæ¡† */
    #micErrorOverlay {
      background: rgba(255, 82, 83, 0.95);
      font-family: sans-serif;
      padding: 30px;
      border-radius: 20px;
      max-width: 80%;
    }
    #micErrorOverlay .error-icon {
      font-size: 60px;
      margin-bottom: 10px;
    }
    #micErrorOverlay .error-text {
      font-size: 18px;
      margin-top: 10px;
      color: white;
      opacity: 0.8;
      font-weight: normal;
    }

    /* å½©è›‹ä¸“ç”¨åŠ¨ç”»æ ·å¼ */
    .monster-gift {
      font-size: 60px;
      animation: jumpHappy 1s infinite alternate;
    }

    @keyframes jumpHappy {
      0% { transform: translateY(0) rotate(-10deg); }
      100% { transform: translateY(-20px) rotate(10deg); }
    }

    /* Chromeä¸“ç”¨ä¼˜åŒ– */
    .chrome-optimized {
      position: relative;
    }
    
    /* è§†é¢‘åŠ è½½éªŒè¯çŠ¶æ€ */
    .video-validating {
      background: rgba(50, 50, 50, 0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 14px;
      display: none;
    }
    
    /* è§†é¢‘è´¨é‡æŒ‡ç¤ºå™¨ */
    .quality-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 5px;
      background: #4CAF50;
    }
    .quality-indicator.poor {
      background: #FF9800;
    }
    .quality-indicator.bad {
      background: #F44336;
    }

  </style>
</head>
<body class="welcome-active">
  <div id="welcome" class="welcome-screen" role="dialog" aria-modal="true" aria-label="æ¬¢è¿é¡µ">
    <button class="welcome-skip" id="welcomeSkipBtn" aria-label="è·³è¿‡">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop preload="auto" aria-hidden="true">
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic</div>
      <div class="welcome-subtitle">é…éŸ³ç§€</div>
      <div>
        <button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button>
      </div>
    </div>
  </div>

  <div id="micAuthErrorOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.85); z-index: 99999;">
    <div id="micErrorOverlay">
      <div class="error-icon">ğŸš«</div>
      <div class="overlay-text">éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼</div>
      <div class="error-text">
        å½•éŸ³åŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼Œè¯·è¿›å…¥æµè§ˆå™¨è®¾ç½®ï¼Œ<br>
        **å…è®¸æœ¬ç½‘ç«™è®¿é—®æ‚¨çš„éº¦å…‹é£**åé‡è¯•ã€‚
      </div>
      <button class="btn btn-retry" onclick="closeMicErrorHint()" style="width:160px; margin-top:20px; background:#fff; color:#FF5253; box-shadow:none;">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
  </div>

  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">è§†é¢‘åˆæˆä¸­...<br><span style="font-size:16px; opacity:0.8;">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
  </div>

  <!-- Chromeä¸“ç”¨ï¼šè§†é¢‘éªŒè¯æç¤º -->
  <div id="chromeValidationOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.92); z-index: 100001;">
    <div style="color:#fff; font-size:22px; font-weight:900; margin-bottom:10px;">è§†é¢‘éªŒè¯ä¸­...</div>
    <div style="color:#fff; font-size:14px; opacity:0.9; max-width:520px; text-align: center;">
      æ­£åœ¨éªŒè¯è§†é¢‘å®Œæ•´æ€§ï¼Œç¡®ä¿ä¸‹è½½çš„è§†é¢‘å¯ä»¥æ­£å¸¸æ’­æ”¾<br>
      <span id="validationStatus" style="color:#4CAF50; font-weight:bold;">éªŒè¯ä¸­ï¼Œè¯·ç¨å€™...</span>
    </div>
    <div class="spinner" style="margin: 20px auto; border: 5px solid #f3f3f3; border-top: 5px solid #4CAF50; width: 40px; height: 40px;"></div>
    <div id="videoValidationInfo" style="color:#aaa; font-size:12px; margin-top:10px; display:none;">
      è§†é¢‘æ—¶é•¿: <span id="videoDuration">0</span>ç§’ | æ–‡ä»¶å¤§å°: <span id="videoSize">0</span>MB
    </div>
  </div>

  <!-- å½©è›‹å¼¹çª—ç»“æ„ -->
  <div id="eggOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.9); z-index: 100002;">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
    <div class="overlay-text" style="color: #FFD700; font-size: 28px; text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);">
      æ­å–œä½ å‘ç°å½©è›‹ï¼
    </div>
    <div style="color: #fff; font-size: 18px; margin: 15px 0; opacity: 0.9;">
      æˆåŠŸå‚åŠ æ´»åŠ¨åï¼Œå¯å¦å¤–è·å¾—ä¼ è¯´ä¸­çš„å¥–åŠ±ï¼š
    </div>
    
    <!-- 3ä¸ªè·³åŠ¨çš„é­”æ€ª -->
    <div style="display: flex; gap: 20px; margin: 20px 0;">
      <div class="monster-gift">ğŸ‘¾</div>
      <div class="monster-gift" style="animation-delay: 0.1s">ğŸ‘¾</div>
      <div class="monster-gift" style="animation-delay: 0.2s">ğŸ‘¾</div>
    </div>
    <div style="color: var(--monster-green); font-weight: bold; font-size: 24px; margin-bottom: 30px;">
      3ä¸ªé­”æ€ª (3 Monsters)
    </div>
      <div style="margin-top: 10px; font-size: 20px; color: #fff;">
        ( <span style="color: #FF4D4F;">â€¼ï¸</span> æˆªå›¾å‘ç»™è€å¸ˆå“¦ <span style="color: #FF4D4F;">â€¼ï¸</span> )
    </div>

    <button class="btn btn-primary" onclick="closeEggOverlay()" style="width: 200px; background: linear-gradient(135deg, #FF8E8E, #EE5253); box-shadow: none;">
      å¤ªæ£’äº†ï¼æ”¶ä¸‹
    </button>
  </div>

  <div class="container chrome-optimized">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <div id="video-container" style="position: relative">
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
      </div>

      <video id="mainVideo"
             playsinline
             webkit-playsinline
             controls
             controlsList="nodownload"
             crossOrigin="anonymous">
        <source src="" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
      </video>

      <!-- å³ä¸Šè§’è¦†ç›–å±‚ï¼šä»…æ˜¾ç¤ºæš‚åœæŒ‰é’®ï¼Œå–æ¶ˆ"å®Œæˆé…éŸ³"æŒ‰é’® -->
      <div id="recordOverlay" class="record-overlay" aria-label="å½•åˆ¶æ§åˆ¶" style="display:none;">
        <button id="pauseToggleBtn" class="btn pause" onclick="togglePauseDuringRecording()">æš‚åœ</button>
      </div>

      <!-- äººæ€§åŒ–ï¼šä½©æˆ´è€³æœºæç¤º -->
      <div class="tip" style="margin-top: 6px;">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°å•¸å«ï¼</div>
      <div class="status-text" id="statusText"></div>

      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>

      <canvas id="processCanvas" style="display: none;"></canvas>
      
      <!-- Chromeè§†é¢‘éªŒè¯çŠ¶æ€ -->
      <div id="videoValidation" class="video-validating">
        <span id="validationMessage">è§†é¢‘éªŒè¯ä¸­...</span>
        <span class="quality-indicator" id="qualityIndicator"></span>
      </div>
    </div>

    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <p style="font-size:12px; color:#999; margin-bottom:15px;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>

      <video id="previewVideo"
             style="width:100%; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); background:#000;"
             controls
             playsinline
             webkit-playsinline></video>

      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <a id="downloadLink" class="btn btn-download" style="display: none;">ğŸ’¾ ä¸‹è½½è§†é¢‘ (Download)</a>
      </div>

      <div id="waitingHint" style="text-align: center; margin: 20px 0; display: none;">
        <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--rabbit-red); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px;"></div>
        <span style="color: var(--pear-yellow); font-weight: bold;">è¯·ç­‰å¾…è§†é¢‘åˆæˆ...</span>
      </div>

      <div style="font-size:10px; color:#999; margin-top:15px; text-align:center;" id="saveTipText">
        * Chromeæµè§ˆå™¨ï¼šå³é”®ç‚¹å‡»è§†é¢‘é€‰æ‹©"è§†é¢‘å¦å­˜ä¸º"ï¼Œæˆ–ä½¿ç”¨ä¸‹è½½æŒ‰é’®ã€‚
      </div>
    </div>
  </div>

  <script>
    // å…¨å±æ¬¢è¿åŠ¨ç”»æ§åˆ¶
    (function setupWelcome() {
      const welcome = document.getElementById('welcome');
      const wVideo = document.getElementById('welcomeVideo');
      const skipBtn = document.getElementById('welcomeSkipBtn');
      const enterBtn = document.getElementById('welcomeEnterBtn');

      // å½©çº¸/å½©çº¸
      const colors = ['#fff176', '#ff8a80', '#80d8ff', '#ffd180', '#ea80fc', '#a7ffeb'];
      for (let i = 0; i < 18; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        const size = 6 + Math.floor(Math.random() * 8);
        const left = Math.random() * 100;
        const delay = (Math.random() * 0.8).toFixed(2);
        const dur = (2.2 + Math.random() * 2.2).toFixed(2);
        c.style.left = left + 'vw';
        c.style.background = colors[i % colors.length];
        c.style.width = size + 'px';
        c.style.height = (size + 4) + 'px';
        c.style.animationDuration = dur + 's';
        c.style.animationDelay = delay + 's';
        welcome.appendChild(c);
      }

      const hideWelcome = () => {
        if (welcome.classList.contains('hidden')) return;
        welcome.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        // é˜²æ­¢è§†é¢‘ç»§ç»­å ç”¨è§£ç èµ„æº
        try { wVideo.pause(); } catch(e){}
        setTimeout(() => {
          welcome.style.display = 'none';
        }, 650);
      };

      // è¿›å…¥æŒ‰é’®è¯·æ±‚éº¦å…‹é£æƒé™åè¿›å…¥
      enterBtn.addEventListener('click', async () => {
        await checkMicPermissionAndResumeAudio();
        hideWelcome();
      });

      skipBtn.addEventListener('click', hideWelcome);
      wVideo.addEventListener('error', hideWelcome, { once: true });
      wVideo.loop = true;
    })();

    // æ•°æ®é…ç½®åŒº
    const videoDatabase = {
      "K2A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4",
        "", "", ""
      ],
      "K2B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4",
        "", "", ""
      ],
      "K3A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4",
        "", "", ""
      ],
      "K3B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4",
        "", "", ""
      ],
      "G0": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"
      ],
      "G1A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"
      ],
      "G1B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"
      ],
      "G2A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4",
        ""
      ],
      "G2B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4",
        "", "", ""
      ],
      "G3A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4",
        "", "", ""
      ],
      "G3B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4",
        "", "", "", "", ""
      ],
      "G4A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4",
        "", "", ""
      ],
      "G4B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4",
        "", "", ""
      ]
    };

    // å˜é‡åŒº
    let mediaRecorder;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let videoStream = null;
    let sourceVideo = null;
    let sourceMic = null;
    let dest = null;
    let micGainNode = null;
    let videoGainNode = null;
    let isRecording = false;
    let recordedMimeType = '';
    let animationFrameId = null;
    let hasMicPermission = false;
    
    // æ–°å¢å˜é‡ï¼šæ§åˆ¶ Intro å’Œ ç»˜åˆ¶
    let isIntroMode = false;
    let introImageObj = null;

    // åˆæˆè¿›åº¦æ§åˆ¶
    let processingInterval = null;
    let processingProgress = 0;

    // ç”Ÿæˆè§†é¢‘åç”¨äºä¿å­˜çš„å…¨å±€å¯¹è±¡
    let finalBlob = null;
    let finalObjectURL = '';
    let finalFilename = '';

    // ç¯å¢ƒæ£€æµ‹ - ä¸“ä¸ºChromeä¼˜åŒ–
    const ua = navigator.userAgent || '';
    const isChrome = /Chrome/i.test(ua) && !/Edge/i.test(ua);
    const isFirefox = /Firefox/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    
    // Chromeä¸“ç”¨ï¼šè§†é¢‘éªŒè¯æ ‡å¿—
    let videoValidationInProgress = false;
    let videoValidationComplete = false;

    // AudioContext åˆå§‹åŒ–
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    function initializeAudioContext() {
      if (!audioCtx || audioCtx.state === 'closed') {
        audioCtx = new AudioContext();
      }
    }

    async function checkMicPermissionAndResumeAudio() {
      initializeAudioContext();

      if (audioCtx.state === 'suspended') {
        try { await audioCtx.resume(); } catch(e) { console.warn("AudioContext resume failed:", e); }
      }

      if (hasMicPermission && micStream) return true;

      try {
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: { 
            echoCancellation: true, 
            noiseSuppression: true, 
            autoGainControl: true,
            // Chromeä¸“ç”¨ä¼˜åŒ–
            channelCount: 1,
            sampleRate: 44100
          }
        });
        hasMicPermission = true;
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        return true;
      } catch (err) {
        console.error("éº¦å…‹é£æƒé™è¢«æ‹’ç»æˆ–è·å–å¤±è´¥:", err);
        hasMicPermission = false;
        showMicErrorHint();
        return false;
      }
    }

    function showMicErrorHint() {
      const overlay = document.getElementById('micAuthErrorOverlay');
      overlay.style.display = 'flex';
    }

    function closeMicErrorHint() {
      const overlay = document.getElementById('micAuthErrorOverlay');
      overlay.style.display = 'none';
    }

    // åˆå§‹åŒ–çº§åˆ«å’Œå•å…ƒ
    const levels = Object.keys(videoDatabase);
    const levelSelect = document.getElementById("levelSelect");
    levels.forEach(lvl => {
      let option = document.createElement("option");
      option.value = lvl;
      option.text = lvl;
      levelSelect.appendChild(option);
    });

    function updateUnits() {
      const lvl = document.getElementById("levelSelect").value;
      const unitSelect = document.getElementById("unitSelect");
      unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
      unitSelect.disabled = true;

      if (lvl && videoDatabase[lvl]) {
        let hasUnits = false;
        for (let i = 0; i < videoDatabase[lvl].length; i++) {
          if (videoDatabase[lvl][i] && videoDatabase[lvl][i] !== "") {
            let option = document.createElement("option");
            option.value = i;
            option.text = "Unit " + (i + 1);
            unitSelect.appendChild(option);
            hasUnits = true;
          }
        }
        if(hasUnits) unitSelect.disabled = false;
      }
    }

    function findVideo() {
      const lvl = document.getElementById("levelSelect").value;
      const unitIndex = document.getElementById("unitSelect").value;
      const videoContainer = document.getElementById("video-container");
      const videoPlayer = document.getElementById("mainVideo");
      const loader = document.getElementById("loaderOverlay");
      const actionBtn = document.getElementById("actionBtn");
      const playBtn = document.getElementById("playBtn");

      if (!lvl || unitIndex === "") {
        alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼");
        return;
      }

      const url = videoDatabase[lvl][unitIndex];
      document.getElementById("resultArea").style.display = "none";
      actionBtn.style.display = "none";
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      playBtn.style.display = "none";
      videoContainer.style.display = "block";
      loader.style.display = "flex";

      videoPlayer.src = url;
      videoPlayer.load();
      videoPlayer.volume = 1.0;
      
      // é‡ç½® controls
      videoPlayer.controls = true;

      videoPlayer.onprogress = function() {
        if (videoPlayer.buffered.length > 0) {
          const duration = videoPlayer.duration;
          const buffered = videoPlayer.buffered.end(0);
          if (duration > 0) {
            const percent = Math.min(100, Math.floor((buffered / duration) * 100));
            document.getElementById("loadingText").innerText = "è§†é¢‘ç¼“å†²ä¸­ " + percent + "%";
          }
        }
      };

      videoPlayer.oncanplaythrough = function() {
        loader.style.display = "none";
        actionBtn.style.display = "block";
        playBtn.style.display = "block";
        document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•ï¼Œå¯å…ˆé¢„è§ˆï¼Œæˆ–ç›´æ¥é…éŸ³";
        
        // å…³é”®ï¼šè§†é¢‘åŠ è½½åï¼Œè®¾ç½®Canvaså°ºå¯¸ä»¥åŒ¹é…è§†é¢‘
        const canvas = document.getElementById("processCanvas");
        canvas.width = videoPlayer.videoWidth || 640;
        canvas.height = videoPlayer.videoHeight || 360;
        
        // Chromeä¸“ç”¨ï¼šæ˜¾ç¤ºè§†é¢‘éªŒè¯ä¿¡æ¯
        if (isChrome) {
          setTimeout(() => {
            document.getElementById("videoValidation").style.display = "block";
            updateVideoQualityIndicator(videoPlayer);
          }, 500);
        }
      };

      videoPlayer.onended = function() {
        if(!isRecording) {
          playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
        }
      };

      videoPlayer.onplay = function() {
        if (!isRecording) playBtn.innerHTML = "â¸ï¸ æš‚åœæ’­æ”¾ Pause";
      };

      videoPlayer.onpause = function() {
        if (!isRecording) playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
      };

      videoPlayer.onerror = function() {
        loader.style.display = "none";
        alert("è§†é¢‘åŠ è½½å¤±è´¥ï¼åŸå› å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–è·¨åŸŸé™åˆ¶ã€‚å¦‚æœè§†é¢‘æ— æ³•åŠ è½½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨CORSè®¾ç½®ã€‚");
        document.getElementById("statusText").innerText = "âŒ è§†é¢‘åŠ è½½å¤±è´¥";
      };

      videoContainer.scrollIntoView({behavior: "smooth"});
    }
    
    // Chromeä¸“ç”¨ï¼šæ›´æ–°è§†é¢‘è´¨é‡æŒ‡ç¤ºå™¨
    function updateVideoQualityIndicator(video) {
      if (!video || !video.videoWidth) return;
      
      const indicator = document.getElementById("qualityIndicator");
      const message = document.getElementById("validationMessage");
      
      // æ ¹æ®è§†é¢‘åˆ†è¾¨ç‡å’Œç¼“å†²çŠ¶æ€è¯„ä¼°è´¨é‡
      const width = video.videoWidth;
      const height = video.videoHeight;
      const totalPixels = width * height;
      
      let quality = "good";
      let qualityText = "è§†é¢‘è´¨é‡è‰¯å¥½";
      
      if (totalPixels < 640 * 480) {
        quality = "poor";
        qualityText = "è§†é¢‘åˆ†è¾¨ç‡è¾ƒä½";
      }
      
      if (video.buffered.length === 0 || video.readyState < 2) {
        quality = "bad";
        qualityText = "è§†é¢‘åŠ è½½ä¸å®Œæ•´";
      }
      
      indicator.className = "quality-indicator " + quality;
      message.textContent = qualityText;
    }

    function togglePreview() {
      const video = document.getElementById("mainVideo");
      if (video.paused) {
        video.volume = 1.0;
        video.muted = false;
        video.play();
      } else {
        video.pause();
      }
    }

    function resetRecording() {
      document.getElementById("resultArea").style.display = "none";
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.style.display = "block";
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      actionBtn.disabled = false;
      document.getElementById("playBtn").style.display = "block";
      document.getElementById("playBtn").innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
      document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®ï¼Œè¯·ç‚¹å‡»æŒ‰é’®å†æ¬¡é…éŸ³";

      const mainVideo = document.getElementById("mainVideo");
      mainVideo.currentTime = 0;
      mainVideo.pause();
      mainVideo.controls = true; // æ¢å¤æ˜¾ç¤ºæ§ä»¶

      const preview = document.getElementById("previewVideo");
      if(preview.src) {
        URL.revokeObjectURL(preview.src);
        preview.src = "";
      }
      finalBlob = null;
      if (finalObjectURL) {
        URL.revokeObjectURL(finalObjectURL);
        finalObjectURL = '';
      }
      finalFilename = '';

      document.getElementById("video-container").scrollIntoView({behavior: "smooth"});
      const overlay = document.getElementById('recordOverlay');
      if (overlay) overlay.style.display = 'none';
      
      // é‡ç½®éªŒè¯çŠ¶æ€
      videoValidationInProgress = false;
      videoValidationComplete = false;
    }

    // æ ¸å¿ƒå½•åˆ¶é€»è¾‘ - Chromeä¼˜åŒ–ç‰ˆ
    function getBestMimeType() {
      // Chromeä¼˜å…ˆä½¿ç”¨VP8/VP9ç¼–ç ï¼Œå…¼å®¹æ€§æ›´å¥½
      const types = [
        "video/webm;codecs=vp9,opus",
        "video/webm;codecs=vp8,opus",
        "video/webm;codecs=vp9",
        "video/webm;codecs=vp8",
        "video/webm",
        "video/mp4;codecs=avc1.42E01E,mp4a.40.2",
        "video/mp4;codecs=avc1",
        "video/mp4"
      ];
      
      for (const type of types) {
        if (MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
          console.log("Using MIME type:", type);
          return type;
        }
      }
      console.log("Using default/fallback MIME type");
      return 'video/webm;codecs=vp8,opus';
    }

    function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        prepareAndStartRecording();
      }
    }

    async function prepareAndStartRecording() {
      const video = document.getElementById("mainVideo");
      if (video.readyState < 2) {
        alert("è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæ¯•");
        return;
      }

      const permissionGranted = await checkMicPermissionAndResumeAudio();
      if (!permissionGranted) return;

      // 1. ç«‹å³éšè—æ§ä»¶ï¼Œé˜²æ­¢å‡ºç°æ’­æ”¾æŒ‰é’®
      video.controls = false;

      const overlay = document.getElementById('countdown-overlay');
      const text = document.getElementById('countdownText');
      let count = 3;
      overlay.style.display = 'flex';
      text.innerText = count;
      text.style.animation = 'none';
      void text.offsetHeight;
      text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          text.innerText = count;
          text.style.animation = 'none';
          void text.offsetHeight;
          text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        } else {
          clearInterval(timer);
          text.innerText = "GO!";
          setTimeout(() => {
            overlay.style.display = 'none';
            enterFullscreenMode();
            executeActualRecording();
          }, 500);
        }
      }, 1000);
    }

    function enterFullscreenMode() {
      document.body.classList.add('recording-mode');
      const docElm = document.documentElement;
      if (docElm.requestFullscreen) {
        docElm.requestFullscreen().catch(()=>{});
      } else if (docElm.mozRequestFullScreen) {
        docElm.mozRequestFullScreen().catch(()=>{});
      } else if (docElm.webkitRequestFullScreen) {
        docElm.webkitRequestFullScreen().catch(()=>{});
      }
    }

    function exitFullscreenMode() {
      document.body.classList.remove('recording-mode');
      if (document.exitFullscreen) {
        document.exitFullscreen().catch(()=>{});
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen().catch(()=>{});
      } else if (document.webkitCancelFullScreen) {
        document.webkitCancelFullScreen().catch(()=>{});
      }
    }

    async function executeActualRecording() {
      const video = document.getElementById("mainVideo");
      const canvas = document.getElementById("processCanvas");
      const ctx = canvas.getContext("2d");
      const status = document.getElementById("statusText");
      const actionBtn = document.getElementById("actionBtn");

      // å†æ¬¡ç¡®è®¤éšè—æ§ä»¶
      video.controls = false;

      if (audioCtx.state === 'suspended') {
        await audioCtx.resume();
      }

      // ç”»é¢æŠ“å–è®¾ç½®
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      try {
        // Chromeä¸“ç”¨ï¼šæé«˜å¸§ç‡ä»¥è·å¾—æ›´æµç•…çš„è§†é¢‘
        canvasStream = canvas.captureStream(30); // ä»25æå‡åˆ°30fps
      } catch(e) {
        console.error("Canvas captureStream failed:", e);
        alert("ç”»é¢æ•è·å¤±è´¥ï¼šæµè§ˆå™¨ä¸æ”¯æŒCanvasæµæ•è·ã€‚è¯·å°è¯•æ›´æ–°Chromeæµè§ˆå™¨ã€‚");
        return;
      }

      const canvasVideoTrack = canvasStream.getVideoTracks()[0];
      if (!canvasVideoTrack) {
        alert("æœªèƒ½è·å–è§†é¢‘è½¨é“ï¼Œè¯·é‡è¯•ã€‚");
        return;
      }

      // æ··åˆéŸ³é¢‘è½¨é“
      dest = audioCtx.createMediaStreamDestination();
      micGainNode = audioCtx.createGain();
      videoGainNode = audioCtx.createGain();
      
      // åˆå§‹åŒ–æ—¶å…ˆé™éŸ³ï¼Œé˜²æ­¢ Intro æœŸé—´æœ‰å™ªéŸ³
      micGainNode.gain.value = 0; 
      videoGainNode.gain.value = 0;

      if (micStream && micStream.getAudioTracks().length > 0) {
        sourceMic = audioCtx.createMediaStreamSource(micStream);
        sourceMic.connect(micGainNode);
        micGainNode.connect(dest);
      }

      try {
        if (!video._elementAudioSource) {
          video._elementAudioSource = audioCtx.createMediaElementSource(video);
        }
        sourceVideo = video._elementAudioSource;
        sourceVideo.connect(videoGainNode);
        videoGainNode.connect(dest);
        dest.connect(audioCtx.destination);
      } catch (e) {
        console.warn("MediaElementAudioSourceNode fallback logic", e);
      }

      const mixedAudioTrack = dest.stream.getAudioTracks()[0];
      let combinedStream;
      if (mixedAudioTrack) {
        combinedStream = new MediaStream([canvasVideoTrack, mixedAudioTrack]);
      } else {
        // Fallback
        const micTrack = micStream && micStream.getAudioTracks().length > 0 ? micStream.getAudioTracks()[0] : null;
        if (micTrack) combinedStream = new MediaStream([canvasVideoTrack, micTrack]);
      }

      recordedMimeType = getBestMimeType();
      try {
        // Chromeä¸“ç”¨ï¼šæé«˜æ¯”ç‰¹ç‡ä»¥è·å¾—æ›´å¥½è´¨é‡
        mediaRecorder = recordedMimeType
          ? new MediaRecorder(combinedStream, { 
              mimeType: recordedMimeType, 
              videoBitsPerSecond: 2500000, // ä»2000000æå‡åˆ°2500000
              audioBitsPerSecond: 128000
            })
          : new MediaRecorder(combinedStream, { 
              videoBitsPerSecond: 2500000,
              audioBitsPerSecond: 128000
            });
      } catch (e) {
        alert("MediaRecorderåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆChromeæµè§ˆå™¨ã€‚");
        return;
      }

      recordedChunks = [];
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          recordedChunks.push(e.data);
          // Chromeä¸“ç”¨ï¼šå®æ—¶æ›´æ–°å½•åˆ¶æ•°æ®å¤§å°
          updateRecordingSize();
        }
      };

      mediaRecorder.onerror = (e) => {
        console.error("MediaRecorder error:", e);
        alert("å½•åˆ¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
      };
      
      mediaRecorder.onstop = () => {
        if (recordedChunks.length === 0) {
          alert("å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©ºã€‚");
          resetRecording();
          return;
        }
        
        // Chromeä¸“ç”¨ï¼šéªŒè¯å½•åˆ¶æ•°æ®å®Œæ•´æ€§
        validateRecordingData(() => {
          finishProcessingOverlayThen(() => generateVideoAndShowResult());
        });
      };

      // UI æ›´æ–°
      document.getElementById("playBtn").style.display = "none";
      actionBtn.innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ Stop";
      actionBtn.className = "btn btn-stop";
      const overlay = document.getElementById('recordOverlay');
      if (overlay) overlay.style.display = 'flex';
      const pauseBtn = document.getElementById('pauseToggleBtn');
      if (pauseBtn) pauseBtn.textContent = 'æš‚åœ';

      // å¼€å§‹å½•åˆ¶
      introImageObj = new Image();
      introImageObj.crossOrigin = "anonymous";
      introImageObj.src = "intro.png";

      const startRecorderAndDraw = () => {
          // å¯åŠ¨å½•åˆ¶å™¨
          try {
              mediaRecorder.start(100); // Chromeä¸“ç”¨ï¼šæ›´å°çš„é—´éš”ï¼Œç¡®ä¿æ•°æ®å®Œæ•´
          } catch(e) {
              alert("å½•åˆ¶å¯åŠ¨å¤±è´¥"); return;
          }

          // æ ‡è®°ä¸ºå¼€å§‹ï¼Œè¿›å…¥ç»˜å›¾å¾ªç¯
          isRecording = true;
          // å¯åŠ¨ Intro æ¨¡å¼
          isIntroMode = true;
          status.innerText = "ğŸ¬ Intro æ’­æ”¾ä¸­...";
          status.style.color = "var(--pear-yellow)";

          // å¼€å§‹ç»˜åˆ¶å¾ªç¯ï¼ˆæ­¤æ—¶ç»˜åˆ¶ Introï¼‰
          drawToCanvas(video, ctx, canvas);

          // 3ç§’ååˆ‡æ¢åˆ°è§†é¢‘å†…å®¹
          setTimeout(() => {
              isIntroMode = false; // åˆ‡æ¢ç»˜åˆ¶æ¨¡å¼
              
              // æ¢å¤éŸ³é‡
              micGainNode.gain.value = 1.5;
              videoGainNode.gain.value = 1.2;
              
              // æ’­æ”¾è§†é¢‘
              video.currentTime = 0;
              video.volume = 1.0;
              // å†æ¬¡ç¡®ä¿ä¸æ˜¾ç¤ºæ§ä»¶
              video.controls = false; 
              
              video.play().then(() => {
                 status.innerText = "ğŸ”´ å½•åˆ¶ä¸­ (Recording)...";
                 status.style.color = "#FF0000";
              }).catch((e) => {
                 console.error("Play failed:", e);
                 alert("è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»å±å¹•ã€‚");
              });
              
              video.onended = stopRecording;
          }, 3000);
      };

      introImageObj.onload = () => {
          startRecorderAndDraw();
      };

      introImageObj.onerror = () => {
          // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè·³è¿‡ Intro æ¨¡å¼
          console.warn("intro.png not found, skipping intro.");
          isIntroMode = false;
          startRecorderAndDraw();
      };
    }
    
    // Chromeä¸“ç”¨ï¼šæ›´æ–°å½•åˆ¶æ•°æ®å¤§å°æ˜¾ç¤º
    function updateRecordingSize() {
      if (!isRecording) return;
      
      let totalSize = 0;
      for (let chunk of recordedChunks) {
        totalSize += chunk.size;
      }
      
      // æ˜¾ç¤ºå½•åˆ¶æ•°æ®å¤§å°ï¼ˆå¯é€‰ï¼‰
      if (totalSize > 1024 * 1024) {
        // è¶…è¿‡1MBæ—¶æ˜¾ç¤º
        const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        console.log(`å·²å½•åˆ¶: ${sizeMB} MB`);
      }
    }
    
    // Chromeä¸“ç”¨ï¼šéªŒè¯å½•åˆ¶æ•°æ®å®Œæ•´æ€§
    function validateRecordingData(callback) {
      if (recordedChunks.length === 0) {
        console.error("å½•åˆ¶æ•°æ®ä¸ºç©º");
        callback();
        return;
      }
      
      // æ£€æŸ¥æ€»å¤§å°
      let totalSize = 0;
      for (let chunk of recordedChunks) {
        totalSize += chunk.size;
      }
      
      console.log(`å½•åˆ¶æ•°æ®æ€»å¤§å°: ${totalSize} å­—èŠ‚ (${(totalSize/1024/1024).toFixed(2)} MB)`);
      
      // å¦‚æœæ•°æ®å¤ªå°ï¼ˆå°äº100KBï¼‰ï¼Œå¯èƒ½æœ‰é—®é¢˜
      if (totalSize < 100 * 1024) {
        console.warn("å½•åˆ¶æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œå¤§å°å¼‚å¸¸");
      }
      
      callback();
    }

    // Canvas ç»˜åˆ¶å‡½æ•°
    function drawToCanvas(video, ctx, canvas) {
      if (!isRecording) {
        cancelAnimationFrame(animationFrameId);
        return;
      }
      
      try {
        if (isIntroMode) {
            // Intro æ¨¡å¼ï¼šç»˜åˆ¶å›¾ç‰‡ï¼ˆä¿æŒé»‘åº•ï¼‰
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (introImageObj) {
                ctx.drawImage(introImageObj, 0, 0, canvas.width, canvas.height);
            }
        } else {
            // è§†é¢‘æ¨¡å¼ï¼šç»˜åˆ¶è§†é¢‘
            if (video.readyState >= 2 && !video.ended) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
        }
      } catch (e) {
        console.error("Canvas Draw Error:", e);
        isRecording = false;
        exitFullscreenMode();
        alert("å½•åˆ¶ä¸­æ–­ï¼šè§†é¢‘è·¨åŸŸé™åˆ¶(CORS)ã€‚");
        stopRecording();
        return;
      }
      
      animationFrameId = requestAnimationFrame(() => drawToCanvas(video, ctx, canvas));
    }

    function stopRecording() {
      if (!mediaRecorder || mediaRecorder.state === "inactive") return;

      isRecording = false;
      isIntroMode = false; // é‡ç½®
      cancelAnimationFrame(animationFrameId);
      exitFullscreenMode();

      const video = document.getElementById("mainVideo");
      const actionBtn = document.getElementById("actionBtn");
      video.pause();
      video.controls = true; // æ¢å¤æ§ä»¶

      // éšè—å³ä¸Šè§’è¦†ç›–å±‚
      const overlay = document.getElementById('recordOverlay');
      if (overlay) overlay.style.display = 'none';

      actionBtn.disabled = true;
      beginProcessingOverlay();

      try { 
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop(); 
        }
      } catch(e) { 
        console.warn("mediaRecorder.stop error:", e); 
      }

      // æ¸…ç†å›é€€æµ
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }

      if (canvasStream) {
        canvasStream.getTracks().forEach(track => track.stop());
        canvasStream = null;
      }

      if (audioCtx) {
        if(sourceMic) { try { sourceMic.disconnect(); } catch(e){} }
        if(sourceVideo) { try { sourceVideo.disconnect(); } catch(e){} }
        if(micGainNode) { try { micGainNode.disconnect(); } catch(e){} }
        if(videoGainNode) { try { videoGainNode.disconnect(); } catch(e){} }
        if(dest) { try { dest.disconnect(); } catch(e){} }
      }
      sourceMic = null;
      sourceVideo = null;
      micGainNode = null;
      videoGainNode = null;
      dest = null;

      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      actionBtn.className = "btn btn-record";
      document.getElementById("statusText").innerText = "âœ¨ è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...";
      document.getElementById("statusText").style.color = "var(--pear-yellow)";
    }

    // åˆæˆè¿›åº¦ & ç»“æœå±•ç¤º - Chromeä¼˜åŒ–ç‰ˆ
    function beginProcessingOverlay() {
      const overlay = document.getElementById('processing-overlay');
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');
      overlay.style.display = 'flex';
      processingProgress = 0;
      bar.style.width = '0%';
      text.innerText = '0%';

      if (processingInterval) clearInterval(processingInterval);
      
      // Chromeä¸“ç”¨ï¼šæ›´çœŸå®çš„è¿›åº¦æ¨¡æ‹Ÿ
      processingInterval = setInterval(() => {
        if (processingProgress < 85) {
          // å‰85%è¾ƒå¿«
          const step = Math.max(1, Math.round((85 - processingProgress) / 8));
          processingProgress = Math.min(85, processingProgress + step);
          bar.style.width = processingProgress + '%';
          text.innerText = processingProgress + '%';
        } else if (processingProgress < 95) {
          // 85-95%è¾ƒæ…¢
          processingProgress = Math.min(95, processingProgress + 1);
          bar.style.width = processingProgress + '%';
          text.innerText = processingProgress + '%';
        }
      }, 100);
    }

    function finishProcessingOverlayThen(callback) {
      const overlay = document.getElementById('processing-overlay');
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');
      if (processingInterval) {
        clearInterval(processingInterval);
        processingInterval = null;
      }
      
      // Chromeä¸“ç”¨ï¼šæœ€åé˜¶æ®µæ›´æ…¢ï¼Œç¡®ä¿æ•°æ®å¤„ç†å®Œæˆ
      const stepper = setInterval(() => {
        if (processingProgress < 97) {
          processingProgress = Math.min(97, processingProgress + 1);
        } else if (processingProgress < 100) {
          // æœ€å3%éå¸¸æ…¢ï¼Œç¡®ä¿å®Œå…¨å¤„ç†
          processingProgress = Math.min(100, processingProgress + 0.5);
        }
        
        bar.style.width = processingProgress + '%';
        text.innerText = Math.floor(processingProgress) + '%';
        
        if (processingProgress >= 100) {
          clearInterval(stepper);
          setTimeout(() => {
            overlay.style.display = 'none';
            if (typeof callback === 'function') callback();
          }, 300); // é¢å¤–ç­‰å¾…300msç¡®ä¿å®Œå…¨å¤„ç†
        }
      }, 80);
    }

    // Chromeä¸“ç”¨ï¼šè§†é¢‘éªŒè¯
    function validateVideoBeforeDownload(blob, callback) {
      videoValidationInProgress = true;
      const validationOverlay = document.getElementById('chromeValidationOverlay');
      const validationStatus = document.getElementById('validationStatus');
      const videoDuration = document.getElementById('videoDuration');
      const videoSize = document.getElementById('videoSize');
      const videoInfo = document.getElementById('videoValidationInfo');
      
      validationOverlay.style.display = 'flex';
      validationStatus.textContent = "éªŒè¯ä¸­ï¼Œè¯·ç¨å€™...";
      validationStatus.style.color = "#4CAF50";
      
      // åˆ›å»ºä¸´æ—¶è§†é¢‘å…ƒç´ è¿›è¡ŒéªŒè¯
      const tempVideo = document.createElement('video');
      const tempURL = URL.createObjectURL(blob);
      
      tempVideo.src = tempURL;
      tempVideo.preload = "metadata";
      
      let validationTimeout = null;
      let hasDuration = false;
      
      // è®¾ç½®è¶…æ—¶
      validationTimeout = setTimeout(() => {
        console.warn("è§†é¢‘éªŒè¯è¶…æ—¶");
        validationStatus.textContent = "éªŒè¯è¶…æ—¶ï¼Œä½†è§†é¢‘å¯èƒ½ä»å¯ç”¨";
        validationStatus.style.color = "#FF9800";
        finishValidation(tempURL, tempVideo, blob, callback);
      }, 10000);
      
      tempVideo.onloadedmetadata = function() {
        clearTimeout(validationTimeout);
        hasDuration = true;
        
        const duration = Math.floor(tempVideo.duration);
        const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
        
        videoDuration.textContent = duration;
        videoSize.textContent = sizeMB;
        videoInfo.style.display = "block";
        
        if (duration < 2) {
          validationStatus.textContent = `è­¦å‘Šï¼šè§†é¢‘æ—¶é•¿è¾ƒçŸ­ï¼ˆ${duration}ç§’ï¼‰`;
          validationStatus.style.color = "#FF9800";
        } else if (duration < 5) {
          validationStatus.textContent = `è§†é¢‘æ—¶é•¿ï¼š${duration}ç§’`;
          validationStatus.style.color = "#4CAF50";
        } else {
          validationStatus.textContent = `è§†é¢‘æ—¶é•¿ï¼š${duration}ç§’ï¼ˆè‰¯å¥½ï¼‰`;
          validationStatus.style.color = "#4CAF50";
        }
        
        finishValidation(tempURL, tempVideo, blob, callback);
      };
      
      tempVideo.onerror = function() {
        clearTimeout(validationTimeout);
        validationStatus.textContent = "è§†é¢‘éªŒè¯å¤±è´¥ï¼Œå¯èƒ½å·²æŸå";
        validationStatus.style.color = "#F44336";
        
        setTimeout(() => {
          validationOverlay.style.display = 'none';
          URL.revokeObjectURL(tempURL);
          videoValidationInProgress = false;
          alert("ç”Ÿæˆçš„è§†é¢‘å¯èƒ½å·²æŸåï¼Œè¯·é‡è¯•å½•åˆ¶ã€‚");
        }, 2000);
      };
    }
    
    function finishValidation(tempURL, tempVideo, blob, callback) {
      const validationOverlay = document.getElementById('chromeValidationOverlay');
      
      setTimeout(() => {
        validationOverlay.style.display = 'none';
        URL.revokeObjectURL(tempURL);
        tempVideo.src = "";
        videoValidationInProgress = false;
        videoValidationComplete = true;
        
        if (typeof callback === 'function') {
          callback(blob);
        }
      }, 1500);
    }

    // ç”Ÿæˆç»“æœ - Chromeä¼˜åŒ–ç‰ˆ
    function generateVideoAndShowResult() {
      if(recordedChunks.length === 0) {
        alert("å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©ºã€‚å¯èƒ½æ˜¯Canvasæ•è·å¤±è´¥æˆ–éº¦å…‹é£æœªæˆæƒã€‚");
        document.getElementById("statusText").innerText = "âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
        document.getElementById("statusText").style.color = "var(--rabbit-red)";
        return;
      }

      try {
        const type = recordedMimeType || 'video/webm';
        finalBlob = new Blob(recordedChunks, { type });
        
        // Chromeä¸“ç”¨ï¼šå…ˆéªŒè¯è§†é¢‘å†æ˜¾ç¤º
        if (isChrome) {
          validateVideoBeforeDownload(finalBlob, function(validatedBlob) {
            displayFinalResult(validatedBlob, type);
          });
        } else {
          displayFinalResult(finalBlob, type);
        }
      } catch(e) {
        console.error(e);
        alert("è§†é¢‘ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•");
        document.getElementById("statusText").innerText = "âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
        document.getElementById("statusText").style.color = "var(--rabbit-red)";
      }
    }
    
    function displayFinalResult(blob, type) {
      finalObjectURL = URL.createObjectURL(blob);

      const preview = document.getElementById("previewVideo");
      preview.src = finalObjectURL;
      preview.muted = false;
      preview.volume = 1.0;

      const downloadBtn = document.getElementById("downloadLink");
      const lowerType = type.toLowerCase();
      let ext = '.webm'; // Chromeé»˜è®¤ä½¿ç”¨webm
      if (lowerType.includes('mp4')) ext = '.mp4';
      
      const now = new Date();
      const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
      finalFilename = `Firstleap_Voice_${timestamp}${ext}`;

      // ç¯å¢ƒæŒ‰é’®é…ç½®
      setupSaveButton(downloadBtn);

      document.getElementById("actionBtn").style.display = "none";

      const resultArea = document.getElementById("resultArea");
      resultArea.style.display = "block";

      document.getElementById("waitingHint").style.display = "block";
      document.getElementById("downloadLink").style.display = "none";

      resultArea.scrollIntoView({behavior: "smooth"});
      document.getElementById("statusText").innerText = "ğŸ‰ åˆ¶ä½œæˆåŠŸï¼Excellent!";
      document.getElementById("statusText").style.color = "var(--rabbit-red)";

      // Chromeä¸“ç”¨ï¼šç¡®ä¿è§†é¢‘å®Œå…¨åŠ è½½åå†æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
      preview.onloadeddata = function() {
        setTimeout(() => {
          document.getElementById("waitingHint").style.display = "none";
          document.getElementById("downloadLink").style.display = "flex";
          
          // é¢å¤–éªŒè¯ï¼šç¡®ä¿è§†é¢‘å¯ä»¥æ’­æ”¾
          preview.play().then(() => {
            preview.pause();
            preview.currentTime = 0;
          }).catch(() => {
            console.log("è‡ªåŠ¨æ’­æ”¾æµ‹è¯•å¤±è´¥ï¼Œä½†ä¸‹è½½åº”è¯¥å¯ç”¨");
          });
        }, 1000);
      };
      
      // å¤‡ç”¨ï¼šå¦‚æœonloadeddataä¸è§¦å‘ï¼Œ3ç§’åä»æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
      setTimeout(() => {
        if (document.getElementById("downloadLink").style.display === "none") {
          document.getElementById("waitingHint").style.display = "none";
          document.getElementById("downloadLink").style.display = "flex";
        }
      }, 3000);
    }

    // ä¿å­˜æŒ‰é’® - Chromeä¼˜åŒ–ç‰ˆ
    function setupSaveButton(downloadBtn) {
      const tip = document.getElementById('saveTipText');
      downloadBtn.removeAttribute('href');
      downloadBtn.removeAttribute('download');
      downloadBtn.onclick = null;

      downloadBtn.textContent = "ğŸ’¾ ä¸‹è½½è§†é¢‘ (Download)";
      downloadBtn.href = finalObjectURL;
      downloadBtn.download = finalFilename;
      downloadBtn.target = "_blank";
      
      // Chromeä¸“ç”¨ï¼šæ·»åŠ ç‚¹å‡»ç¡®è®¤
      downloadBtn.addEventListener('click', function(e) {
        if (!finalBlob || finalBlob.size < 1024) {
          e.preventDefault();
          alert("è§†é¢‘å°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨å€™å†è¯•ã€‚");
          return;
        }
        
        // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
        console.log(`å¼€å§‹ä¸‹è½½: ${finalFilename} (${(finalBlob.size/1024/1024).toFixed(2)} MB)`);
        
        // Chromeå¯èƒ½ä¼šé˜»å¡å¼¹å‡ºçª—å£ï¼Œè¿™é‡Œä½¿ç”¨setTimeoutç¡®ä¿ä¸‹è½½è§¦å‘
        setTimeout(() => {
          if (!this.getAttribute('href')) {
            this.href = finalObjectURL;
            this.download = finalFilename;
          }
        }, 100);
      });
      
      tip.innerHTML = '* Chromeæµè§ˆå™¨ï¼šç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œæˆ–å³é”®è§†é¢‘é€‰æ‹©"è§†é¢‘å¦å­˜ä¸º"ã€‚';
    }

    // å³ä¸Šè§’æš‚åœæŒ‰é’®
    function togglePauseDuringRecording() {
      const video = document.getElementById("mainVideo");
      const btn = document.getElementById("pauseToggleBtn");
      if (!video) return;

      if (video.paused) {
        video.play().catch(() => {});
        btn.textContent = 'æš‚åœ';
      } else {
        video.pause();
        btn.textContent = 'ç»§ç»­';
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const downloadBtn = document.getElementById('downloadLink');
      downloadBtn.textContent = "ğŸ’¾ ä¸‹è½½è§†é¢‘ (Download)";
      document.getElementById('saveTipText').innerHTML = '* Chromeæµè§ˆå™¨ï¼šç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œæˆ–å³é”®è§†é¢‘é€‰æ‹©"è§†é¢‘å¦å­˜ä¸º"ã€‚';

      const overlay = document.getElementById('recordOverlay');
      if (overlay) overlay.style.display = 'none';
      
      // Chromeæ£€æµ‹æç¤º
      if (!isChrome && !isFirefox) {
        console.log("å½“å‰æµè§ˆå™¨ä¸æ˜¯Chromeæˆ–Firefoxï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™");
      }
    });

    /* --- å½©è›‹é€»è¾‘å¼€å§‹ --- */
    let titleClickCount = 0;
    let titleClickTimer = null;

    function initEasterEgg() {
      // è·å–æ ‡é¢˜å…ƒç´ ï¼ˆh1ï¼‰
      const titleElement = document.querySelector('h1');
      
      if (!titleElement) return;

      // ç›‘å¬ç‚¹å‡»äº‹ä»¶
      titleElement.addEventListener('click', function() {
        titleClickCount++;

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œå¯åŠ¨ä¸€ä¸ªè®¡æ—¶å™¨
        // å¦‚æœ2ç§’å†…æ²¡æœ‰ç‚¹å¤Ÿ3æ¬¡ï¼Œå°±é‡ç½®è®¡æ•°
        if (titleClickCount === 1) {
          titleClickTimer = setTimeout(() => {
            titleClickCount = 0;
          }, 2000); // 2ç§’æ—¶é—´çª—å£
        }

        // å¦‚æœç‚¹åˆ°äº†3æ¬¡
        if (titleClickCount === 3) {
          showEggOverlay();
          // é‡ç½®è®¡æ•°å’Œè®¡æ—¶å™¨
          titleClickCount = 0;
          clearTimeout(titleClickTimer);
        }
      });
      
      // æŠŠé¼ æ ‡å˜æˆæ‰‹å‹ï¼Œæç¤ºå¯ä»¥ç‚¹å‡»ï¼ˆå¯é€‰ï¼‰
      titleElement.style.cursor = "pointer";
      // ç¦æ­¢åŒå‡»é€‰ä¸­æ–‡å­—ï¼Œæå‡ä½“éªŒ
      titleElement.style.userSelect = "none"; 
      titleElement.style.webkitUserSelect = "none";
    }

    function showEggOverlay() {
      const egg = document.getElementById('eggOverlay');
      if(egg) {
        egg.style.display = 'flex';
        // æ’­æ”¾ä¸€ç‚¹ç®€å•çš„éŸ³æ•ˆï¼ˆåˆ©ç”¨ç°æœ‰çš„ AudioContextï¼‰
        playEggSound();
      }
    }

    function closeEggOverlay() {
      const egg = document.getElementById('eggOverlay');
      if(egg) egg.style.display = 'none';
    }

    // ç®€å•çš„"å®"å£°æ•ˆ
    function playEggSound() {
      try {
        initializeAudioContext();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.type = 'sine';
        // é¢‘ç‡ä» 400Hz æ»‘å‘ 800Hzï¼Œå¬èµ·æ¥åƒ"Ding!"
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
      } catch(e) {
        console.log("Sound play failed", e);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å½©è›‹
    document.addEventListener('DOMContentLoaded', initEasterEgg);
    /* --- å½©è›‹é€»è¾‘ç»“æŸ --- */

  </script>
</body>
</html>
