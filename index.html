<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }
    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }
    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 720px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
    }
    h1 { color: var(--rabbit-red); font-size: 26px; margin: 10px 0 18px; font-weight: 900; }
    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px;}
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display:inline-flex; align-items:center; justify-content:center; margin-right:8px; font-size:12px; }
    select, input[type="file"] {
      width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #eee; font-size: 15px; background:#fafafa;
    }
    .btn { display:block; width:100%; padding:12px; border-radius:12px; font-size:16px; font-weight:800; color:#fff; border:none; cursor:pointer; margin-top:10px;}
    .btn-primary { background: linear-gradient(135deg,#a8e063,#56ab2f); }
    .btn-record { background: linear-gradient(90deg,#ff7b7b,#ffb86b); }
    .btn-stop { background: linear-gradient(90deg,#f6d365,#fda085); }
    .btn-download { background: linear-gradient(90deg,#4facfe,#00f2fe); color:#fff; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px; border-radius:12px;}
    .btn-retry { background:#dfe6e9; color:#333; padding:12px; border-radius:12px; display:inline-block; width:48%; box-sizing:border-box; }
    .btn-small { padding:8px 10px; font-size:13px; border-radius:8px; }
    #video-container { margin-top:18px; display:none; position:relative; min-height:180px; }
    video { width:100%; border-radius:12px; background:#000; outline:none; object-fit:contain; }
    .preview-box { margin-top:18px; padding:16px; border-radius:12px; display:none; background:#fffdf6; border:2px dashed var(--pear-yellow); }
    .tip { font-size:13px; color:#e67e22; margin-top:12px; background:#fff3e0; padding:10px; border-radius:10px; }
    .status-text { margin-top:12px; font-weight:bold; color:var(--rabbit-red); min-height:20px; }
    #wxHintOverlay, #micAuthErrorOverlay, #countdown-overlay, #processing-overlay { position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; }
    #wxHintOverlay .inner, #micAuthErrorOverlay .inner { background:rgba(0,0,0,0.85); padding:18px; border-radius:12px; color:#fff; max-width:92%; text-align:center;}
    .btn-flex { display:flex; gap:10px; margin-top:12px; }
    .btn-group { display:flex; gap:10px; justify-content:center; margin-top:12px; }
    /* small responsive */
    @media (max-width:520px) {
      .container { padding:16px; border-radius:14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Firstleap Voice Magic â€” é…éŸ³ç§€</h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button id="searchBtn" class="btn btn-primary" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘</button>

    <!-- å¯¼å…¥å¾®ä¿¡å½•éŸ³ï¼ˆæ–°å¢ï¼‰ -->
    <div style="margin-top:12px; text-align:left;">
      <div class="step-label"><span class="step-badge">å¯é€‰</span>å¯¼å…¥å¾®ä¿¡å½•éŸ³ï¼ˆéå¿…é¡»ï¼‰</div>
      <input type="file" id="importAudio" accept="audio/*" />
      <div style="font-size:12px; color:#666; margin-top:6px;">
        å»ºè®®ï¼šå®¶é•¿åœ¨å¾®ä¿¡é•¿æŒ‰è¯­éŸ³ â†’ ç‚¹å‡»â€œâ€¦æ›´å¤šâ€â†’â€œä¿å­˜ä¸ºæ–‡ä»¶â€æˆ–åˆ†äº«åˆ°â€œæ–‡ä»¶â€ï¼Œç„¶ååœ¨æ­¤å¤„é€‰æ‹©ä¸Šä¼ ï¼ˆæ”¯æŒ m4a/mp3/wavï¼Œéƒ¨åˆ† AMR å¯èƒ½éœ€å…ˆè½¬ç ï¼‰ã€‚
      </div>
    </div>

    <div id="video-container">
      <video id="mainVideo" playsinline webkit-playsinline controls crossOrigin="anonymous">
        <source src="" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
      </video>

      <div style="margin-top:8px;">
        <button id="playBtn" class="btn btn-small" onclick="togglePreview()" style="display:none;">â–¶ï¸ é¢„è§ˆåŸç‰‡</button>
        <button id="actionBtn" class="btn btn-record" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>
      </div>

      <div class="tip">ğŸ§ æ¸©é¦¨æç¤ºï¼šè‹¥å®¶é•¿ä½¿ç”¨å¾®ä¿¡è¯­éŸ³ä¸Šä¼ ï¼Œè¯·ä½¿ç”¨ä¸Šæ–¹â€œå¯¼å…¥å¾®ä¿¡å½•éŸ³â€åŠŸèƒ½ï¼Œæˆ–åœ¨å¾®ä¿¡å†…é•¿æŒ‰è¯­éŸ³å¦å­˜ä¸ºæ–‡ä»¶åå†ä¸Šä¼ ã€‚</div>
      <div class="status-text" id="statusText"></div>

      <canvas id="processCanvas" style="display:none;"></canvas>
    </div>

    <div id="resultArea" class="preview-box">
      <h3 style="margin:0; color:var(--rabbit-red);">ğŸ‰ é…éŸ³å®Œæˆï¼</h3>
      <p style="font-size:12px; color:#666;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³æˆ–éŸ³é‡é”®ã€‚</p>

      <video id="previewVideo" controls playsinline webkit-playsinline style="border-radius:8px; background:#000;"></video>

      <div class="btn-group" style="margin-top:12px;">
        <button class="btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½•</button>
        <a id="downloadLink" class="btn-download" style="display:none;">ğŸ’¾ ä¿å­˜/åˆ†äº«è§†é¢‘</a>
      </div>

      <div id="saveTipText" style="font-size:12px; color:#666; margin-top:8px;">
        * åœ¨å¾®ä¿¡å†…ï¼šç‚¹å‡»â€œä¿å­˜â€ä¼šæ‰“å¼€ä¿å­˜æç¤ºï¼Œè¯·é•¿æŒ‰è§†é¢‘é€‰æ‹©â€œä¿å­˜åˆ°æ‰‹æœºâ€æˆ–é€‰æ‹©â€œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€â€å†ä¿å­˜ï¼›éå¾®ä¿¡ç¯å¢ƒä¼šå°è¯•ç›´æ¥ä¸‹è½½æˆ–è°ƒç”¨ç³»ç»Ÿåˆ†äº«ã€‚
      </div>
    </div>
  </div>

  <!-- WeChat ä¿å­˜æç¤ºå¼¹å±‚ï¼ˆä¿ç•™å¹¶ç”¨äºæ— æ³•æ–°å¼€çª—å£æ—¶çš„åµŒå…¥å¼ä¿å­˜ï¼‰ -->
  <div id="wxHintOverlay">
    <div class="inner" style="text-align:center;">
      <div id="saveHintTitle" style="font-size:18px; font-weight:700; margin-bottom:8px;">é•¿æŒ‰ä¿å­˜è§†é¢‘/éŸ³é¢‘</div>
      <div id="saveHintText" style="font-size:14px; opacity:0.95; margin-bottom:12px;">è¯·é•¿æŒ‰ä¸‹æ–¹è§†é¢‘æ’­æ”¾å™¨ï¼Œé€‰æ‹©â€œä¿å­˜åˆ°æ‰‹æœºâ€å³å¯ã€‚</div>
      <video id="wxHintVideo" playsinline webkit-playsinline controls style="width:92%; max-width:480px; border-radius:8px; background:#000;"></video>
      <div style="margin-top:12px;">
        <button class="btn btn-small" onclick="closeWxHint()">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- éº¦å…‹é£æƒé™é”™è¯¯ -->
  <div id="micAuthErrorOverlay">
    <div class="inner">
      <div style="font-size:44px;">ğŸš«</div>
      <div style="font-size:18px; font-weight:700; margin-top:8px;">éº¦å…‹é£æƒé™è¢«æ‹’ç»</div>
      <div style="font-size:14px; margin-top:8px;">è¯·åœ¨ç³»ç»Ÿè®¾ç½®æˆ–æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®ï¼Œç„¶åé‡è¯•ã€‚</div>
      <div style="margin-top:12px;"><button class="btn btn-small" onclick="closeMicErrorHint()">çŸ¥é“äº†</button></div>
    </div>
  </div>

  <!-- å€’è®¡æ—¶/åˆæˆé®ç½©ç­‰ï¼ˆç•¥ï¼‰ -->
  <div id="countdown-overlay" style="display:none;"></div>
  <div id="processing-overlay" style="display:none;"></div>

<script>
  /* ---------- åŸæœ‰è§†é¢‘æ•°æ®åº“ï¼ˆç•¥ï¼‰ è¿™éƒ¨åˆ†ç›´æ¥ä½¿ç”¨ä½ åŸæ¥çš„ videoDatabase æ•°ç»„/å¯¹è±¡ ---------- */
  const videoDatabase = {
    "K2A": [ /* ... ä½ çš„ url åˆ—è¡¨ ... */ ],
    // çœç•¥å…¶å®ƒï¼Œä¸ºäº†ç¤ºä¾‹è¯·ä¿ç•™åŸå§‹æ–‡ä»¶å†…å®Œæ•´ videoDatabase
  };

  // å˜é‡
  let mediaRecorder, recordedChunks = [], audioCtx = null;
  let micStream = null, importedAudioEl = null, importedAudioFile = null;
  let canvasStream = null, videoStream = null;
  let sourceVideo = null, sourceMic = null, dest = null, micGainNode = null, videoGainNode = null;
  let isRecording = false, recordedMimeType = '', finalBlob = null, finalObjectURL = '', finalFilename = '';
  const ua = navigator.userAgent || '';
  const isWeChat = /MicroMessenger/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isSafari = /Safari/i.test(ua) && !/Chrome/i.test(ua);
  const supportsFileShare = (() => {
    try {
      const f = new File(["x"], "x.txt", { type: "text/plain" });
      return !!(navigator.canShare && navigator.canShare({ files: [f] }));
    } catch (e) { return false; }
  })();

  // AudioContext
  const AudioContextClass = window.AudioContext || window.webkitAudioContext;
  function ensureAudioContext() {
    if (!audioCtx || audioCtx.state === 'closed') audioCtx = new AudioContextClass();
  }

  // åˆå§‹åŒ– UIï¼šå¡«å……çº§åˆ«
  (function initUI() {
    const levelSelect = document.getElementById('levelSelect');
    Object.keys(videoDatabase).forEach(k => {
      const o = document.createElement('option'); o.value = k; o.text = k; levelSelect.appendChild(o);
    });

    // å¯¼å…¥æ–‡ä»¶äº‹ä»¶
    const importEl = document.getElementById('importAudio');
    importEl.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      handleImportAudio(f);
    });

    // é¡µé¢åŠ è½½æ—¶è°ƒæ•´ä¸‹è½½æŒ‰é’®æ–‡æ¡ˆ
    const dl = document.getElementById('downloadLink');
    if (isWeChat) dl.textContent = "ğŸ’¾ ä¿å­˜è§†é¢‘åˆ°æ‰‹æœºç›¸å†Œ (Save)";
    else if ((isIOS || isSafari) && supportsFileShare) dl.textContent = "ğŸ’¾ ä¿å­˜/åˆ†äº«è§†é¢‘";
    else dl.textContent = "ğŸ’¾ ä¸‹è½½è§†é¢‘";
  })();

  // å¤„ç†å¯¼å…¥éŸ³é¢‘æ–‡ä»¶ï¼ˆå°†å…¶åŒ…è£…ä¸º <audio>ï¼Œå¹¶ç¨ååœ¨å½•åˆ¶æ—¶æ¥å…¥ï¼‰
  async function handleImportAudio(file) {
    // é‡Šæ”¾ä¸Šä¸€æ¬¡
    if (importedAudioEl) {
      try { importedAudioEl.pause(); importedAudioEl.src = ""; } catch(e) {}
      importedAudioEl = null;
      importedAudioFile = null;
    }

    // æ£€æŸ¥ç±»å‹â€”â€”æµè§ˆå™¨å¯¹éƒ¨åˆ† amr æ”¯æŒä¸å¥½ï¼Œç»™å‡ºæç¤º
    const name = file.name || 'audio';
    const lower = name.toLowerCase();
    if (lower.endsWith('.amr')) {
      // AMR åœ¨è®¸å¤šæµè§ˆå™¨ä¸­æ— æ³•ç›´æ¥æ’­æ”¾ -> å»ºè®®ç”¨æˆ·è½¬ m4a æˆ–ä½¿ç”¨æ–‡ä»¶ç®¡ç†åˆ†äº«
      if (!confirm('æ£€æµ‹åˆ° AMR æ ¼å¼ã€‚éƒ¨åˆ†æµè§ˆå™¨æ— æ³•ç›´æ¥æ’­æ”¾ AMRï¼Œå»ºè®®å®¶é•¿å°†å¾®ä¿¡è¯­éŸ³å¦å­˜ä¸ºæ–‡ä»¶å¹¶è½¬æ¢ä¸º m4a/mp3ï¼Œæˆ–è€…åœ¨å¾®ä¿¡ä¸­ä½¿ç”¨â€œå‘é€åˆ°æ–‡ä»¶â€åå†ä¸Šä¼ ã€‚\næ˜¯å¦ç»§ç»­å°è¯•æ‰“å¼€ AMRï¼ˆå¯èƒ½æ— æ³•åœ¨éƒ¨åˆ†æ‰‹æœºæµè§ˆå™¨ä¸­æ’­æ”¾ï¼‰ï¼Ÿ')) {
        document.getElementById('importAudio').value = '';
        return;
      }
    }

    // åˆ›å»º audio å…ƒç´ 
    const url = URL.createObjectURL(file);
    const audio = document.createElement('audio');
    audio.src = url;
    audio.crossOrigin = 'anonymous';
    audio.preload = 'auto';
    importedAudioEl = audio;
    importedAudioFile = file;

    // å‘ç”¨æˆ·æç¤ºï¼šå·²å¯¼å…¥
    document.getElementById('statusText').innerText = `å·²å¯¼å…¥éŸ³é¢‘ï¼š${name}ã€‚å¼€å§‹é…éŸ³æ—¶é¡µé¢ä¼šè‡ªåŠ¨æ’­æ”¾å¹¶åˆæˆè¯¥éŸ³é¢‘ã€‚`;
  }

  // æ›´æ–°å•å…ƒï¼ˆæ²¿ç”¨åŸé€»è¾‘ï¼‰
  function updateUnits() {
    const lvl = document.getElementById("levelSelect").value;
    const unitSelect = document.getElementById("unitSelect");
    unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
    unitSelect.disabled = true;
    if (lvl && videoDatabase[lvl]) {
      for (let i = 0; i < videoDatabase[lvl].length; i++) {
        if (videoDatabase[lvl][i]) {
          const o = document.createElement('option'); o.value = i; o.text = 'Unit ' + (i+1); unitSelect.appendChild(o);
        }
      }
      unitSelect.disabled = false;
    }
  }

  // æŸ¥æ‰¾å¹¶åŠ è½½è§†é¢‘ï¼ˆæ²¿ç”¨åŸé€»è¾‘ï¼‰
  function findVideo() {
    const lvl = document.getElementById("levelSelect").value;
    const unitIndex = document.getElementById("unitSelect").value;
    if (!lvl || unitIndex === "") { alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼"); return; }
    const url = videoDatabase[lvl][unitIndex];
    const videoContainer = document.getElementById("video-container");
    const videoPlayer = document.getElementById("mainVideo");
    document.getElementById("resultArea").style.display = "none";
    videoContainer.style.display = "block";
    videoPlayer.src = url;
    videoPlayer.load();
    videoPlayer.oncanplaythrough = function() {
      document.getElementById('statusText').innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•ï¼Œå¯é¢„è§ˆæˆ–ç›´æ¥å¼€å§‹é…éŸ³";
      document.getElementById('playBtn').style.display = 'inline-block';
      const canvas = document.getElementById('processCanvas');
      canvas.width = videoPlayer.videoWidth || 640;
      canvas.height = videoPlayer.videoHeight || 360;
    };
    videoPlayer.onerror = function() {
      alert("è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæˆ–è·¨åŸŸï¼ˆCORSï¼‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥è§†é¢‘åœ°å€ã€‚");
      document.getElementById('statusText').innerText = "âŒ è§†é¢‘åŠ è½½å¤±è´¥";
    };
    videoContainer.scrollIntoView({behavior:'smooth'});
  }

  function togglePreview() {
    const v = document.getElementById('mainVideo');
    if (v.paused) { v.play().catch(()=>{}); } else v.pause();
  }

  // ----- éº¦å…‹é£æƒé™ä¸ audioCtx -----
  async function ensureMicStream() {
    if (micStream) return true;
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }});
      return true;
    } catch (e) {
      console.warn('getUserMedia fail', e);
      showMicErrorHint();
      return false;
    }
  }
  function showMicErrorHint(){ document.getElementById('micAuthErrorOverlay').style.display = 'flex'; }
  function closeMicErrorHint(){ document.getElementById('micAuthErrorOverlay').style.display = 'none'; }

  // å½•åˆ¶æ§åˆ¶
  function toggleRecording(){ if (isRecording) stopRecording(); else prepareAndStartRecording(); }

  async function prepareAndStartRecording() {
    const video = document.getElementById('mainVideo');
    if (video.readyState < 2) { alert('è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæ¯•'); return; }

    ensureAudioContext();
    // å¦‚æœç”¨æˆ·æ²¡æœ‰å¯¼å…¥éŸ³é¢‘ä¸”æœªå…è®¸éº¦å…‹é£ï¼Œåˆ™è¯·æ±‚éº¦å…‹é£æƒé™
    if (!importedAudioEl) {
      const ok = await ensureMicStream();
      if (!ok) return;
    }

    // ç®€çŸ­å€’è®¡æ—¶
    document.getElementById('statusText').innerText = 'å‡†å¤‡ä¸­... 3';
    setTimeout(()=>{ document.getElementById('statusText').innerText = 'å‡†å¤‡ä¸­... 2';}, 600);
    setTimeout(()=>{ document.getElementById('statusText').innerText = 'å‡†å¤‡ä¸­... 1';}, 1200);
    setTimeout(()=>{ document.getElementById('statusText').innerText = ''; enterFullscreenMode(); executeActualRecording();}, 1700);
  }

  function enterFullscreenMode(){
    document.documentElement.requestFullscreen?.().catch(()=>{});
    document.body.classList.add('recording-mode');
  }
  function exitFullscreenMode(){
    document.exitFullscreen?.().catch(()=>{});
    document.body.classList.remove('recording-mode');
  }

  async function executeActualRecording() {
    ensureAudioContext();
    const video = document.getElementById('mainVideo');
    const canvas = document.getElementById('processCanvas');
    const ctx = canvas.getContext('2d');

    video.currentTime = 0;
    video.controls = false;
    try { await video.play(); } catch(e) { alert('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾'); video.controls = true; return; }

    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 360;
    try { canvasStream = canvas.captureStream(25); } catch(e) { alert('Canvas æ•è·ä¸è¢«æ”¯æŒï¼Œè¯·ä½¿ç”¨æ”¯æŒ captureStream çš„æµè§ˆå™¨'); return; }
    const canvasVideoTrack = canvasStream.getVideoTracks()[0];

    // åˆ›å»º audio nodes
    dest = audioCtx.createMediaStreamDestination();
    micGainNode = audioCtx.createGain(); videoGainNode = audioCtx.createGain();
    micGainNode.gain.value = 1.2; videoGainNode.gain.value = 1.0;

    // è‹¥ç”¨æˆ·å¯¼å…¥éŸ³é¢‘ -> ç”¨å¯¼å…¥éŸ³é¢‘ä½œä¸ºâ€œéº¦å…‹é£â€
    if (importedAudioEl) {
      try {
        // ä¿è¯éŸ³é¢‘å›åˆ°0ç§’å¹¶å¼€å§‹æ’­æ”¾
        importedAudioEl.currentTime = 0;
        await importedAudioEl.play().catch(()=>{});
        const importedSource = audioCtx.createMediaElementSource(importedAudioEl);
        sourceMic = importedSource;
        sourceMic.connect(micGainNode);
        micGainNode.connect(dest);
      } catch (e) {
        console.warn('å¯¼å…¥éŸ³é¢‘æ¥å…¥å¤±è´¥', e);
        // å›é€€åˆ°çœŸå®éº¦å…‹é£
        if (!micStream) {
          const ok = await ensureMicStream();
          if (!ok) { alert('æ— æ³•è·å–éŸ³é¢‘æ¥æº'); return; }
        }
      }
    }

    // å¦‚æœæ²¡æœ‰å¯¼å…¥éŸ³é¢‘ï¼Œä¼˜å…ˆä½¿ç”¨ micStream
    if (!sourceMic && micStream && micStream.getAudioTracks().length>0) {
      try {
        sourceMic = audioCtx.createMediaStreamSource(micStream);
        sourceMic.connect(micGainNode);
        micGainNode.connect(dest);
      } catch(e) {
        console.warn('mic createMediaStreamSource fail', e);
      }
    }

    // å°è¯•æŠŠè§†é¢‘åŸå£°ä¹Ÿæ¥å…¥
    try {
      if (!video._elementAudioSource) video._elementAudioSource = audioCtx.createMediaElementSource(video);
      sourceVideo = video._elementAudioSource;
      sourceVideo.connect(videoGainNode);
      videoGainNode.connect(dest);
      // è®© mixed éŸ³é¢‘èƒ½è¢«å¬åˆ°ï¼ˆé¡µé¢å®æ—¶ç›‘å¬ï¼‰
      dest.connect(audioCtx.destination);
    } catch (e) {
      // å›é€€åˆ° captureStream çš„éŸ³è½¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      try {
        videoStream = video.captureStream ? video.captureStream() : (video.mozCaptureStream ? video.mozCaptureStream() : null);
        if (videoStream && videoStream.getAudioTracks().length>0) {
          sourceVideo = audioCtx.createMediaStreamSource(videoStream);
          sourceVideo.connect(videoGainNode); videoGainNode.connect(dest); dest.connect(audioCtx.destination);
        } else {
          console.warn('è§†é¢‘åŸå£°ä¸å¯ç”¨ï¼Œå½•åˆ¶å¯èƒ½åªå«å¯¼å…¥éŸ³é¢‘æˆ–éº¦å…‹é£');
        }
      } catch (e2) { console.warn('å›é€€è·¯ç”±å¤±è´¥', e2); }
    }

    const mixedTrack = dest.stream.getAudioTracks()[0];
    let combinedStream;
    if (mixedTrack) combinedStream = new MediaStream([canvasVideoTrack, mixedTrack]);
    else {
      const micTrack = micStream && micStream.getAudioTracks().length>0 ? micStream.getAudioTracks()[0] : null;
      if (micTrack) combinedStream = new MediaStream([canvasVideoTrack, micTrack]);
      else { alert('æ— æ³•è·å–éŸ³é¢‘è½¨é“ï¼Œå½•åˆ¶å¤±è´¥'); return; }
    }

    recordedMimeType = getBestMimeType();
    try {
      mediaRecorder = recordedMimeType ? new MediaRecorder(combinedStream, { mimeType: recordedMimeType, videoBitsPerSecond: 2000000 }) : new MediaRecorder(combinedStream, { videoBitsPerSecond:2000000 });
    } catch (e) { alert('MediaRecorder åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·å°è¯• Chrome/Safari ç­‰ç°ä»£æµè§ˆå™¨'); return; }

    recordedChunks = [];
    mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      if (recordedChunks.length === 0) { alert('å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©º'); resetRecording(); return; }
      finishProcessingOverlayThen(() => generateVideoAndShowResult());
    };
    mediaRecorder.start(500);

    isRecording = true;
    drawToCanvasLoop(video, ctx, canvas);
    document.getElementById('actionBtn').textContent = 'â¹ï¸ å®Œæˆé…éŸ³ Stop';
    document.getElementById('actionBtn').className = 'btn btn-stop';
    document.getElementById('statusText').innerText = 'ğŸ”´ å½•åˆ¶ä¸­...';

    // å½“ video æ’­æ”¾å®Œæ¯•è‡ªåŠ¨åœæ­¢å½•åˆ¶
    video.onended = stopRecording;
  }

  function drawToCanvasLoop(video, ctx, canvas) {
    if (!isRecording) return;
    try { if (video.readyState >= 2 && !video.paused && !video.ended) ctx.drawImage(video, 0, 0, canvas.width, canvas.height); }
    catch(e) { console.error('Canvas draw é”™è¯¯', e); isRecording=false; stopRecording(); return; }
    requestAnimationFrame(()=>drawToCanvasLoop(video, ctx, canvas));
  }

  function stopRecording() {
    if (!isRecording) return;
    isRecording = false;
    exitFullscreenMode();
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      try { mediaRecorder.stop(); } catch(e) { console.warn(e); }
    }
    // åœæ­¢ä¸´æ—¶æµ
    if (canvasStream) { canvasStream.getTracks().forEach(t=>t.stop()); canvasStream=null; }
    if (videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }

    // æ–­å¼€ audio nodes
    try { if (sourceMic) sourceMic.disconnect(); } catch(e){}
    try { if (sourceVideo) sourceVideo.disconnect(); } catch(e){}
    try { if (micGainNode) micGainNode.disconnect(); } catch(e){}
    try { if (videoGainNode) videoGainNode.disconnect(); } catch(e){}
    try { if (dest) dest.disconnect(); } catch(e){}
    document.getElementById('statusText').innerText = 'âœ¨ è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';
    document.getElementById('actionBtn').disabled = true;
    beginProcessingOverlay();
  }

  // è¿›åº¦æ¡ï¼ˆç®€æ˜“ï¼‰
  let processingInterval = null, processingProgress = 0;
  function beginProcessingOverlay() {
    processingProgress = 0;
    if (processingInterval) clearInterval(processingInterval);
    processingInterval = setInterval(()=> {
      if (processingProgress < 90) processingProgress += Math.max(1, Math.round((90-processingProgress)/10));
    }, 140);
  }
  function finishProcessingOverlayThen(cb) {
    if (processingInterval) clearInterval(processingInterval);
    const t = setInterval(()=> {
      processingProgress = Math.min(100, processingProgress + 6);
      if (processingProgress >= 100) { clearInterval(t); if (cb) cb(); }
    }, 40);
  }

  // ç”Ÿæˆå¹¶æ˜¾ç¤ºç»“æœï¼ˆæ²¿ç”¨åŸé€»è¾‘ï¼‰
  function generateVideoAndShowResult() {
    if (recordedChunks.length === 0) { alert('ç”Ÿæˆå¤±è´¥ï¼šæ•°æ®ä¸ºç©º'); document.getElementById('statusText').innerText = 'âŒ ç”Ÿæˆå¤±è´¥'; return; }
    const type = recordedMimeType || 'video/mp4';
    finalBlob = new Blob(recordedChunks, { type });
    finalObjectURL = URL.createObjectURL(finalBlob);
    const preview = document.getElementById('previewVideo');
    preview.src = finalObjectURL;
    preview.muted = false;
    preview.volume = 1.0;
    const downloadBtn = document.getElementById('downloadLink');
    const lower = (type||'').toLowerCase();
    let ext = '.mp4'; if (lower.includes('webm')) ext = '.webm';
    finalFilename = `Firstleap_Voice_${Date.now()}${ext}`;
    setupSaveButton(downloadBtn);
    document.getElementById('actionBtn').style.display = 'none';
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('statusText').innerText = 'ğŸ‰ åˆ¶ä½œæˆåŠŸï¼';
    setTimeout(()=>{ document.getElementById('downloadLink').style.display = 'inline-flex'; }, 700);
  }

  // ä¸‹è½½/ä¿å­˜æŒ‰é’®ç­–ç•¥ï¼ˆå¢å¼ºå¾®ä¿¡å†…æç¤ºï¼‰
  function setupSaveButton(downloadBtn) {
    downloadBtn.onclick = null; downloadBtn.removeAttribute('href'); downloadBtn.removeAttribute('download');
    if (isWeChat) {
      downloadBtn.textContent = "ğŸ’¾ ä¿å­˜è§†é¢‘åˆ°æ‰‹æœºç›¸å†Œ (Save)";
      downloadBtn.onclick = function(e){ e.preventDefault(); openWeChatSavePage(); };
      document.getElementById('saveTipText').innerText = '* åœ¨å¾®ä¿¡å†…ï¼šç‚¹å‡»åä¼šæ‰“å¼€é¢„è§ˆï¼Œè¯·é•¿æŒ‰è§†é¢‘ä¿å­˜åˆ°æ‰‹æœºã€‚';
      return;
    }
    if ((isIOS || isSafari) && supportsFileShare) {
      downloadBtn.textContent = "ğŸ’¾ ä¿å­˜/åˆ†äº«è§†é¢‘";
      downloadBtn.onclick = async function(e){ e.preventDefault(); await saveVideoViaShare(); };
      document.getElementById('saveTipText').innerText = '* iOS Safariï¼šä¼šå¼¹å‡ºç³»ç»Ÿåˆ†äº«é¢æ¿ï¼Œé€‰æ‹©â€œå­˜å‚¨è§†é¢‘â€ä¿å­˜ã€‚';
      return;
    }
    // æ™®é€šæµè§ˆå™¨ï¼šç›´æ¥ä¸‹è½½
    downloadBtn.textContent = "ğŸ’¾ ä¸‹è½½è§†é¢‘";
    downloadBtn.href = finalObjectURL;
    downloadBtn.download = finalFilename;
    downloadBtn.target = '_blank';
  }

  async function saveVideoViaShare() {
    if (!finalBlob) { alert('è¯·å…ˆå®Œæˆé…éŸ³ç”Ÿæˆè§†é¢‘'); return; }
    try {
      const f = new File([finalBlob], finalFilename||'video.mp4', { type: finalBlob.type||'video/mp4' });
      if (navigator.canShare && navigator.canShare({ files:[f] })) {
        await navigator.share({ files: [f], title:'Firstleap Voice Magic', text:'é…éŸ³ç§€' });
      } else openWeChatSavePage();
    } catch (err) { console.warn(err); alert('åˆ†äº«å¤±è´¥ï¼Œè¯·å°è¯•æµè§ˆå™¨èœå•ä¸­çš„åˆ†äº«æˆ–ä¿å­˜åŠŸèƒ½'); }
  }

  // å½“åœ¨å¾®ä¿¡å†…æˆ– iframe ä¸­æ— æ³•æ‰“å¼€æ–°çª—å£æ—¶ï¼Œä½¿ç”¨é¡µé¢å†…é¢„è§ˆå¹¶æç¤ºç”¨æˆ·é•¿æŒ‰ä¿å­˜
  function openWeChatSavePage() {
    if (!finalObjectURL) { alert('å°šæœªç”Ÿæˆå¯ä¿å­˜çš„è§†é¢‘'); return; }
    const w = window.open(finalObjectURL, '_blank');
    if (w) { try { w.focus(); } catch(e){} return; }
    // è‹¥æ— æ³• open (è¢«æ‹¦æˆª)ï¼Œç”¨é¡µé¢å†… overlay å±•ç¤ºè§†é¢‘å¹¶æç¤ºç”¨æˆ·é•¿æŒ‰ä¿å­˜
    const hintVideo = document.getElementById('wxHintVideo');
    const hintOverlay = document.getElementById('wxHintOverlay');
    if (isSafari) {
      document.getElementById('saveHintTitle').textContent = 'æ— æ³•è‡ªåŠ¨ä¿å­˜ï¼šè¯·æ‰‹åŠ¨æ“ä½œ';
      document.getElementById('saveHintText').innerHTML = 'Safari æœ‰æ—¶æ— æ³•ç›´æ¥ä¸‹è½½ã€‚è¯·ç‚¹å‡»æ’­æ”¾ï¼Œç„¶åé•¿æŒ‰è§†é¢‘é€‰æ‹©â€œå­˜å‚¨è§†é¢‘â€ã€‚';
    } else if (isWeChat) {
      document.getElementById('saveHintTitle').textContent = 'åœ¨å¾®ä¿¡ä¸­ä¿å­˜è§†é¢‘';
      document.getElementById('saveHintText').innerHTML = 'æ–¹å¼ä¸€ï¼šé•¿æŒ‰ä¸‹æ–¹è§†é¢‘ï¼Œé€‰æ‹©â€œä¿å­˜åˆ°æ‰‹æœºâ€<br>æ–¹å¼äºŒï¼šå³ä¸Šè§’èœå• â†’ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œå†ä¿å­˜';
    } else {
      document.getElementById('saveHintTitle').textContent = 'ä¿å­˜è§†é¢‘';
      document.getElementById('saveHintText').innerHTML = 'é•¿æŒ‰æˆ–å³é”®è§†é¢‘è¿›è¡Œä¿å­˜ã€‚';
    }
    hintVideo.src = finalObjectURL;
    hintOverlay.style.display = 'flex';
  }
  function closeWxHint(){ const h=document.getElementById('wxHintOverlay'); const v=document.getElementById('wxHintVideo'); v.pause(); h.style.display='none'; }

  // å·¥å…·ï¼šé€‰æ‹©åˆé€‚çš„ mime
  function getBestMimeType() {
    const types = ["video/mp4;codecs=avc1","video/mp4","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"];
    for (const t of types) if (MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
    return 'video/mp4';
  }

  // é‡ç½®
  function resetRecording() {
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('actionBtn').style.display = 'inline-block';
    document.getElementById('actionBtn').className = 'btn btn-record';
    document.getElementById('actionBtn').textContent = 'ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³';
    document.getElementById('actionBtn').disabled = false;
    document.getElementById('statusText').innerText = 'ğŸ”„ å·²é‡ç½®ï¼Œè¯·å†æ¬¡é…éŸ³';
    const mainVideo = document.getElementById('mainVideo'); mainVideo.pause(); mainVideo.currentTime=0; mainVideo.controls=true;
    const preview = document.getElementById('previewVideo'); if (preview.src) { URL.revokeObjectURL(preview.src); preview.src=''; }
    if (finalObjectURL) { try { URL.revokeObjectURL(finalObjectURL); } catch(e){} finalObjectURL=''; }
    finalBlob = null; finalFilename='';
    const overlay = document.getElementById('wxHintOverlay'); if (overlay) overlay.style.display='none';
  }

  // é¡µé¢å¸è½½æ—¶æ¸…ç†å¯¹è±¡ URL
  window.addEventListener('beforeunload', ()=>{ try { if (finalObjectURL) URL.revokeObjectURL(finalObjectURL); } catch(e){} });

</script>
</body>
</html>
