<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic (MP4 Pro)</title>
  <!-- å¼•å…¥ FFmpeg.wasm (ç”¨äºè§†é¢‘è½¬ç ) -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* Welcome Screen Styles */
    .welcome-screen {
      position: fixed; inset: 0; z-index: 100000;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
      opacity: 1; transition: opacity .6s ease, visibility .6s ease; visibility: visible;
    }
    .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .welcome-bgvideo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: saturate(1.1) contrast(1.05) brightness(0.9); }
    .welcome-overlay { position: relative; z-index: 2; text-align: center; color: #fff; padding: 20px; }
    .welcome-title { font-weight: 900; font-size: 34px; letter-spacing: 1px; text-shadow: 3px 3px 0 rgba(0,0,0,0.18); animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2); }
    .welcome-subtitle { margin-top: 8px; font-size: 16px; opacity: .95; text-shadow: 2px 2px 0 rgba(0,0,0,0.12); animation: fadeIn .8s ease .2s both; }
    .welcome-cta {
      margin-top: 18px; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 999px;
      background: rgba(255,255,255,0.18); color: #fff; font-weight: 800; border: 1px solid rgba(255,255,255,0.35);
      backdrop-filter: blur(6px); cursor: pointer; transition: transform .12s ease;
    }
    .welcome-cta:active { transform: translateY(1px) scale(0.99); }
    .welcome-skip { position: absolute; right: 12px; top: 12px; z-index: 3; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.25); color: #fff; font-size: 12px; font-weight: 700; cursor: pointer; backdrop-filter: blur(3px); }

    @keyframes titlePop { 0% { transform: translateY(6px) scale(.92); opacity: 0; } 60% { transform: translateY(-2px) scale(1.02); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }

    /* Main Styles */
    h1 { color: var(--rabbit-red); font-size: 26px; margin: 10px 0 25px; text-shadow: 2px 2px 0px #ffe3e3; font-weight: 900; position: relative; display: inline-block; }
    h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
    h1::before { content: "ğŸµ"; position: absolute; left: -25px; top: 10px; font-size: 20px; animation: bounce 2s infinite reverse; }

    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }
    
    select {
      width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px; font-size: 16px; background: #fafafa;
      outline: none; transition: 0.3s; color: #555; font-weight: bold; -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat; background-position: right 15px center; background-size: 18px;
    }
    select:focus { border-color: var(--pear-yellow); background-color: #fff; }

    .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 25px; font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px; box-shadow: var(--shadow-3d); position: relative; overflow: hidden; transition: all 0.2s; }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; color: #fff; }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); animation: pulse 1.5s infinite; position: relative; z-index: 1002; }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }
    .btn-download { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); text-decoration: none; flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1); font-size: 18px; padding: 16px; border: none; }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; outline: none; border: 4px solid #fff; object-fit: contain; }
    
    body.recording-mode video::-webkit-media-controls { display: none !important; }
    body.recording-mode video::-webkit-media-controls-enclosure { display: none !important; }

    #processCanvas { display: none; }
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }
    .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
    .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; }

    /* Recording Mode */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container { max-width: 100%; height: 100vh; border-radius: 0; border: none; padding: calc(env(safe-area-inset-top, 0px) + 8px) 10px calc(env(safe-area-inset-bottom, 0px) + 80px); display: flex; flex-direction: column; align-items: center; background: #000; }
    @supports (height: 100dvh) { body.recording-mode .container { height: 100dvh; } }
    body.recording-mode .step-label, body.recording-mode select, body.recording-mode #searchBtn, body.recording-mode #playBtn, body.recording-mode .tip, body.recording-mode .status-text, body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container { margin: 0; width: 100%; display: flex; flex: 1; flex-direction: column; align-items: center; justify-content: center; background: #000; }
    body.recording-mode #mainVideo { width: 100%; height: auto; max-height: 100%; border: none; box-shadow: none; }
    body.recording-mode #actionBtn { display: none; }

    .record-overlay { position: absolute; top: 8px; right: 8px; display: none; gap: 6px; z-index: 999; }
    .record-overlay .btn { padding: 6px 10px; border-radius: 6px; font-size: 12px; border: none; }
    .record-overlay .pause { background: #6c7dff; color: white; }

    .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px); }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Overlays */
    .overlay-fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 142, 142, 0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box; }
    .countdown-number { font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1); font-family: "Arial Rounded MT Bold", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; line-height: 1.4; }
    .progress-container { width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px; }
    .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    /* å½©è›‹ */
    #eggOverlay { background: rgba(0,0,0,0.9); z-index: 100001; }
    .monster-gift { font-size: 60px; animation: jumpHappy 1s infinite alternate; }
    @keyframes jumpHappy { 0% { transform: translateY(0) rotate(-10deg); } 100% { transform: translateY(-20px) rotate(10deg); } }
  </style>
</head>
<body class="welcome-active">
  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen">
    <button class="welcome-skip" id="welcomeSkipBtn">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop>
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic</div>
      <div class="welcome-subtitle">é…éŸ³ç§€ (MP4 Proç‰ˆ)</div>
      <button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button>
    </div>
  </div>

  <!-- å€’è®¡æ—¶ -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
  </div>

  <!-- è½¬ç ç­‰å¾…é®ç½© (é‡ç‚¹ä¿®æ”¹) -->
  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(30, 30, 30, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text" style="color: #FFD700; margin-bottom: 10px;">
      æ­£åœ¨è½¬ç ä¸º MP4<br>
      <span style="font-size:16px; color:#fff; font-weight:normal;">(Converting to MP4 Format)</span>
    </div>
    
    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0; max-width: 90%;">
      <div style="color: #ff6b6b; font-size: 18px; font-weight: bold;">âš ï¸ å®¶é•¿è¯·æ³¨æ„ / Parents</div>
      <div style="color: #fff; font-size: 14px; margin-top: 5px; line-height: 1.5;">
        ä¸ºäº†ç”Ÿæˆé€šç”¨çš„ MP4 æ ¼å¼ï¼Œ<br>
        <span style="color: #F9CA24; font-weight: bold;">éœ€è¦ 1-2 åˆ†é’Ÿçš„å¤„ç†æ—¶é—´ã€‚</span><br>
        è¯·è€å¿ƒç­‰å¾…ï¼Œ<b style="text-decoration: underline;">åƒä¸‡ä¸è¦å…³é—­é¡µé¢ï¼</b>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
    <div id="ffmpeg-log" style="color: #777; font-size: 10px; margin-top: 20px; font-family: monospace;">Initializing...</div>
  </div>

  <!-- æƒé™é”™è¯¯æç¤º -->
  <div id="micAuthErrorOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.85); z-index: 99999;">
    <div style="background: #fff; padding: 30px; border-radius: 20px; max-width: 80%; color: #333;">
      <div style="font-size: 60px;">ğŸš«</div>
      <h3 style="color: #FF5253;">éº¦å…‹é£æƒé™è¢«æ‹’ç»</h3>
      <p>è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£åé‡è¯•ã€‚</p>
      <button class="btn btn-retry" onclick="document.getElementById('micAuthErrorOverlay').style.display='none'">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- å½©è›‹ -->
  <div id="eggOverlay" class="overlay-fullscreen" style="display:none;">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
    <div class="overlay-text" style="color: #FFD700;">æ­å–œä½ å‘ç°å½©è›‹ï¼</div>
    <div style="display: flex; gap: 20px; margin: 20px 0;">
      <div class="monster-gift">ğŸ‘¾</div><div class="monster-gift">ğŸ‘¾</div><div class="monster-gift">ğŸ‘¾</div>
    </div>
    <button class="btn btn-primary" onclick="document.getElementById('eggOverlay').style.display='none'" style="width: 200px;">æ”¶ä¸‹å¥–åŠ±</button>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div class="container">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€ (MP4ç‰ˆ)</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()"><option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option></select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled><option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option></select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <div id="video-container">
      <div id="loaderOverlay" class="loader-overlay"><div class="spinner"></div><div id="loadingText">åŠ è½½ä¸­...</div></div>
      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous">
        <source src="" type="video/mp4">
      </video>
      <div id="recordOverlay" class="record-overlay"><button id="pauseToggleBtn" class="btn pause" onclick="togglePauseDuringRecording()">æš‚åœ</button></div>
      <div class="tip">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°å•¸å«ï¼</div>
      <div class="status-text" id="statusText"></div>
      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>
      <canvas id="processCanvas"></canvas>
    </div>

    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <p style="font-size:12px; color:#999;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>
      <video id="previewVideo" style="width:100%; border-radius:15px; background:#000;" controls playsinline></video>
      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <a id="downloadLink" class="btn btn-download">ğŸ’¾ ä¿å­˜ MP4 è§†é¢‘</a>
      </div>
      <div style="font-size:10px; color:#999; margin-top:15px;">* å·²è½¬æ¢ä¸ºæ ‡å‡† MP4 æ ¼å¼ï¼Œå¯ç›´æ¥åˆ†äº«å¾®ä¿¡ã€‚</div>
    </div>
  </div>

  <script>
    // --- æ ¸å¿ƒåº“å¼•ç”¨ ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    // --- æ•°æ®é…ç½® ---
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4", "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4"],
      "K2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4"],
      "G1A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4"],
      "G3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4"]
      // ... (ä¸ºèŠ‚çœç¯‡å¹…ï¼Œä¿ç•™éƒ¨åˆ†æ•°æ®ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·å¡«å…¥å®Œæ•´æ•°æ®)
    };

    // --- å˜é‡ ---
    let mediaRecorder;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let isRecording = false;
    let animationFrameId = null;
    let isIntroMode = false;
    let introImageObj = null;

    // --- åˆå§‹åŒ– FFmpeg (æ‡’åŠ è½½) ---
    async function initFFmpeg() {
      if (ffmpeg === null) {
        try {
          // ä½¿ç”¨ unpkg CDN åŠ è½½æ ¸å¿ƒ
          ffmpeg = createFFmpeg({
            log: true,
            corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
            progress: ({ ratio }) => {
              // æ›´æ–°è¿›åº¦æ¡
              const percent = Math.floor(ratio * 100);
              if(percent > 0 && percent <= 100) {
                 updateProgressUI(percent);
              }
            }
          });
          await ffmpeg.load();
          console.log("FFmpeg loaded successfully");
        } catch (e) {
          console.error("FFmpeg load failed:", e);
          // å¦‚æœå› ä¸ºè·¨åŸŸéš”ç¦»(COOP)å¤±è´¥ï¼Œåªèƒ½é™çº§
          alert("æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼šæ— æ³•åŠ è½½è½¬ç æ ¸å¿ƒã€‚å°†ä¿å­˜ä¸ºåŸå§‹æ ¼å¼ã€‚");
          ffmpeg = "error"; 
        }
      }
    }

    // --- æ¬¢è¿é¡µé€»è¾‘ ---
    (function setupWelcome() {
      const w = document.getElementById('welcome');
      const v = document.getElementById('welcomeVideo');
      document.getElementById('welcomeEnterBtn').onclick = async () => {
        w.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        v.pause();
        // é¢„åŠ è½½ FFmpegï¼Œæå‰ä¸‹è½½æ ¸å¿ƒæ–‡ä»¶
        setTimeout(initFFmpeg, 500);
        checkMicPermissionAndResumeAudio();
      };
      document.getElementById('welcomeSkipBtn').onclick = () => {
        w.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        setTimeout(initFFmpeg, 500);
      };
    })();

    // --- ä¸‹æ‹‰æ¡†é€»è¾‘ ---
    const levels = Object.keys(videoDatabase);
    levels.forEach(l => {
        let opt = document.createElement("option");
        opt.value = l; opt.text = l;
        document.getElementById("levelSelect").appendChild(opt);
    });
    function updateUnits() {
        const lvl = document.getElementById("levelSelect").value;
        const uSelect = document.getElementById("unitSelect");
        uSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ --</option>';
        uSelect.disabled = true;
        if(lvl && videoDatabase[lvl]) {
            videoDatabase[lvl].forEach((url, i) => {
                if(url) {
                    let opt = document.createElement("option");
                    opt.value = i; opt.text = "Unit " + (i+1);
                    uSelect.appendChild(opt);
                    uSelect.disabled = false;
                }
            });
        }
    }

    // --- è§†é¢‘åŠ è½½é€»è¾‘ ---
    function findVideo() {
        const lvl = document.getElementById("levelSelect").value;
        const idx = document.getElementById("unitSelect").value;
        if(!lvl || idx === "") return alert("è¯·é€‰æ‹©çº§åˆ«å’Œå•å…ƒ");
        
        const url = videoDatabase[lvl][idx];
        document.getElementById("resultArea").style.display = "none";
        document.getElementById("video-container").style.display = "block";
        document.getElementById("loaderOverlay").style.display = "flex";
        
        const v = document.getElementById("mainVideo");
        v.src = url;
        v.load();
        v.oncanplaythrough = () => {
            document.getElementById("loaderOverlay").style.display = "none";
            document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•";
            const canvas = document.getElementById("processCanvas");
            canvas.width = v.videoWidth || 640;
            canvas.height = v.videoHeight || 360;
        };
        v.scrollIntoView({behavior:"smooth"});
    }

    // --- å½•åˆ¶æµç¨‹ ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    async function checkMicPermissionAndResumeAudio() {
        if(!audioCtx) audioCtx = new AudioContext();
        if(audioCtx.state === 'suspended') await audioCtx.resume();
        try {
            if(!micStream) micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true}});
            return true;
        } catch(e) {
            document.getElementById('micAuthErrorOverlay').style.display = 'flex';
            return false;
        }
    }

    function toggleRecording() {
        if(isRecording) stopRecording();
        else prepareRecording();
    }

    async function prepareRecording() {
        const video = document.getElementById("mainVideo");
        if(video.readyState < 2) return alert("è§†é¢‘æœªåŠ è½½");
        if(!(await checkMicPermissionAndResumeAudio())) return;

        // å€’è®¡æ—¶
        const overlay = document.getElementById('countdown-overlay');
        const text = document.getElementById('countdownText');
        overlay.style.display = 'flex';
        let count = 3;
        text.innerText = count;
        const timer = setInterval(() => {
            count--;
            if(count > 0) text.innerText = count;
            else {
                clearInterval(timer);
                text.innerText = "GO!";
                setTimeout(() => {
                    overlay.style.display = 'none';
                    startRecordingActual();
                }, 500);
            }
        }, 1000);
    }

    function startRecordingActual() {
        document.body.classList.add('recording-mode');
        const video = document.getElementById("mainVideo");
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");
        
        // å…¨å±
        if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        
        // æ··åˆéŸ³é¢‘
        const dest = audioCtx.createMediaStreamDestination();
        const micSource = audioCtx.createMediaStreamSource(micStream);
        const micGain = audioCtx.createGain();
        micGain.gain.value = 0; // Introé™éŸ³
        micSource.connect(micGain).connect(dest);
        
        const vidSource = audioCtx.createMediaElementSource(video); // æ³¨æ„ï¼šé‡å¤connectå¯èƒ½æŠ¥é”™ï¼Œå®é™…åº”ç”¨éœ€åˆ¤æ–­
        const vidGain = audioCtx.createGain();
        vidGain.gain.value = 0;
        vidSource.connect(vidGain).connect(dest);
        dest.connect(audioCtx.destination); // ä¸ºäº†å¬åˆ°å£°éŸ³

        canvasStream = canvas.captureStream(30);
        const combined = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...dest.stream.getAudioTracks()
        ]);

        // Chrome ä¼˜å…ˆä½¿ç”¨ WebM
        try {
            mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp8,opus', videoBitsPerSecond: 2500000 });
        } catch(e) {
            mediaRecorder = new MediaRecorder(combined);
        }

        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
        
        // åœæ­¢åçš„å›è°ƒï¼šè§¦å‘è½¬ç 
        mediaRecorder.onstop = () => {
            document.body.classList.remove('recording-mode');
            if(document.exitFullscreen) document.exitFullscreen();
            handleTranscoding(); // å…³é”®ï¼šè¿›å…¥è½¬ç æµç¨‹
            
            // æ¸…ç†
            micSource.disconnect();
            vidSource.disconnect();
            canvasStream.getTracks().forEach(t=>t.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        isIntroMode = true;

        // Introé€»è¾‘
        introImageObj = new Image();
        introImageObj.crossOrigin = "anonymous";
        introImageObj.src = "intro.png"; // ç¡®ä¿æ­¤å›¾ç‰‡å­˜åœ¨æˆ–å¤„ç†é”™è¯¯
        
        document.getElementById("actionBtn").innerText = "â¹ï¸ åœæ­¢å½•åˆ¶ (Stop)";
        document.getElementById("actionBtn").className = "btn btn-stop";
        document.getElementById("recordOverlay").style.display = "flex";

        drawCanvas(video, ctx, canvas);

        // 3ç§’åå¼€å§‹æ’­æ”¾è§†é¢‘
        setTimeout(() => {
            isIntroMode = false;
            micGain.gain.value = 1.5;
            vidGain.gain.value = 1.0;
            video.currentTime = 0;
            video.play();
            video.onended = stopRecording;
        }, 3000);
    }

    function drawCanvas(v, c, canvas) {
        if(!isRecording) return;
        if(isIntroMode) {
            c.fillStyle = "#000"; c.fillRect(0,0,canvas.width,canvas.height);
            if(introImageObj.complete) c.drawImage(introImageObj,0,0,canvas.width,canvas.height);
        } else {
            c.drawImage(v,0,0,canvas.width,canvas.height);
        }
        requestAnimationFrame(() => drawCanvas(v,c,canvas));
    }

    function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        isRecording = false;
        document.getElementById("mainVideo").pause();
        document.getElementById("recordOverlay").style.display = "none";
    }

    function togglePauseDuringRecording() {
        const v = document.getElementById("mainVideo");
        const b = document.getElementById("pauseToggleBtn");
        if(v.paused) { v.play(); b.innerText="æš‚åœ"; } else { v.pause(); b.innerText="ç»§ç»­"; }
    }

    // --- æ ¸å¿ƒï¼šè½¬ç å¤„ç†å‡½æ•° ---
    async function handleTranscoding() {
        const overlay = document.getElementById('processing-overlay');
        const pBar = document.getElementById('progressBar');
        const pText = document.getElementById('progressText');
        const log = document.getElementById('ffmpeg-log');
        
        overlay.style.display = 'flex';
        pBar.style.width = '0%';
        pText.innerText = '0%';
        log.innerText = "Initializing Engine...";

        // 1. ç”Ÿæˆ WebM Blob
        const webmBlob = new Blob(recordedChunks, { type: 'video/webm' });
        
        // å¦‚æœ FFmpeg åŠ è½½å¤±è´¥ï¼Œç›´æ¥è¿”å› WebM
        if (ffmpeg === "error" || !ffmpeg) {
             console.warn("FFmpeg not available, saving as WebM");
             log.innerText = "Transcoder unavailable. Skipping...";
             setTimeout(() => showResult(webmBlob, 'video/webm', '.webm'), 2000);
             return;
        }

        try {
            if(!ffmpeg.isLoaded()) await ffmpeg.load();

            log.innerText = "Writing file to memory...";
            const webmData = await fetchFile(webmBlob);
            ffmpeg.FS('writeFile', 'input.webm', webmData);

            log.innerText = "Converting... (This takes time)";
            
            // æ‰§è¡Œè½¬ç æŒ‡ä»¤
            // -i input.webm: è¾“å…¥
            // -c:v libx264: è§†é¢‘ç¼–ç å™¨ H.264
            // -preset ultrafast: ç‰ºç‰²ä¸€ç‚¹å‹ç¼©ç‡æ¢å–æœ€å¿«é€Ÿåº¦
            // -c:a aac: éŸ³é¢‘ç¼–ç å™¨ AAC
            // output.mp4: è¾“å‡º
            await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', 'output.mp4');

            log.innerText = "Reading output file...";
            const data = ffmpeg.FS('readFile', 'output.mp4');
            
            const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });
            
            // æ¸…ç†å†…å­˜
            ffmpeg.FS('unlink', 'input.webm');
            ffmpeg.FS('unlink', 'output.mp4');

            updateProgressUI(100);
            setTimeout(() => showResult(mp4Blob, 'video/mp4', '.mp4'), 500);

        } catch (err) {
            console.error(err);
            log.innerText = "Error: " + err.message;
            alert("è½¬ç å¤±è´¥ï¼Œå°†ä¿å­˜ä¸ºåŸå§‹æ ¼å¼ã€‚");
            // å¤±è´¥å›é€€
            showResult(webmBlob, 'video/webm', '.webm');
        }
    }

    function updateProgressUI(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = percent + '%';
        if(percent < 30) document.getElementById('ffmpeg-log').innerText = "Analyzing stream...";
        else if(percent < 80) document.getElementById('ffmpeg-log').innerText = "Encoding H.264 (MP4)...";
        else document.getElementById('ffmpeg-log').innerText = "Finalizing...";
    }

    function showResult(blob, type, ext) {
        document.getElementById('processing-overlay').style.display = 'none';
        
        const url = URL.createObjectURL(blob);
        const preview = document.getElementById("previewVideo");
        preview.src = url;

        const dl = document.getElementById("downloadLink");
        dl.href = url;
        // ä½¿ç”¨æ—¶é—´æˆ³å‘½å
        const date = new Date();
        const timeStr = `${date.getMonth()+1}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
        dl.download = `Firstleap_Voice_${timeStr}${ext}`;
        
        document.getElementById("actionBtn").style.display = "none";
        document.getElementById("resultArea").style.display = "block";
        document.getElementById("resultArea").scrollIntoView({behavior:"smooth"});
        document.getElementById("statusText").innerText = "ğŸ‰ åˆ¶ä½œæˆåŠŸï¼";
    }

    function resetRecording() {
        document.getElementById("resultArea").style.display = "none";
        const btn = document.getElementById("actionBtn");
        btn.style.display = "block";
        btn.className = "btn btn-record";
        btn.innerText = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
        document.getElementById("statusText").innerText = "";
        document.getElementById("mainVideo").controls = true;
    }

    function togglePreview() {
        const v = document.getElementById("mainVideo");
        if(v.paused) { v.volume=1; v.play(); } else v.pause();
    }

    // å½©è›‹
    let eggClick = 0;
    document.querySelector('h1').addEventListener('click', () => {
        eggClick++;
        if(eggClick===3) { document.getElementById('eggOverlay').style.display='flex'; eggClick=0; }
        setTimeout(()=>eggClick=0, 2000);
    });
  </script>
</body>
</html>
