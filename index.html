<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Firstleap Voice Magic - å®‰å“ä¿®å¤ç‰ˆ</title>
  <style>
    /* ä¿æŒåŸæœ‰ç²¾ç¾æ ·å¼ï¼Œåªé’ˆå¯¹åŠŸèƒ½åšå¾®è°ƒ */
    :root { --bg-cream: #F9F6E8; --rabbit-red: #EE5253; --text-dark: #2d3436; }
    body {
      font-family: "Chalkboard SE", sans-serif;
      background-color: var(--bg-cream);
      margin: 0; padding: 20px 10px; text-align: center; color: var(--text-dark);
      touch-action: manipulation; /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
    }
    .container {
      background: #fff; padding: 20px; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto;
    }
    
    /* è§†é¢‘åŒºåŸŸ */
    #video-wrapper { position: relative; margin-top: 20px; display: none; background: #000; border-radius: 15px; overflow: hidden; }
    /* æ ¸å¿ƒï¼šéšè—çœŸå®çš„ Videoï¼Œåªæ˜¾ç¤º Canvasï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯å½•è¿›å»çš„ */
    video.source-video { 
      position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; 
    }
    canvas#mainCanvas {
      width: 100%; height: auto; display: block; background: #000; border-radius: 15px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      width: 100%; padding: 15px; border: none; border-radius: 25px;
      font-size: 18px; font-weight: bold; color: white; margin-top: 15px; cursor: pointer;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: #EE5253; }
    .btn-record { background: linear-gradient(to right, #ff9966, #ff5e62); display: none; }
    .btn-stop { background: #333; animation: pulse 2s infinite; display: none; }
    .btn-dl { background: #00b894; text-decoration: none; display: inline-block; box-sizing: border-box;}

    /* çŠ¶æ€ä¸ä¸‹æ‹‰æ¡† */
    select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; }
    .status-bar { margin: 10px 0; height: 20px; color: #666; font-size: 14px; font-weight: bold; }
    
    /* ç»“æœé¡µ */
    #resultArea { display: none; margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 15px; }
    
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); } }
  </style>
</head>
<body>

<div class="container">
  <h2 style="color: var(--rabbit-red); margin-top:0;">Firstleap é…éŸ³ç§€ ğŸ™ï¸</h2>

  <!-- é€‰è¯¾åŒºåŸŸ -->
  <div id="selectionArea">
    <select id="levelSelect" onchange="updateUnits()"><option value="">é€‰æ‹©çº§åˆ« (Level)</option></select>
    <select id="unitSelect" disabled><option value="">å…ˆé€‰æ‹©çº§åˆ«</option></select>
    <button class="btn btn-primary" onclick="loadVideo()">ğŸ¬ ç¬¬ä¸€æ­¥ï¼šåŠ è½½è§†é¢‘</button>
  </div>

  <!-- å½•åˆ¶åŒºåŸŸ -->
  <div id="video-wrapper">
    <!-- è¿™æ˜¯ä¸€ä¸ªéšè—çš„ videoï¼Œä½œä¸ºç´ ææº -->
    <!-- crossorigin="anonymous" æ˜¯è§£å†³é»‘å±çš„å…³é”® -->
    <video id="sourceVideo" class="source-video" playsinline webkit-playsinline x5-playsinline crossOrigin="anonymous"></video>
    
    <!-- ç”¨æˆ·çœŸæ­£çœ‹åˆ°å’Œå½•åˆ¶çš„æ˜¯è¿™ä¸ª Canvas -->
    <canvas id="mainCanvas"></canvas>
    
    <div class="status-bar" id="statusText">ç­‰å¾…åŠ è½½...</div>
  </div>

  <button id="recordBtn" class="btn btn-record" onclick="startEverything()">ğŸ”´ å¼€å§‹å½•éŸ³ (Start)</button>
  <button id="stopBtn" class="btn btn-stop" onclick="stopEverything()">â¹ï¸ å®Œæˆ (Stop)</button>

  <!-- ç»“æœä¸ä¸‹è½½ -->
  <div id="resultArea">
    <h3>ğŸ‰ å½•åˆ¶å®Œæˆï¼</h3>
    <video id="previewResult" style="width:100%; background:#000; border-radius:10px;" controls playsinline></video>
    <a id="dlBtn" class="btn btn-dl">ğŸ’¾ ä¿å­˜è§†é¢‘ (Save)</a>
    <button class="btn" style="background:#999; margin-top:10px;" onclick="location.reload()">ğŸ”„ å†å½•ä¸€æ¬¡</button>
    <p style="font-size:12px; color:#666; margin-top:10px;">å®‰å“æç¤ºï¼šä¿å­˜çš„æ–‡ä»¶ä¸º WebM æ ¼å¼ï¼Œå¦‚æœç›¸å†Œä¸æ˜¾ç¤ºï¼Œè¯·åœ¨â€œæ–‡ä»¶ç®¡ç†â€ä¸­æŸ¥çœ‹æˆ–å‘ç»™å¾®ä¿¡æœ‹å‹ã€‚</p>
  </div>
</div>

<script>
  // --- 1. æ•°æ®é…ç½® ---
  // (ä¸ºèŠ‚çœç¯‡å¹…ï¼Œä»…ä¿ç•™éƒ¨åˆ†æ•°æ®ç¤ºä¾‹ï¼Œé€»è¾‘é€šç”¨)
  const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4"],
      "G1A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4"]
  };
  
  // å¡«å……ä¸‹æ‹‰æ¡†
  const lvlSel = document.getElementById('levelSelect');
  Object.keys(videoDatabase).forEach(k => {
    let opt = document.createElement('option'); opt.value = k; opt.innerText = k; lvlSel.appendChild(opt);
  });
  
  function updateUnits() {
    const uSel = document.getElementById('unitSelect');
    uSel.innerHTML = '<option value="">é€‰æ‹©å•å…ƒ</option>';
    const units = videoDatabase[lvlSel.value];
    if(units) {
      uSel.disabled = false;
      units.forEach((url, i) => {
        let opt = document.createElement('option'); opt.value = url; opt.innerText = `Unit ${i+1}`; uSel.appendChild(opt);
      });
    }
  }

  // --- 2. å…¨å±€å˜é‡ ---
  let audioCtx, dest, micStream, recorder;
  let chunks = [];
  let drawTimer = null;
  let isRecording = false;
  
  const video = document.getElementById('sourceVideo');
  const canvas = document.getElementById('mainCanvas');
  const ctx = canvas.getContext('2d');
  const status = document.getElementById('statusText');

  // --- 3. æ ¸å¿ƒï¼šåŠ è½½è§†é¢‘ä¸ Canvas å‡†å¤‡ ---
  function loadVideo() {
    const url = document.getElementById('unitSelect').value;
    if(!url) return alert("è¯·å…ˆé€‰æ‹©è§†é¢‘ï¼");

    status.innerText = "æ­£åœ¨ç¼“å†²è§†é¢‘...";
    document.getElementById('video-wrapper').style.display = 'block';
    document.getElementById('selectionArea').style.display = 'none';

    // å…³é”®ï¼šè§£å†³ CORSï¼Œå¦åˆ™ Canvas å˜é»‘
    video.crossOrigin = "anonymous"; 
    video.src = url;
    video.load();

    video.onloadedmetadata = () => {
      // è®¾ç½® Canvas å°ºå¯¸åŒ¹é…è§†é¢‘
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      // ç»˜åˆ¶ç¬¬ä¸€å¸§å°é¢
      video.currentTime = 0.1; 
    };

    video.oncanplay = () => {
      status.innerText = "âœ… è§†é¢‘å°±ç»ªï¼Œè¯·ç‚¹å‡»å¼€å§‹å½•éŸ³";
      document.getElementById('recordBtn').style.display = 'block';
      // ç»˜åˆ¶ä¸€å¸§é¢„è§ˆ
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    };
    
    video.onerror = () => {
      alert("è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜æˆ–ç½‘ç»œé—®é¢˜ã€‚");
      location.reload();
    };
  }

  // --- 4. æ ¸å¿ƒï¼šç»˜åˆ¶å¾ªç¯ (è§£å†³é»‘å±çš„å…³é”®) ---
  // ä¸ä½¿ç”¨ captureStream(fps)ï¼Œè€Œæ˜¯æ‰‹åŠ¨æ¨æµ
  function startDrawLoop() {
    const loop = () => {
      if (!isRecording) return;
      
      // æ— è®ºè§†é¢‘æ˜¯å¦æ’­æ”¾ï¼Œéƒ½å¼ºåˆ¶ç»˜åˆ¶
      // å¦‚æœè§†é¢‘æ²¡å‡†å¤‡å¥½ï¼Œå°±ç”»é»‘è‰²èƒŒæ™¯
      if (video.readyState >= 2) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      } else {
        // è§†é¢‘ç¼“å†²æ—¶ä¿æŒç”»é¢æˆ–é»‘å±ï¼Œé˜²æ­¢æµæ–­å¼€
        // ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
      }
      
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  // --- 5. æ ¸å¿ƒï¼šå¯åŠ¨å½•åˆ¶æµç¨‹ ---
  async function startEverything() {
    try {
      // 1. åˆå§‹åŒ– AudioContext (å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ä¸­)
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') await audioCtx.resume();

      // 2. è·å–éº¦å…‹é£
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true }
      });

      // 3. æ„å»ºéŸ³é¢‘å›¾è°± (æ··åˆ éº¦å…‹é£ + è§†é¢‘åŸå£°)
      dest = audioCtx.createMediaStreamDestination();
      
      const micSource = audioCtx.createMediaStreamSource(micStream);
      const videoSource = audioCtx.createMediaElementSource(video); // è·å–è§†é¢‘å£°éŸ³
      
      const micGain = audioCtx.createGain(); micGain.gain.value = 1.2; // éº¦å…‹é£éŸ³é‡
      const videoGain = audioCtx.createGain(); videoGain.gain.value = 0.6; // èƒŒæ™¯éŸ³é‡

      micSource.connect(micGain).connect(dest);
      videoSource.connect(videoGain).connect(dest);
      
      // åŒæ—¶ä¹Ÿè®©ç”¨æˆ·å¬åˆ°è§†é¢‘å£°éŸ³
      videoGain.connect(audioCtx.destination);

      // 4. å‡†å¤‡ Canvas æµ (30fps)
      // Android Chrome ä¸Šï¼ŒcaptureStream å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´åˆå§‹åŒ–
      const canvasStream = canvas.captureStream(30);
      
      // 5. åˆå¹¶éŸ³è§†é¢‘æµ
      const finalStream = new MediaStream([
        ...canvasStream.getVideoTracks(),
        ...dest.stream.getAudioTracks()
      ]);

      // 6. å½•åˆ¶å™¨é…ç½® (å¼ºåˆ¶ä½¿ç”¨ WebMï¼Œå…¼å®¹æ€§æœ€å¥½)
      // æ³¨æ„ï¼šä¸è¦å¼ºåˆ¶ mp4ï¼ŒAndroid æµè§ˆå™¨å¯¹ mp4 å†™å…¥æ”¯æŒå¾ˆå·®
      let options = { mimeType: 'video/webm;codecs=vp8,opus' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options = { mimeType: 'video/webm' }; // å›é€€åˆ°é»˜è®¤
      }

      recorder = new MediaRecorder(finalStream, options);
      chunks = [];
      recorder.ondataavailable = e => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      recorder.onstop = saveVideo;

      // 7. å¯åŠ¨é¡ºåºè‡³å…³é‡è¦ï¼
      isRecording = true;
      startDrawLoop(); // å…ˆè®© Canvas åŠ¨èµ·æ¥
      recorder.start(100); // 100ms åˆ‡ç‰‡ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
      
      // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ’­æ”¾è§†é¢‘ï¼Œç¡®ä¿ recorder å·²ç» ready
      setTimeout(() => {
        video.currentTime = 0;
        video.play().then(() => {
          status.innerText = "ğŸ™ï¸ å½•åˆ¶ä¸­... (è¯·å¤§å£°æœ—è¯»)";
        }).catch(e => {
          console.error(e);
          alert("æ— æ³•è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·æ£€æŸ¥æƒé™");
        });
      }, 200);

      // UI åˆ‡æ¢
      document.getElementById('recordBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = 'block';

      // è§†é¢‘æ’­æ”¾ç»“æŸè‡ªåŠ¨åœæ­¢
      video.onended = () => {
        if(isRecording) stopEverything();
      };

    } catch (err) {
      console.error(err);
      alert("å¯åŠ¨å¤±è´¥: " + err.message + "\nè¯·æ£€æŸ¥éº¦å…‹é£æƒé™æˆ–ä½¿ç”¨ Chrome æµè§ˆå™¨ã€‚");
    }
  }

  // --- 6. åœæ­¢ä¸ä¿å­˜ ---
  function stopEverything() {
    if(!isRecording) return;
    isRecording = false;
    
    status.innerText = "æ­£åœ¨å¤„ç†è§†é¢‘...";
    video.pause();
    
    // åœæ­¢å½•åˆ¶å™¨
    if(recorder && recorder.state !== 'inactive') {
      recorder.stop();
    }
    
    // æ¸…ç†èµ„æº
    if(micStream) micStream.getTracks().forEach(t => t.stop());
    // if(audioCtx) audioCtx.close(); // å¯é€‰ï¼šå…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
  }

  function saveVideo() {
    // å¼ºåˆ¶ä½¿ç”¨ webm ç±»å‹ï¼Œè¿™æ˜¯ Android æœ€åŸç”Ÿçš„æ ¼å¼
    const blob = new Blob(chunks, { type: 'video/webm' });
    
    if (blob.size < 1000) {
      alert("å½•åˆ¶å¤±è´¥ï¼šæ–‡ä»¶è¿‡å°ï¼ˆå¯èƒ½æ˜¯é»‘å±é—®é¢˜ï¼‰ã€‚è¯·ç¡®ä¿è§†é¢‘æœåŠ¡å™¨å…è®¸ CORSã€‚");
      return;
    }

    const videoUrl = URL.createObjectURL(blob);
    
    // æ˜¾ç¤ºç»“æœ
    document.getElementById('video-wrapper').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('resultArea').style.display = 'block';
    
    const preview = document.getElementById('previewResult');
    preview.src = videoUrl;
    
    const dlBtn = document.getElementById('dlBtn');
    dlBtn.href = videoUrl;
    // ä½¿ç”¨ .webm åç¼€ï¼Œä¸è¦ç”¨ .mp4ï¼Œå¦åˆ™ç›¸å†Œè¯†åˆ«ä¸äº†
    dlBtn.download = 'my_dubbing_' + Date.now() + '.webm'; 
  }

</script>
</body>
</html>
