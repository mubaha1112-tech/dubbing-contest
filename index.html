<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic (Pro Edition)</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0; padding: 20px 10px; text-align: center; color: var(--text-dark);
    }

    .container {
      background: var(--card-white); padding: 25px 20px; border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px; margin: 0 auto; position: relative; border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* === å…¨æ–°è®¾è®¡çš„å¯çˆ±å¼•å¯¼è¦†ç›–å±‚ === */
    .cute-overlay {
      position: fixed; inset: 0; z-index: 999999;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.92); backdrop-filter: blur(8px);
      flex-direction: column; color: white; padding: 20px;
      text-align: center;
    }
    .cute-overlay.show { display: flex; }
    
    .cute-mascot {
      font-size: 80px; margin-bottom: 20px;
      animation: mascotBounce 1.2s ease-in-out infinite;
    }
    @keyframes mascotBounce {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }

    .cute-title {
      font-size: 24px; font-weight: 900; margin-bottom: 10px;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    .cute-message {
      font-size: 16px; opacity: 0.9; line-height: 1.6; max-width: 90%;
      margin-bottom: 25px;
    }

    .cute-progress {
      width: 85%; max-width: 320px; height: 14px;
      background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden;
      margin: 15px 0; position: relative;
    }
    .cute-progress-bar {
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--pear-yellow), var(--monster-green));
      border-radius: 8px; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cute-progress-text {
      font-size: 18px; font-weight: bold; color: var(--pear-yellow);
      margin-top: 8px;
    }

    .cute-hint-box {
      background: rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 15px;
      font-size: 14px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.2);
    }

    /* æ¬¢è¿é¡µ */
    .welcome-screen {
      position: fixed; inset: 0; z-index: 100000;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
      overflow: hidden; opacity: 1; transition: opacity .6s ease, visibility .6s ease;
      visibility: visible;
    }
    .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .welcome-bgvideo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: saturate(1.1) contrast(1.05) brightness(0.9); }
    .welcome-overlay { position: relative; z-index: 2; text-align: center; color: #fff; padding: 20px; }
    .welcome-title { font-weight: 900; font-size: 34px; letter-spacing: 1px; text-shadow: 3px 3px 0 rgba(0,0,0,0.18); animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2); }
    .welcome-subtitle { margin-top: 8px; font-size: 16px; opacity: .95; text-shadow: 2px 2px 0 rgba(0,0,0,0.12); animation: fadeIn .8s ease .2s both; }
    .welcome-cta { margin-top: 18px; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 999px; background: rgba(255,255,255,0.18); color: #fff; font-weight: 800; border: 1px solid rgba(255,255,255,0.35); backdrop-filter: blur(6px); cursor: pointer; user-select: none; transition: transform .12s ease, background .2s ease; animation: fadeIn .8s ease .35s both; }
    .welcome-skip { position: absolute; right: 12px; top: 12px; z-index: 3; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.25); color: #fff; font-size: 12px; font-weight: 700; cursor: pointer; backdrop-filter: blur(3px); }
    .confetti { position: absolute; bottom: -20px; width: 8px; height: 14px; border-radius: 3px; opacity: .9; animation-name: riseSpin; animation-timing-function: linear; animation-iteration-count: infinite; }

    @keyframes titlePop { 0% { transform: translateY(6px) scale(.92); opacity: 0; } 60% { transform: translateY(-2px) scale(1.02); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    @keyframes riseSpin { 0% { transform: translateY(0) rotate(0deg); opacity: .0; } 10% { opacity: .9; } 100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; } }

    h1 {
      color: var(--rabbit-red); font-size: 26px; margin: 10px 0 25px;
      text-shadow: 2px 2px 0px #ffe3e3; font-weight: 900; letter-spacing: 1px;
      position: relative; display: inline-block;
    }
    h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
    h1::before { content: "ğŸµ"; position: absolute; left: -25px; top: 10px; font-size: 20px; animation: bounce 2s infinite reverse; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }
    select { width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px; font-size: 16px; background: #fafafa; outline: none; transition: 0.3s; color: #555; font-weight: bold; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 18px; }
    select:focus { border-color: var(--pear-yellow); background-color: #fff; }

    .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 25px; font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px; transition: all 0.2s; box-shadow: var(--shadow-3d); position: relative; overflow: hidden; }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); animation: pulse 1.5s infinite; position: relative; z-index: 1002; }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }
    .btn-share { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); text-decoration: none; line-height: 1.5; flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1); font-size: 18px; padding: 16px; border: none; }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; outline: none; border: 4px solid #fff; object-fit: contain; }
    video:fullscreen { border: none; border-radius: 0; width: 100%; height: 100%; }
    
    /* å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶éšè—å½•åˆ¶æ—¶æ‰€æœ‰è§†é¢‘æ§ä»¶ */
    body.recording-mode video::-webkit-media-controls { display: none !important; }
    body.recording-mode video::-webkit-media-controls-enclosure { display: none !important; }

    #processCanvas { display: none; }
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }

    .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
    .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

    /* å½•åˆ¶ fullscreen æ¨¡å¼ */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container { max-width: 100%; height: 100vh; border-radius: 0; border: none; padding: calc(env(safe-area-inset-top, 0px) + 8px) 10px calc(env(safe-area-inset-bottom, 0px) + 80px); display: flex; flex-direction: column; align-items: center; background: #000; }
    @supports (height: 100svh) { body.recording-mode .container { height: 100svh; } }
    body.recording-mode .step-label, body.recording-mode select, body.recording-mode #searchBtn, body.recording-mode #playBtn, body.recording-mode .tip, body.recording-mode .status-text, body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container { margin: 0; width: 100%; display: flex; flex: 1; flex-direction: column; align-items: center; justify-content: center; background: #000; }
    body.recording-mode #mainVideo { width: 100%; height: auto; max-height: 100%; border: none; box-shadow: none; }
    body.recording-mode #actionBtn { display: none; }

    .record-overlay { position: absolute; top: 8px; right: 8px; display: none; gap: 6px; z-index: 999; pointer-events: auto; }
    .record-overlay .btn { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 800; cursor: pointer; border: none; }
    .record-overlay .pause { background: #6c7dff; color: white; }

    .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px); }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* å€’è®¡æ—¶ & è¿›åº¦æ¡ */
    .overlay-fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 142, 142, 0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box; }
    .countdown-number { font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1); font-family: "Arial Rounded MT Bold", "Comic Sans MS", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
    .progress-container { width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px; }
    .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    /* å½©è›‹ */
    .monster-gift { font-size: 60px; animation: jumpHappy 1s infinite alternate; }
    @keyframes jumpHappy { 0% { transform: translateY(0) rotate(-10deg); } 100% { transform: translateY(-20px) rotate(10deg); } }
  </style>
</head>
<body class="welcome-active">

  <!-- === å…¨æ–°å¯çˆ±çš„å¼•å¯¼è¦†ç›–å±‚ === -->
  <div id="cuteGuideOverlay" class="cute-overlay">
    <div class="cute-mascot">ğŸ¬</div>
    <div class="cute-title" id="cuteTitle">æ­£åœ¨å‡†å¤‡é­”æ³•...</div>
    <div class="cute-message" id="cuteMessage">è¯·ç¨ç­‰ï¼Œå°ç²¾çµæ­£åœ¨åŠ è½½è§†é¢‘</div>
    <div class="cute-progress">
      <div class="cute-progress-bar" id="cuteProgressBar"></div>
    </div>
    <div class="cute-progress-text" id="cuteProgressText">0%</div>
    <div class="cute-hint-box" id="cuteHintBox">
      ğŸ’¡ æç¤ºï¼šè¯·ä½©æˆ´è€³æœºï¼Œé¿å…å›å£°å“¦ï¼
    </div>
  </div>

  <!-- === å¾®ä¿¡ä¿å­˜æç¤ºè¦†ç›–å±‚ === -->
  <div id="wxSaveOverlay" class="cute-overlay" style="background: rgba(0,0,0,0.95);">
    <div class="cute-mascot" style="animation: none;">ğŸ“±</div>
    <div class="cute-title">å¾®ä¿¡ä¿å­˜æŒ‡å—</div>
    <div class="cute-message">
      åœ¨å¾®ä¿¡ä¸­ï¼Œè¯·é•¿æŒ‰ä¸‹æ–¹è§†é¢‘ â†’ é€‰æ‹© <b>"ä¿å­˜è§†é¢‘åˆ°æ‰‹æœº"</b><br>
      æˆ–ç‚¹å‡»å³ä¸Šè§’"..." â†’ é€‰æ‹©"åœ¨æµè§ˆå™¨æ‰“å¼€"å†ä¿å­˜
    </div>
    <video id="wxDemoVideo" style="width: 85%; max-width: 400px; border-radius: 15px; margin: 15px 0;" controls playsinline></video>
    <button class="btn btn-primary" onclick="closeWxSaveOverlay()" style="width: 200px; background: linear-gradient(135deg, #4facfe, #00f2fe);">æˆ‘çŸ¥é“äº†</button>
  </div>

  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen">
    <button class="welcome-skip" id="welcomeSkipBtn">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop preload="auto" x5-video-player-type="h5-page">
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic</div>
      <div class="welcome-subtitle">é…éŸ³ç§€ (Pro Edition) âœ¨</div>
      <div><button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button></div>
    </div>
  </div>

  <!-- å€’è®¡æ—¶ -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
  </div>

  <!-- å¤„ç†ä¸­ -->
  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">è§†é¢‘ç”Ÿæˆä¸­...<br><span style="font-size:16px; opacity:0.8;">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
  </div>

  <!-- å½©è›‹ -->
  <div id="eggOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.9); z-index: 100001;">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
    <div class="overlay-text" style="color: #FFD700; font-size: 28px;">æ­å–œä½ å‘ç°å½©è›‹ï¼</div>
    <div style="display: flex; gap: 20px; margin: 20px 0;">
      <div class="monster-gift">ğŸ‘¾</div>
      <div class="monster-gift" style="animation-delay: 0.1s">ğŸ‘¾</div>
      <div class="monster-gift" style="animation-delay: 0.2s">ğŸ‘¾</div>
    </div>
    <button class="btn btn-primary" onclick="closeEggOverlay()" style="width: 200px; background: linear-gradient(135deg, #FF8E8E, #EE5253);">å¤ªæ£’äº†ï¼æ”¶ä¸‹</button>
  </div>

  <div class="container">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€ (Proç‰ˆ)</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <div id="video-container" style="position: relative; min-height: 200px;">
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">é­”æ³•åŠ è½½ä¸­...</div>
      </div>

      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous" x5-video-player-type="h5-page">
        <source src="" type="video/mp4">
      </video>

      <!-- å½•åˆ¶æ§åˆ¶ -->
      <div id="recordOverlay" class="record-overlay" style="display:none;">
        <button id="pauseToggleBtn" class="btn pause" onclick="togglePauseDuringRecording()">æš‚åœ</button>
      </div>

      <div class="tip" style="margin-top: 6px;">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·ä½©æˆ´è€³æœºï¼Œæ•ˆæœæ›´ä½³ï¼</div>
      <div class="status-text" id="statusText">è¯·é€‰æ‹©çº§åˆ«å’Œå•å…ƒå¼€å§‹</div>

      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>
      <canvas id="processCanvas" style="display: none;"></canvas>
    </div>

    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <p style="font-size:12px; color:#999; margin-bottom:15px;">å¬ä¸åˆ°å£°éŸ³ï¼Ÿè¯·æ£€æŸ¥æ‰‹æœºéŸ³é‡é”®å’Œé™éŸ³å¼€å…³</p>
      
      <video id="previewVideo" style="width:100%; border-radius:15px; background:#000;" controls playsinline></video>

      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <button id="shareBtn" class="btn btn-share" style="display: none;" onclick="saveOrShareVideo()">ğŸ’¾ ä¿å­˜/åˆ†äº«è§†é¢‘</button>
      </div>

      <div id="waitingHint" style="text-align: center; margin: 20px 0; display: none;">
        <div class="spinner" style="width: 30px; height: 30px; border-width: 3px; display: inline-block;"></div>
        <span style="color: var(--pear-yellow); font-weight: bold;">è§†é¢‘å°è£…ä¸­...</span>
      </div>
    </div>
  </div>

  <script>
    // === å…¨å±€å˜é‡ ===
    let mediaRecorder = null;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let dest = null;
    let micGainNode = null;
    let videoGainNode = null;
    let isRecording = false;
    let isIntroPhase = false;
    let introImageObj = null;
    let animationFrameId = null;
    let hasMicPermission = false;
    let finalBlob = null;
    let finalObjectURL = '';
    
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ua = navigator.userAgent || '';
    const isWeChat = /MicroMessenger/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isSafari = /Safari/i.test(ua) && !/Chrome/i.test(ua);

    // === å¯çˆ±çš„å¼•å¯¼UIæ§åˆ¶ ===
    const cuteUI = {
      show(mascot, title, message, showProgress = false, hint = '') {
        const overlay = document.getElementById('cuteGuideOverlay');
        document.getElementById('cuteMascot').textContent = mascot;
        document.getElementById('cuteTitle').textContent = title;
        document.getElementById('cuteMessage').textContent = message;
        document.getElementById('cuteHintBox').textContent = hint || 'ğŸ’¡ æç¤ºï¼šè¯·ä½©æˆ´è€³æœºï¼Œé¿å…å›å£°å“¦ï¼';
        
        if (showProgress) {
          document.querySelector('.cute-progress').style.display = 'block';
        } else {
          document.querySelector('.cute-progress').style.display = 'none';
        }
        
        overlay.classList.add('show');
      },
      hide() {
        document.getElementById('cuteGuideOverlay').classList.remove('show');
      },
      updateProgress(percent) {
        document.getElementById('cuteProgressBar').style.width = percent + '%';
        document.getElementById('cuteProgressText').textContent = percent + '%';
      }
    };

    // === æ¬¢è¿é¡µ ===
    (function setupWelcome() {
      const welcome = document.getElementById('welcome');
      const wVideo = document.getElementById('welcomeVideo');
      const skipBtn = document.getElementById('welcomeSkipBtn');
      const enterBtn = document.getElementById('welcomeEnterBtn');

      const colors = ['#fff176', '#ff8a80', '#80d8ff', '#ffd180', '#ea80fc', '#a7ffeb'];
      for (let i = 0; i < 18; i++) {
        const c = document.createElement('div'); c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw'; c.style.background = colors[i % colors.length];
        c.style.width = (6 + Math.floor(Math.random() * 8)) + 'px';
        c.style.height = (10 + Math.floor(Math.random() * 8)) + 'px';
        c.style.animationDuration = (2.2 + Math.random() * 2.2).toFixed(2) + 's';
        c.style.animationDelay = (Math.random() * 0.8).toFixed(2) + 's';
        welcome.appendChild(c);
      }

      const hideWelcome = () => {
        if (welcome.classList.contains('hidden')) return;
        welcome.classList.add('hidden'); document.body.classList.remove('welcome-active');
        try { wVideo.pause(); } catch(e){}
        setTimeout(() => welcome.style.display = 'none', 650);
      };

      enterBtn.addEventListener('click', async () => { await checkMicPermissionAndResumeAudio(); hideWelcome(); });
      skipBtn.addEventListener('click', hideWelcome);
      wVideo.addEventListener('error', hideWelcome, { once: true });
    })();

    // === æ•°æ®åº“ ===
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4","", "", ""],
      "K2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4","", "", ""],
      "K3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4","", "", ""],
      "K3B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4","", "", ""],
      "G0": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"],
      "G1A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"],
      "G1B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"],
      "G2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4",""],
      "G2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4","", "", ""],
      "G3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4","", "", ""],
      "G3B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4","", "", "", "", ""],
      "G4A": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4","", "", ""],
      "G4B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4","", "", ""]
    };

    // === åˆå§‹åŒ–éŸ³é¢‘ ===
    function initializeAudioContext() {
      if (!audioCtx || audioCtx.state === 'closed') audioCtx = new AudioContext();
    }

    async function checkMicPermissionAndResumeAudio() {
      initializeAudioContext();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      
      if (hasMicPermission && micStream) return true;
      
      try {
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });
        hasMicPermission = true;
        return true;
      } catch (err) {
        hasMicPermission = false;
        cuteUI.show('ğŸ¤', 'éº¦å…‹é£éœ€è¦æˆæƒ', 'è¯·ç‚¹å‡»"å…è®¸"ä»¥ä¾¿å½•åˆ¶æ‚¨çš„å£°éŸ³', false, 'ğŸ’¡ å¦‚æœä¸å°å¿ƒæ‹’ç»äº†ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°æˆæƒ');
        setTimeout(() => cuteUI.hide(), 3000);
        return false;
      }
    }

    // === åˆå§‹åŒ–ä¸‹æ‹‰æ¡† ===
    const levels = Object.keys(videoDatabase);
    const levelSelect = document.getElementById("levelSelect");
    levels.forEach(lvl => {
      const option = document.createElement("option");
      option.value = lvl; option.text = lvl;
      levelSelect.appendChild(option);
    });

    function updateUnits() {
      const lvl = document.getElementById("levelSelect").value;
      const unitSelect = document.getElementById("unitSelect");
      unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
      unitSelect.disabled = true;
      
      if (lvl && videoDatabase[lvl]) {
        let hasUnits = false;
        for (let i = 0; i < videoDatabase[lvl].length; i++) {
          if (videoDatabase[lvl][i]) {
            const option = document.createElement("option");
            option.value = i; option.text = "Unit " + (i + 1);
            unitSelect.appendChild(option); hasUnits = true;
          }
        }
        if(hasUnits) unitSelect.disabled = false;
      }
    }

    // === æŸ¥æ‰¾è§†é¢‘ ===
    async function findVideo() {
      const lvl = document.getElementById("levelSelect").value;
      const unitIndex = document.getElementById("unitSelect").value;
      if (!lvl || unitIndex === "") {
        cuteUI.show('ğŸ¤”', 'è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒ', 'å°ç²¾çµéœ€è¦çŸ¥é“æ‚¨æƒ³ç»ƒä¹ å“ªä¸ªè§†é¢‘å“¦ï¼', false);
        setTimeout(() => cuteUI.hide(), 2000);
        return;
      }

      cuteUI.show('ğŸ“¹', 'æ­£åœ¨åŠ è½½è§†é¢‘', 'è¯·ç¨å€™ï¼Œå°ç²¾çµæ­£åœ¨å‡†å¤‡ç´ æ...', true);
      
      const url = videoDatabase[lvl][unitIndex];
      resetUIForNewVideo();
      
      const videoPlayer = document.getElementById("mainVideo");
      const loader = document.getElementById("loaderOverlay");
      const actionBtn = document.getElementById("actionBtn");
      const playBtn = document.getElementById("playBtn");
      
      videoPlayer.src = url;
      videoPlayer.load();
      videoPlayer.volume = 1.0;
      videoPlayer.controls = true;

      let loadProgress = 0;
      const progressInterval = setInterval(() => {
        loadProgress = Math.min(90, loadProgress + 10);
        cuteUI.updateProgress(loadProgress);
      }, 200);

      videoPlayer.oncanplaythrough = function() {
        clearInterval(progressInterval);
        cuteUI.updateProgress(100);
        setTimeout(() => cuteUI.hide(), 300);
        
        loader.style.display = "none";
        actionBtn.style.display = "block";
        playBtn.style.display = "block";
        document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•ï¼Œå‡†å¤‡é…éŸ³ï¼";
        
        const canvas = document.getElementById("processCanvas");
        canvas.width = videoPlayer.videoWidth || 640;
        canvas.height = videoPlayer.videoHeight || 360;
      };

      videoPlayer.onerror = function() {
        clearInterval(progressInterval);
        cuteUI.show('ğŸ˜¢', 'è§†é¢‘åŠ è½½å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–å°è¯•å…¶ä»–è§†é¢‘', false);
        setTimeout(() => cuteUI.hide(), 3000);
      };

      document.getElementById("video-container").style.display = "block";
      document.getElementById("video-container").scrollIntoView({behavior: "smooth"});
    }

    function resetUIForNewVideo() {
      document.getElementById("resultArea").style.display = "none";
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.style.display = "none";
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      document.getElementById("playBtn").style.display = "none";
      document.getElementById("video-container").style.display = "block";
      document.getElementById("loaderOverlay").style.display = "flex";
      document.getElementById("statusText").innerText = "ğŸ¬ æ­£åœ¨åŠ è½½è§†é¢‘...";
    }

    function togglePreview() {
      const video = document.getElementById("mainVideo");
      if (video.paused) { video.volume = 1.0; video.muted = false; video.play(); } 
      else { video.pause(); }
    }

    function resetRecording() {
      document.getElementById("resultArea").style.display = "none";
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.style.display = "block";
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      actionBtn.disabled = false;
      document.getElementById("playBtn").style.display = "block";
      document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®ï¼Œè¯·é‡æ–°å¼€å§‹é…éŸ³";
      
      const mainVideo = document.getElementById("mainVideo");
      mainVideo.currentTime = 0;
      mainVideo.pause();
      mainVideo.controls = true;

      const preview = document.getElementById("previewVideo");
      if(preview.src) URL.revokeObjectURL(preview.src);
      preview.src = "";
      
      if (finalObjectURL) {
        URL.revokeObjectURL(finalObjectURL);
        finalObjectURL = '';
      }
      finalBlob = null;
      
      document.getElementById("video-container").scrollIntoView({behavior: "smooth"});
      document.getElementById('recordOverlay').style.display = 'none';
    }

    // === è·å–æœ€ä½³MIMEç±»å‹ ===
    function getBestMimeType() {
      const types = ["video/mp4;codecs=avc1", "video/mp4", "video/webm;codecs=vp9", "video/webm"];
      for (const type of types) {
        if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
          console.log("é‡‡ç”¨å½•åˆ¶æ ¼å¼:", type);
          return type;
        }
      }
      return 'video/mp4';
    }

    // === ä¸»å½•åˆ¶é€»è¾‘ ===
    function toggleRecording() {
      if (isRecording) stopRecording();
      else prepareAndStartRecording();
    }

    async function prepareAndStartRecording() {
      const video = document.getElementById("mainVideo");
      if (video.readyState < 2) {
        cuteUI.show('â³', 'è§†é¢‘è¿˜æœªå‡†å¤‡å¥½', 'è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ...', false);
        setTimeout(() => cuteUI.hide(), 2000);
        return;
      }

      const permissionGranted = await checkMicPermissionAndResumeAudio();
      if (!permissionGranted) return;

      // å¼€å§‹3ç§’å€’è®¡æ—¶
      video.controls = false;
      const overlay = document.getElementById('countdown-overlay');
      const text = document.getElementById('countdownText');
      let count = 3;
      overlay.style.display = 'flex';
      
      const countdown = setInterval(() => {
        text.innerText = count;
        if (count > 0) count--;
        else {
          clearInterval(countdown);
          overlay.style.display = 'none';
          enterFullscreenMode();
          // å…³é”®ï¼šå»¶è¿Ÿ100msç¡®ä¿fullscreenç”Ÿæ•ˆå†å¼€å§‹å½•åˆ¶
          setTimeout(() => executeActualRecording(), 100);
        }
      }, 1000);
    }

    async function executeActualRecording() {
      const video = document.getElementById("mainVideo");
      const canvas = document.getElementById("processCanvas");
      const ctx = canvas.getContext("2d");

      // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡æ¿€æ´»
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      
      // è®¾ç½®ç”»å¸ƒå°ºå¯¸
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;

      // å…³é”®ä¿®å¤ï¼šä¸€æ¬¡æ€§æ•è·ç”»å¸ƒæµï¼Œå¹¶è®¾ç½®é«˜å¸§ç‡
      try {
        canvasStream = canvas.captureStream(30); // 30fpsä¿è¯æµç•…
      } catch(e) {
        cuteUI.show('ğŸ˜µ', 'å½•åˆ¶åˆå§‹åŒ–å¤±è´¥', 'æ‚¨çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·æ›´æ–°åé‡è¯•', false);
        setTimeout(() => { cuteUI.hide(); exitFullscreenMode(); }, 3000);
        return;
      }

      // åˆ›å»ºéŸ³é¢‘æ··åˆå›¾
      dest = audioCtx.createMediaStreamDestination();
      micGainNode = audioCtx.createGain();
      videoGainNode = audioCtx.createGain();
      micGainNode.gain.value = 0; // ç‰‡å¤´æœŸé—´é™éŸ³
      videoGainNode.gain.value = 0;

      // è¿æ¥éº¦å…‹é£
      if (micStream && micStream.getAudioTracks().length > 0) {
        sourceMic = audioCtx.createMediaStreamSource(micStream);
        sourceMic.connect(micGainNode).connect(dest);
      }

      // è¿æ¥è§†é¢‘éŸ³é¢‘ï¼ˆå…³é”®ä¿®å¤ï¼šç¡®ä¿videoå…ƒç´ å·²è¿æ¥ï¼‰
      try {
        if (!video._audioSource) {
          video._audioSource = audioCtx.createMediaElementSource(video);
        }
        sourceVideo = video._audioSource;
        sourceVideo.connect(videoGainNode).connect(dest);
        dest.connect(audioCtx.destination); // ç›‘å¬è¾“å‡º
      } catch(e) {
        console.warn("è§†é¢‘éŸ³é¢‘è¿æ¥:", e);
      }

      // ç»„åˆæµ
      const videoTrack = canvasStream.getVideoTracks()[0];
      const audioTrack = dest.stream.getAudioTracks()[0];
      const combinedStream = new MediaStream([videoTrack, audioTrack].filter(t => t));

      // åˆ›å»ºMediaRecorder
      recordedMimeType = getBestMimeType();
      try {
        mediaRecorder = new MediaRecorder(combinedStream, { 
          mimeType: recordedMimeType,
          videoBitsPerSecond: 2500000 // 2.5Mbpsä¿è¯è´¨é‡
        });
      } catch(e) {
        mediaRecorder = new MediaRecorder(combinedStream);
      }

      recordedChunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        finishProcessingOverlayThen(() => generateVideoAndShowResult());
      };

      // UIçŠ¶æ€
      document.getElementById("playBtn").style.display = "none";
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ Stop";
      actionBtn.className = "btn btn-stop";
      document.getElementById('recordOverlay').style.display = 'flex';
      document.getElementById('pauseToggleBtn').textContent = 'æš‚åœ';

      // åŠ è½½ç‰‡å¤´å›¾ç‰‡
      introImageObj = new Image();
      introImageObj.crossOrigin = "anonymous";
      introImageObj.src = "intro.png";

      const startRecordingProcess = () => {
        // å…³é”®ï¼šMediaRecorderå…¨ç¨‹è¿è¡Œï¼Œä¸åˆ†æ®µ
        mediaRecorder.start(1000); // æ¯ç§’è§¦å‘ä¸€æ¬¡dataavailableï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
        
        isRecording = true;
        isIntroPhase = true;
        
        // ç«‹å³å¼€å§‹ç»˜åˆ¶ï¼ˆç‰‡å¤´ï¼‰
        drawCanvas(ctx, canvas, video);
        
        document.getElementById("statusText").innerText = "ğŸ¬ ç‰‡å¤´å½•åˆ¶ä¸­... (3ç§’)";
        
        // 3ç§’ååˆ‡æ¢åˆ°è§†é¢‘
        setTimeout(() => {
          isIntroPhase = false;
          micGainNode.gain.value = 1.5;
          videoGainNode.gain.value = 1.2;
          
          video.currentTime = 0;
          video.volume = 1.0;
          video.controls = false;
          
          video.play().then(() => {
            document.getElementById("statusText").innerText = "ğŸ”´ æ­£åœ¨é…éŸ³ä¸­...";
          }).catch(e => console.warn("è§†é¢‘æ’­æ”¾:", e));
          
          video.onended = () => {
            // è§†é¢‘æ’­æ”¾å®Œè‡ªåŠ¨åœæ­¢å½•åˆ¶
            stopRecording();
          };
        }, 3000);
      };

      introImageObj.onload = startRecordingProcess;
      introImageObj.onerror = () => {
        cuteUI.show('âš ï¸', 'ç‰‡å¤´å›¾ç‰‡åŠ è½½å¤±è´¥', 'è·³è¿‡ç‰‡å¤´ï¼Œç›´æ¥å¼€å§‹å½•åˆ¶...', false);
        isIntroPhase = false;
        setTimeout(() => cuteUI.hide(), 1500);
        startRecordingProcess();
      };
    }

    // === ç”»å¸ƒç»˜åˆ¶å¾ªç¯ï¼ˆå…³é”®ä¿®å¤ï¼‰ ===
    function drawCanvas(ctx, canvas, video) {
      if (!isRecording) {
        cancelAnimationFrame(animationFrameId);
        return;
      }

      try {
        if (isIntroPhase) {
          // ç‰‡å¤´é˜¶æ®µï¼šç»˜åˆ¶é»‘è‰²èƒŒæ™¯å’Œç‰‡å¤´å›¾
          ctx.fillStyle = "#000000";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          if (introImageObj && introImageObj.complete) {
            ctx.drawImage(introImageObj, 0, 0, canvas.width, canvas.height);
          }
        } else {
          // è§†é¢‘é˜¶æ®µï¼šç»˜åˆ¶è§†é¢‘å¸§
          if (video.readyState >= 2 && !video.ended) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          } else if (video.ended) {
            // è§†é¢‘ç»“æŸï¼Œç»§ç»­ç»˜åˆ¶æœ€åä¸€å¸§é˜²æ­¢æµä¸­æ–­
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
        }
      } catch (e) {
        console.error("Canvasç»˜åˆ¶é”™è¯¯:", e);
        // ç»§ç»­ç»˜åˆ¶é»‘å±ï¼Œä¿æŒæµæ´»è·ƒ
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // æŒç»­è¯·æ±‚ä¸‹ä¸€å¸§
      animationFrameId = requestAnimationFrame(() => drawCanvas(ctx, canvas, video));
    }

    // === åœæ­¢å½•åˆ¶ ===
    function stopRecording() {
      if (!mediaRecorder || mediaRecorder.state === "inactive") return;

      isRecording = false;
      isIntroPhase = false;
      cancelAnimationFrame(animationFrameId);
      exitFullscreenMode();

      const video = document.getElementById("mainVideo");
      const actionBtn = document.getElementById("actionBtn");
      
      video.pause();
      video.controls = true;
      document.getElementById('recordOverlay').style.display = 'none';
      actionBtn.disabled = true;

      // æ˜¾ç¤ºå¤„ç†è¦†ç›–å±‚
      document.getElementById("processing-overlay").style.display = "flex";
      document.getElementById("statusText").innerText = "âœ¨ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆè§†é¢‘...";

      // å»¶è¿Ÿåœæ­¢ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®å†™å…¥
      setTimeout(() => {
        try { mediaRecorder.stop(); } catch(e) { console.warn("åœæ­¢å½•åˆ¶å™¨:", e); }
        
        // æ¸…ç†è½¨é“
        if (canvasStream) {
          canvasStream.getTracks().forEach(t => t.stop());
          canvasStream = null;
        }
        if (micStream) {
          micStream.getTracks().forEach(t => t.stop());
          micStream = null; hasMicPermission = false;
        }
      }, 500);
    }

    // === ç”Ÿæˆç»“æœ ===
    function generateVideoAndShowResult() {
      if(recordedChunks.length === 0) {
        cuteUI.show('ğŸ˜¢', 'å½•åˆ¶å¤±è´¥', 'æœªæ•è·åˆ°ä»»ä½•æ•°æ®ï¼Œè¯·é‡è¯•', false);
        setTimeout(() => cuteUI.hide(), 3000);
        return;
      }

      try {
        // åˆ›å»ºæœ€ç»ˆBlob
        finalBlob = new Blob(recordedChunks, { type: recordedMimeType || 'video/mp4' });
        finalObjectURL = URL.createObjectURL(finalBlob);

        const preview = document.getElementById("previewVideo");
        preview.src = finalObjectURL;

        document.getElementById("resultArea").style.display = "block";
        document.getElementById("waitingHint").style.display = "block";
        document.getElementById("statusText").innerText = "ğŸ‰ åˆ¶ä½œæˆåŠŸï¼Excellent!";
        
        setTimeout(() => {
          document.getElementById("waitingHint").style.display = "none";
          document.getElementById("shareBtn").style.display = "flex";
        }, 1200);

        document.getElementById("resultArea").scrollIntoView({behavior: "smooth"});
        
      } catch(e) {
        console.error("ç”Ÿæˆå¤±è´¥:", e);
        cuteUI.show('ğŸ˜µ', 'è§†é¢‘ç”Ÿæˆå¤±è´¥', 'è¯·é‡è¯•æˆ–æ›´æ¢æµè§ˆå™¨', false);
        setTimeout(() => cuteUI.hide(), 3000);
      }
    }

    // === ä¿å­˜/åˆ†äº« ===
    async function saveOrShareVideo() {
      if (!finalBlob) {
        cuteUI.show('ğŸ¤”', 'è¿˜æ²¡æœ‰è§†é¢‘', 'è¯·å…ˆå®Œæˆé…éŸ³å†ä¿å­˜å“¦ï¼', false);
        setTimeout(() => cuteUI.hide(), 2000);
        return;
      }

      // å¾®ä¿¡ç¯å¢ƒç‰¹æ®Šå¤„ç†
      if (isWeChat) {
        document.getElementById('wxDemoVideo').src = finalObjectURL;
        document.getElementById('wxSaveOverlay').classList.add('show');
        return;
      }

      // iOS Safariä½¿ç”¨åŸç”Ÿåˆ†äº«
      if ((isIOS || isSafari) && navigator.share && navigator.canShare) {
        try {
          const file = new File([finalBlob], `Firstleap_Voice_${Date.now()}.mp4`, { type: 'video/mp4' });
          if (navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'Firstleapé…éŸ³ç§€', text: 'å¿«æ¥çœ‹çœ‹æˆ‘çš„è‹±è¯­é…éŸ³ä½œå“ï¼' });
            cuteUI.show('âœ…', 'åˆ†äº«æˆåŠŸï¼', 'æ‚¨çš„ä½œå“å·²åˆ†äº«åˆ°ç›®æ ‡åº”ç”¨', false);
            setTimeout(() => cuteUI.hide(), 2000);
            return;
          }
        } catch (err) {
          console.log("åˆ†äº«å¤±è´¥:", err);
        }
      }

      // é€šç”¨ä¸‹è½½
      const a = document.createElement('a');
      a.href = finalObjectURL;
      a.download = `Firstleap_Voice_${Date.now()}.mp4`;
      a.click();
      
      cuteUI.show('ğŸ’¾', 'æ­£åœ¨ä¸‹è½½...', 'è§†é¢‘å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹', false);
      setTimeout(() => cuteUI.hide(), 2000);
    }

    function closeWxSaveOverlay() {
      document.getElementById('wxSaveOverlay').classList.remove('show');
    }

    // === å½•åˆ¶æš‚åœæ§åˆ¶ ===
    function togglePauseDuringRecording() {
      const video = document.getElementById("mainVideo");
      const btn = document.getElementById("pauseToggleBtn");
      if (!video) return;
      
      if (video.paused) {
        video.play().catch(() => {});
        btn.textContent = 'æš‚åœ';
      } else {
        video.pause();
        btn.textContent = 'ç»§ç»­';
      }
    }

    // === å½©è›‹ ===
    let titleClickCount = 0, titleClickTimer = null;
    document.addEventListener('DOMContentLoaded', () => {
      const h1 = document.querySelector('h1');
      if (h1) {
        h1.style.cursor = 'pointer';
        h1.addEventListener('click', () => {
          titleClickCount++;
          clearTimeout(titleClickTimer);
          titleClickTimer = setTimeout(() => titleClickCount = 0, 2000);
          if (titleClickCount >= 3) {
            document.getElementById('eggOverlay').style.display = 'flex';
            titleClickCount = 0;
          }
        });
      }
    });

    function closeEggOverlay() { document.getElementById('eggOverlay').style.display = 'none'; }
  </script>
</body>
</html>
