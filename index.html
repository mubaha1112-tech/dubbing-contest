<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ±æ­¥-å¥‡å£°å¦™æƒ³ Firstleap Voice Magic</title>
    <style>
        :root {
            --bg-cream: #F9F6E8;
            --card-white: #ffffff;
            --monster-green: #7BC043;
            --rabbit-pink: #FF8E8E;
            --rabbit-red: #EE5253;
            --pear-yellow: #F9CA24;
            --text-dark: #2d3436;
            --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
            --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
        }

        body {
            font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-cream);
            margin: 0;
            padding: 20px 10px;
            text-align: center;
            color: var(--text-dark);
        }

        .container {
            background: var(--card-white);
            padding: 25px 20px;
            border-radius: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            border: 5px solid #fff;
            transition: all 0.3s ease;
        }

        /* ===== å…¨å±æ¬¢è¿åŠ¨ç”»ï¼ˆæ›¿æ¢åŸ headerï¼‰ ===== */
        .welcome-screen {
            position: fixed;
            inset: 0;
            z-index: 100000; /* é«˜äºå…¶å®ƒé®ç½© */
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
            overflow: hidden;
            opacity: 1;
            transition: opacity .6s ease, visibility .6s ease;
            visibility: visible;
        }
        .welcome-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .welcome-bgvideo {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: saturate(1.1) contrast(1.05) brightness(0.9);
        }
        .welcome-overlay {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #fff;
            padding: 20px;
        }
        .welcome-title {
            font-weight: 900;
            font-size: 34px;
            letter-spacing: 1px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.18);
            animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2);
        }
        .welcome-subtitle {
            margin-top: 8px;
            font-size: 16px;
            opacity: .95;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.12);
            animation: fadeIn .8s ease .2s both;
        }
        .welcome-cta {
            margin-top: 18px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(255,255,255,0.18);
            color: #fff;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            cursor: pointer;
            user-select: none;
            transition: transform .12s ease, background .2s ease;
            animation: fadeIn .8s ease .35s both;
        }
        .welcome-cta:active { transform: translateY(1px) scale(0.99); }
        .welcome-skip {
            position: absolute;
            right: 12px;
            top: 12px;
            z-index: 3;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.25);
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            backdrop-filter: blur(3px);
        }
        .confetti {
            position: absolute;
            bottom: -20px;
            width: 8px; height: 14px;
            border-radius: 3px;
            opacity: .9;
            animation-name: riseSpin;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes titlePop {
            0% { transform: translateY(6px) scale(.92); opacity: 0; }
            60% { transform: translateY(-2px) scale(1.02); opacity: 1; }
            100% { transform: translateY(0) scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px) }
            to { opacity: 1; transform: translateY(0) }
        }
        @keyframes riseSpin {
            0% { transform: translateY(0) rotate(0deg); opacity: .0; }
            10% { opacity: .9; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        /* ================= æ ‡é¢˜ ================= */
        h1 {
            color: var(--rabbit-red);
            font-size: 26px;
            margin: 10px 0 25px;
            text-shadow: 2px 2px 0px #ffe3e3;
            font-weight: 900;
            letter-spacing: 1px;
            position: relative;
            display: inline-block;
        }
        h1::after {
            content: "âœ¨";
            position: absolute;
            right: -25px;
            top: 0;
            font-size: 20px;
            animation: bounce 2s infinite;
        }
        h1::before {
            content: "ğŸµ";
            position: absolute;
            left: -25px;
            top: 10px;
            font-size: 20px;
            animation: bounce 2s infinite reverse;
        }

        /* ================= æ§ä»¶æ ·å¼ ================= */
        .step-label {
            text-align: left;
            margin: 15px 0 5px 5px;
            font-weight: bold;
            color: #888;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .step-badge {
            background: var(--pear-yellow);
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
        }
        select {
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            border: 2px solid #eee;
            border-radius: 18px;
            font-size: 16px;
            background: #fafafa;
            outline: none;
            transition: 0.3s;
            color: #555;
            font-weight: bold;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
        }
        select:focus { border-color: var(--pear-yellow); background-color: #fff; }

        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            color: white;
            margin-top: 15px;
            transition: all 0.2s;
            box-shadow: var(--shadow-3d);
            position: relative;
            overflow: hidden;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .btn:disabled {
            background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none;
        }
        .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
        .btn-play {
            background: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
            display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
        .btn-stop {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            animation: pulse 1.5s infinite; position: relative; z-index: 1002;
        }
        .btn-group { display: flex; gap: 15px; margin-top: 15px; }
        .btn-download {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            text-decoration: none; line-height: 1.5; flex: 1; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            font-size: 18px; padding: 16px; border: none;
        }
        .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* ================= è§†é¢‘åŒºåŸŸ ================= */
        #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
        video {
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            background: #000;
            outline: none;
            border: 4px solid #fff;
            object-fit: contain;
        }
        video:fullscreen { border: none; border-radius: 0; width: 100%; height: 100%; }
        canvas { display: none; }
        .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }
        .preview-box {
            margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px;
            display: none; background: #fffcf0;
        }
        .tip {
            font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px;
            border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        /* ================= å½•åˆ¶æ—¶å…¨å± ================= */
        body.recording-mode { overflow: hidden; background: #000; padding: 0; }
        body.recording-mode .container {
            max-width: 100%; height: 100vh; border-radius: 0; border: none; padding: 10px 10px 20px;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: #000;
        }
        body.recording-mode .step-label,
        body.recording-mode select,
        body.recording-mode #searchBtn,
        body.recording-mode #playBtn,
        body.recording-mode .tip,
        body.recording-mode .status-text,
        body.recording-mode h1 { display: none !important; }
        body.recording-mode #video-container {
            margin: 0; height: auto; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: #000;
        }
        body.recording-mode #mainVideo { width: 100%; max-height: calc(100vh - 160px); border: none; box-shadow: none; }
        body.recording-mode #actionBtn {
            position: relative; bottom: auto; left: auto; transform: none; width: 80%; max-width: 260px; margin: 16px auto 0; z-index: 1001;
        }

        /* ================= åŠ è½½å±‚ ================= */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px);
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red);
            border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= å€’è®¡æ—¶ & è¿›åº¦æ¡é®ç½© ================= */
        .overlay-fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 142, 142, 0.95);
            z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box;
        }
        .countdown-number {
            font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            font-family: "Arial Rounded MT Bold", "Comic Sans MS", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
        .progress-container {
            width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px;
        }
        .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

        /* è¿›å…¥é¡µé¢æ—¶ç¦æ»šåŠ¨ï¼ˆæ¬¢è¿åŠ¨ç”»æœŸé—´ï¼‰ */
        body.welcome-active { overflow: hidden; }

        /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
        @media (prefers-reduced-motion: reduce) {
            .welcome-screen, .welcome-title, .welcome-subtitle, .confetti, .welcome-cta {
                animation: none !important;
            }
        }
    </style>
</head>
<body class="welcome-active">
    <!-- å…¨å±æ¬¢è¿åŠ¨ç”»ï¼ˆæ›¿æ¢åŸ headerï¼‰ -->
    <div id="welcome" class="welcome-screen" role="dialog" aria-modal="true" aria-label="æ¬¢è¿é¡µ">
        <button class="welcome-skip" id="welcomeSkipBtn" aria-label="è·³è¿‡">è·³è¿‡</button>
        <video id="welcomeVideo"
               class="welcome-bgvideo"
               muted
               autoplay
               playsinline
               webkit-playsinline
               x5-playsinline
               preload="auto"
               x5-video-player-type="h5-page"
               x5-video-orientation="portrait"
               aria-hidden="true">
            <source src="opener.mp4" type="video/mp4">
        </video>
        <div class="welcome-overlay">
            <div class="welcome-title">Firstleap Voice Magic</div>
            <div class="welcome-subtitle">å¥‡å£°å¦™æƒ³ Â· é…éŸ³ç§€</div>
            <div>
                <button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button>
            </div>
        </div>
        <!-- äº”å½©çº¸å±‘ç”± JS åŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- å€’è®¡æ—¶å±‚ -->
    <div id="countdown-overlay" class="overlay-fullscreen">
        <div class="countdown-number" id="countdownText">3</div>
        <div class="overlay-text">Ready?</div>
    </div>

    <!-- è§†é¢‘å‹åˆ¶è¿›åº¦å±‚ -->
    <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
        <div style="font-size: 60px;">âš™ï¸</div>
        <div class="overlay-text">è§†é¢‘åˆæˆä¸­...<br><span style="font-size:16px; opacity:0.8;">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
    </div>

    <!-- å¾®ä¿¡ä¿å­˜å¼•å¯¼ï¼ˆåœ¨å¾®ä¿¡å†…ç‚¹å‡»â€œä¿å­˜â€æ—¶çš„å…œåº•å±‚ï¼‰ -->
    <div id="wxHintOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.92);">
        <div style="color:#fff; font-size:22px; font-weight:900; margin-bottom:10px;">åœ¨å¾®ä¿¡ä¸­ä¿å­˜è§†é¢‘</div>
        <div style="color:#fff; font-size:14px; opacity:0.9; max-width:520px;">
            æ–¹å¼ä¸€ï¼šé•¿æŒ‰ä¸‹æ–¹è§†é¢‘ï¼Œé€‰æ‹©â€œä¿å­˜åˆ°æ‰‹æœºâ€<br>
            æ–¹å¼äºŒï¼šç‚¹å³ä¸Šè§’â€œ...â€ï¼Œé€‰æ‹©â€œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€â€ï¼Œå†ä¿å­˜
        </div>
        <video id="wxHintVideo" playsinline webkit-playsinline x5-playsinline controls style="width:88%; max-width:520px; border-radius:12px; background:#000; margin-top:14px;"></video>
        <button class="btn btn-retry" onclick="closeWxHint()" style="width:220px; margin-top:16px;">æˆ‘çŸ¥é“äº†</button>
    </div>

    <div class="container">
        <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">å¥‡å£°å¦™æƒ³é…éŸ³ç§€</span></h1>

        <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
        <select id="levelSelect" onchange="updateUnits()">
            <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
        </select>

        <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
        <select id="unitSelect" disabled>
            <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
        </select>

        <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

        <div id="video-container">
            <div id="loaderOverlay" class="loader-overlay">
                <div class="spinner"></div>
                <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
            </div>

            <video id="mainVideo"
                   playsinline
                   webkit-playsinline
                   x5-playsinline
                   controls
                   controlsList="nodownload"
                   crossOrigin="anonymous"
                   x5-video-player-type="h5-page">
                <source src="" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
            </video>

            <div class="tip">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·åŠ¡å¿…ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°å•¸å«ï¼</div>
            <div class="status-text" id="statusText"></div>

            <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
            <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>
            <canvas id="processCanvas"></canvas>
        </div>

        <!-- ç»“æœåŒºåŸŸï¼šé»˜è®¤éšè—ï¼Œåªæœ‰å½“è§†é¢‘å®Œå…¨ç”Ÿæˆåæ‰ä¼šæ˜¾ç¤º -->
        <div id="resultArea" class="preview-box">
            <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
            <p style="font-size:12px; color:#999; margin-bottom:15px;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>

            <video id="previewVideo"
                   style="width:100%; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); background:#000;"
                   controls
                   playsinline
                   webkit-playsinline
                   x5-playsinline></video>

            <div class="btn-group">
                <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
                <a id="downloadLink" class="btn btn-download" target="_blank" style="display: none;">ğŸ’¾ ä¿å­˜è§†é¢‘ (Save)</a>
            </div>

            <div id="waitingHint" style="text-align: center; margin: 20px 0; display: none;">
                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--rabbit-red); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px;"></div>
                <span style="color: var(--pear-yellow); font-weight: bold;">è¯·ç­‰å¾…è§†é¢‘åˆæˆ...</span>
            </div>

            <div style="font-size:10px; color:#999; margin-top:15px; text-align:center;">
                * å¦‚æœç‚¹å‡»æ— ååº”ï¼Œè¯·å°è¯•é•¿æŒ‰ä¸Šæ–¹çš„è§†é¢‘é€‰æ‹©"ä¿å­˜"
            </div>
        </div>
    </div>

    <script>
        // ============== å…¨å±æ¬¢è¿åŠ¨ç”»æ§åˆ¶ï¼ˆæ›¿æ¢åŸ headerï¼‰ ==============
        (function setupWelcome() {
            const welcome = document.getElementById('welcome');
            const wVideo = document.getElementById('welcomeVideo');
            const skipBtn = document.getElementById('welcomeSkipBtn');
            const enterBtn = document.getElementById('welcomeEnterBtn');

            // ç”Ÿæˆå°‘é‡è½»é‡å½©çº¸åŠ¨ç”»
            const colors = ['#fff176', '#ff8a80', '#80d8ff', '#ffd180', '#ea80fc', '#a7ffeb'];
            for (let i = 0; i < 18; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                const size = 6 + Math.floor(Math.random() * 8);
                const left = Math.random() * 100;
                const delay = (Math.random() * 0.8).toFixed(2);
                const dur = (2.2 + Math.random() * 2.2).toFixed(2);
                c.style.left = left + 'vw';
                c.style.background = colors[i % colors.length];
                c.style.width = size + 'px';
                c.style.height = (size + 4) + 'px';
                c.style.animationDuration = dur + 's';
                c.style.animationDelay = delay + 's';
                welcome.appendChild(c);
            }

            const hideWelcome = () => {
                if (welcome.classList.contains('hidden')) return;
                welcome.classList.add('hidden');
                document.body.classList.remove('welcome-active');
                // é˜²æ­¢è§†é¢‘ç»§ç»­å ç”¨è§£ç èµ„æº
                try { wVideo.pause(); } catch(e){}
                setTimeout(() => {
                    welcome.style.display = 'none';
                }, 650);
            };

            // è‡ªåŠ¨æ”¶èµ·ï¼ˆè§†é¢‘å¯æ’­æ”¾åä¸€æ®µæ—¶é—´ï¼‰
            let autoTimer = setTimeout(hideWelcome, 2600);
            wVideo.addEventListener('canplay', () => {
                // è‹¥è§†é¢‘è¿…é€Ÿå¯æ’­ï¼Œç»´æŒæ—¢å®šè‡ªåŠ¨å…³é—­
            }, { once: true });

            // äº¤äº’æŒ‰é’®ï¼šå°½å¯èƒ½è®©ç”¨æˆ·å¿«é€Ÿè¿›å…¥
            skipBtn.addEventListener('click', hideWelcome);
            enterBtn.addEventListener('click', hideWelcome);

            // å…œåº•ï¼šè§†é¢‘åŠ è½½å¤±è´¥ä¹Ÿèƒ½è¿›å…¥
            wVideo.addEventListener('error', () => {
                clearTimeout(autoTimer);
                autoTimer = setTimeout(hideWelcome, 1200);
            });

            // å¦‚æœç”¨æˆ·ç«‹å³æ“ä½œé¡µé¢å…¶å®ƒäº¤äº’ï¼Œä¹Ÿå…³é—­æ¬¢è¿å±‚
            document.addEventListener('keydown', hideWelcome, { once: true });
            document.addEventListener('touchstart', () => { if (!welcome.classList.contains('hidden')) hideWelcome(); }, { once: true, passive: true });
        })();

        // ================= æ•°æ®é…ç½®åŒº =================
        const videoDatabase = {
            "K2A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4",
                "", "", ""
            ],
            "K2B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4",
                "", "", ""
            ],
            "K3A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4",
                "", "", ""
            ],
            "K3B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4",
                "", "", ""
            ],
            "G0": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"
            ],
            "G1A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"
            ],
            "G1B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023453394e0d4dd.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"
            ],
            "G2A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4",
                ""
            ],
            "G2B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4",
                "", "", ""
            ],
            "G3A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4",
                "", "", ""
            ],
            "G3B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4",
                "", "", "", "", ""
            ],
            "G4A": [
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4",
                "", "", ""
            ],
            "G4B": [
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4",
                "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4",
                "", "", ""
            ]
        };

        // ================= å˜é‡åŒº =================
        let mediaRecorder;
        let recordedChunks = [];
        let audioCtx = null;
        let micStream = null;
        let canvasStream = null;     // å¤‡ç”¨
        let videoStream = null;      // è§†é¢‘ captureStream
        let sourceVideo = null;
        let sourceMic = null;
        let dest = null;
        let micGainNode = null;
        let videoGainNode = null;
        let isRecording = false;
        let recordedMimeType = '';
        let animationFrameId = null;

        // åˆæˆè¿›åº¦æ§åˆ¶
        let processingInterval = null;
        let processingProgress = 0;

        // ç”Ÿæˆè§†é¢‘åç”¨äºä¿å­˜çš„å…¨å±€å¯¹è±¡
        let finalBlob = null;
        let finalObjectURL = '';
        let finalFilename = '';

        // ç¯å¢ƒæ£€æµ‹ï¼šç”¨äºä¼˜åŒ–å¾®ä¿¡å†…çš„ä¿å­˜ä½“éªŒ
        const ua = navigator.userAgent || '';
        const isWeChat = /MicroMessenger/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        // ================= åˆå§‹åŒ– =================
        const levels = Object.keys(videoDatabase);
        const levelSelect = document.getElementById("levelSelect");
        levels.forEach(lvl => {
            let option = document.createElement("option");
            option.value = lvl;
            option.text = lvl;
            levelSelect.appendChild(option);
        });

        function updateUnits() {
            const lvl = document.getElementById("levelSelect").value;
            const unitSelect = document.getElementById("unitSelect");
            unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
            unitSelect.disabled = true;

            if (lvl && videoDatabase[lvl]) {
                let hasUnits = false;
                for (let i = 0; i < videoDatabase[lvl].length; i++) {
                    if (videoDatabase[lvl][i] && videoDatabase[lvl][i] !== "") {
                        let option = document.createElement("option");
                        option.value = i;
                        option.text = "Unit " + (i + 1);
                        unitSelect.appendChild(option);
                        hasUnits = true;
                    }
                }
                if(hasUnits) unitSelect.disabled = false;
            }
        }

        function findVideo() {
            const lvl = document.getElementById("levelSelect").value;
            const unitIndex = document.getElementById("unitSelect").value;
            const videoContainer = document.getElementById("video-container");
            const videoPlayer = document.getElementById("mainVideo");
            const loader = document.getElementById("loaderOverlay");
            const actionBtn = document.getElementById("actionBtn");
            const playBtn = document.getElementById("playBtn");

            if (!lvl || unitIndex === "") {
                alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼");
                return;
            }

            const url = videoDatabase[lvl][unitIndex];
            document.getElementById("resultArea").style.display = "none";
            actionBtn.style.display = "none";
            actionBtn.className = "btn btn-record";
            actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
            playBtn.style.display = "none";
            videoContainer.style.display = "block";
            loader.style.display = "flex";

            videoPlayer.src = url;
            videoPlayer.load();
            videoPlayer.volume = 1.0;

            videoPlayer.onprogress = function() {
                if (videoPlayer.buffered.length > 0) {
                    const duration = videoPlayer.duration;
                    const buffered = videoPlayer.buffered.end(0);
                    if (duration > 0) {
                        const percent = Math.min(100, Math.floor((buffered / duration) * 100));
                        document.getElementById("loadingText").innerText = "è§†é¢‘ç¼“å†²ä¸­ " + percent + "%";
                    }
                }
            };

            videoPlayer.oncanplaythrough = function() {
                loader.style.display = "none";
                actionBtn.style.display = "block";
                playBtn.style.display = "block";
                document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•ï¼Œå¯å…ˆé¢„è§ˆï¼Œæˆ–ç›´æ¥é…éŸ³";
            };

            videoPlayer.onended = function() {
                if(!isRecording) playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
            };

            videoPlayer.onplay = function() {
                if (!isRecording) playBtn.innerHTML = "â¸ï¸ æš‚åœæ’­æ”¾ Pause";
            };

            videoPlayer.onpause = function() {
                if (!isRecording) playBtn.innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
            };

            videoPlayer.onerror = function() {
                loader.style.display = "none";
                alert("è§†é¢‘åŠ è½½å¤±è´¥ã€‚åŸå› å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–è·¨åŸŸé™åˆ¶ã€‚\nå¦‚æœè§†é¢‘æ— æ³•åŠ è½½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨CORSè®¾ç½®ã€‚");
                document.getElementById("statusText").innerText = "âŒ è§†é¢‘åŠ è½½å¤±è´¥";
            };

            videoContainer.scrollIntoView({behavior: "smooth"});
        }

        function togglePreview() {
            const video = document.getElementById("mainVideo");
            if (video.paused) {
                video.volume = 1.0;
                video.muted = false;
                video.play();
            } else {
                video.pause();
            }
        }

        function resetRecording() {
            document.getElementById("resultArea").style.display = "none";
            const actionBtn = document.getElementById("actionBtn");
            actionBtn.style.display = "block";
            actionBtn.className = "btn btn-record";
            actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
            document.getElementById("playBtn").style.display = "block";
            document.getElementById("playBtn").innerHTML = "â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview";
            document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®ï¼Œè¯·ç‚¹å‡»æŒ‰é’®å†æ¬¡é…éŸ³";

            const mainVideo = document.getElementById("mainVideo");
            mainVideo.currentTime = 0;
            mainVideo.pause();
            mainVideo.controls = true;
            exitFullscreenMode();

            const preview = document.getElementById("previewVideo");
            if(preview.src) {
                URL.revokeObjectURL(preview.src);
                preview.src = "";
            }
            // æ¸…ç†ä¿å­˜æ•°æ®
            finalBlob = null;
            if (finalObjectURL) {
                URL.revokeObjectURL(finalObjectURL);
                finalObjectURL = '';
            }
            finalFilename = '';

            document.getElementById("video-container").scrollIntoView({behavior: "smooth"});
        }

        // ================= æ ¸å¿ƒå½•åˆ¶é€»è¾‘ =================
        function getBestMimeType() {
            const types = [
                "video/mp4;codecs=avc1",
                "video/mp4",
                "video/webm;codecs=h264",
                "video/webm;codecs=vp9",
                "video/webm"
            ];
            for (const type of types) {
                if (MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
                    console.log("Using MIME type:", type);
                    return type;
                }
            }
            return "";
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                prepareAndStartRecording();
            }
        }

        async function prepareAndStartRecording() {
            const video = document.getElementById("mainVideo");
            if (video.readyState < 2) {
                alert("è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæ¯•");
                return;
            }

            try {
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
            } catch (err) {
                alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼è¯·åœ¨æ‰‹æœºè®¾ç½®/æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½¿ç”¨éº¦å…‹é£ã€‚");
                return;
            }

            const overlay = document.getElementById('countdown-overlay');
            const text = document.getElementById('countdownText');
            let count = 3;
            overlay.style.display = 'flex';
            text.innerText = count;
            text.style.animation = 'none';
            void text.offsetHeight;
            text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    text.innerText = count;
                    text.style.animation = 'none';
                    void text.offsetHeight;
                    text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                } else {
                    clearInterval(timer);
                    text.innerText = "GO!";
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        enterFullscreenMode();
                        executeActualRecording();
                    }, 500);
                }
            }, 1000);
        }

        function enterFullscreenMode() {
            document.body.classList.add('recording-mode');
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen().catch(()=>{});
            } else if (docElm.mozRequestFullScreen) {
                docElm.mozRequestFullScreen().catch(()=>{});
            } else if (docElm.webkitRequestFullScreen) {
                docElm.webkitRequestFullScreen().catch(()=>{});
            }
        }

        function exitFullscreenMode() {
            document.body.classList.remove('recording-mode');
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(()=>{});
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen().catch(()=>{});
            } else if (document.webkitCancelFullScreen) {
                document.webkitCancelFullScreen().catch(()=>{});
            }
        }

        async function executeActualRecording() {
            const video = document.getElementById("mainVideo");
            const status = document.getElementById("statusText");
            const actionBtn = document.getElementById("actionBtn");

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioCtx || audioCtx.state === 'closed') {
                audioCtx = new AudioContext();
            } else if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }

            video.currentTime = 0;
            video.muted = false;
            video.volume = 1.0;
            video.controls = false;

            try {
                await video.play();
            } catch (e) {
                alert("è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»å±å¹•");
                video.controls = true;
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨ captureStream è·å–è§†é¢‘ç”»é¢
            videoStream = null;
            if (typeof video.captureStream === "function") {
                try {
                    videoStream = video.captureStream();
                } catch (e) {
                    console.warn("captureStream å‡ºé”™:", e);
                }
            } else if (typeof video.mozCaptureStream === "function") {
                try {
                    videoStream = video.mozCaptureStream();
                } catch (e) {
                    console.warn("mozCaptureStream å‡ºé”™:", e);
                }
            }

            if (!videoStream) {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥å½•åˆ¶è§†é¢‘ç”»é¢ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome / Edge / Safariã€‚");
                stopRecording();
                return;
            }

            const videoTracks = videoStream.getVideoTracks();
            if (!videoTracks || videoTracks.length === 0) {
                alert("æœªèƒ½è·å–è§†é¢‘ç”»é¢è½¨é“ï¼Œè¯·é‡è¯•ã€‚");
                stopRecording();
                return;
            }

            // ä½¿ç”¨ Web Audio æ··åˆéº¦å…‹é£å’ŒåŸè§†é¢‘éŸ³é¢‘
            dest = audioCtx.createMediaStreamDestination();
            micGainNode = audioCtx.createGain();
            videoGainNode = audioCtx.createGain();
            micGainNode.gain.value = 1.5;   // æ”¾å¤§éº¦å…‹é£
            videoGainNode.gain.value = 0.8; // é™ä½åŸè§†é¢‘éŸ³é‡ï¼Œé¿å…ç›–è¿‡äººå£°

            sourceMic = audioCtx.createMediaStreamSource(micStream);
            sourceMic.connect(micGainNode);
            micGainNode.connect(dest);

            try {
                if (videoStream.getAudioTracks().length > 0) {
                    if (!video._streamAudioSourceNode) {
                        sourceVideo = audioCtx.createMediaStreamSource(videoStream);
                        video._streamAudioSourceNode = sourceVideo;
                    } else {
                        sourceVideo = video._streamAudioSourceNode;
                    }
                    sourceVideo.connect(videoGainNode);
                    videoGainNode.connect(dest);
                    // è¾“å‡ºåˆ°æ‰¬å£°å™¨ï¼Œæ–¹ä¾¿é…éŸ³æ—¶ç›‘å¬åŸå£°
                    sourceVideo.connect(audioCtx.destination);
                }
            } catch (e) {
                console.error("Audio routing error:", e);
            }

            const mixedAudioTrack = dest.stream.getAudioTracks()[0];
            if (!mixedAudioTrack) {
                alert("æ— æ³•è·å–æ··åˆéŸ³é¢‘è½¨é“ï¼Œè¯·é‡è¯•ã€‚");
                stopRecording();
                return;
            }

            const combinedStream = new MediaStream([
                videoTracks[0],
                mixedAudioTrack
            ]);

            recordedMimeType = getBestMimeType();
            try {
                mediaRecorder = recordedMimeType
                    ? new MediaRecorder(combinedStream, { mimeType: recordedMimeType, videoBitsPerSecond: 2500000 })
                    : new MediaRecorder(combinedStream, { videoBitsPerSecond: 2500000 });
            } catch (e) {
                console.error("Recorder init fail:", e);
                try {
                    mediaRecorder = new MediaRecorder(combinedStream);
                } catch (e2) {
                    alert("æ­¤è®¾å¤‡/æµè§ˆå™¨æš‚ä¸æ”¯æŒç½‘é¡µå½•åˆ¶ï¼Œè¯·æ›´æ¢ Chrome æˆ– Safariã€‚");
                    stopRecording();
                    return;
                }
            }

            recordedChunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onerror = (e) => {
                console.error("MediaRecorder error:", e);
            };

            mediaRecorder.onstop = () => {
                console.log("Recorder stopped.");
                // ç»“æŸè¿›åº¦åˆ° 100%ï¼Œå†ç”Ÿæˆè§†é¢‘ä¸å±•ç¤ºç»“æœ
                finishProcessingOverlayThen(() => {
                    generateVideoAndShowResult();
                });
            };

            // å…³é”®ä¿®å¤ï¼šå¿…é¡»å¯åŠ¨å½•åˆ¶ï¼Œå¦åˆ™ onstop ä¸ä¼šè§¦å‘
            try {
                mediaRecorder.start(500); // æ¯ 500ms åˆ‡ç‰‡ï¼Œæå‡åœæ­¢åçš„å“åº”åº¦
            } catch (e) {
                console.error("mediaRecorder.start() failed:", e);
                alert("å¯åŠ¨å½•åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ›´æ¢æµè§ˆå™¨ã€‚");
                stopRecording();
                return;
            }

            isRecording = true;
            document.getElementById("playBtn").style.display = "none";
            actionBtn.innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ (Stop)";
            actionBtn.className = "btn btn-stop";
            status.innerText = "ğŸ”´ å½•åˆ¶ä¸­ (Recording)...";
            status.style.color = "#FF0000";

            video.onended = stopRecording;
        }

        // å¤‡ç”¨ï¼šæ—§çš„ canvas ç»˜åˆ¶é€»è¾‘ï¼ˆä¸é»˜è®¤ä½¿ç”¨ï¼‰
        function drawToCanvas(video, ctx, canvas) {
            if (!isRecording) {
                cancelAnimationFrame(animationFrameId);
                return;
            }
            try {
                if (video.readyState >= 2 && !video.paused && !video.ended) {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                }
            } catch (e) {
                console.error("Canvas Draw Error:", e);
                isRecording = false;
                exitFullscreenMode();
                alert("å½•åˆ¶ä¸­æ–­ï¼šè·¨åŸŸé™åˆ¶(CORS)ã€‚è¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ  'Access-Control-Allow-Origin: *'ã€‚");
                stopRecording();
                return;
            }
            animationFrameId = requestAnimationFrame(() => drawToCanvas(video, ctx, canvas));
        }

        function stopRecording() {
            if (!isRecording) return;

            isRecording = false;
            cancelAnimationFrame(animationFrameId);
            exitFullscreenMode();

            const video = document.getElementById("mainVideo");
            const actionBtn = document.getElementById("actionBtn");
            video.pause();
            video.controls = true;

            // å…ˆå±•ç¤ºåˆæˆè¿›åº¦ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
            beginProcessingOverlay();

            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.warn("mediaRecorder.stop error:", e);
                }
            }

            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            if (canvasStream) {
                canvasStream.getTracks().forEach(track => track.stop());
                canvasStream = null;
            }

            actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
            actionBtn.className = "btn btn-record";
            document.getElementById("statusText").innerText = "âœ¨ è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...";
            document.getElementById("statusText").style.color = "var(--pear-yellow)";
        }

        // ================= åˆæˆè¿›åº¦ & ç»“æœå±•ç¤º =================
        function beginProcessingOverlay() {
            const overlay = document.getElementById('processing-overlay');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            overlay.style.display = 'flex';
            processingProgress = 0;
            bar.style.width = '0%';
            text.innerText = '0%';

            if (processingInterval) clearInterval(processingInterval);
            // å…ˆå¹³æ»‘æ¨è¿›åˆ° 90%ï¼Œç­‰å¾… onstop å®Œæˆæ”¶å°¾
            processingInterval = setInterval(() => {
                if (processingProgress < 90) {
                    const step = Math.max(1, Math.round((90 - processingProgress) / 12));
                    processingProgress = Math.min(90, processingProgress + step);
                    bar.style.width = processingProgress + '%';
                    text.innerText = processingProgress + '%';
                }
            }, 120);
        }

        function finishProcessingOverlayThen(callback) {
            const overlay = document.getElementById('processing-overlay');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }
            // å¿«é€Ÿè¡¥åˆ° 100%
            const stepper = setInterval(() => {
                processingProgress = Math.min(100, processingProgress + 4);
                bar.style.width = processingProgress + '%';
                text.innerText = processingProgress + '%';
                if (processingProgress >= 100) {
                    clearInterval(stepper);
                    overlay.style.display = 'none';
                    if (typeof callback === 'function') callback();
                }
            }, 30);
        }

        // ç”Ÿæˆç»“æœ + å…¼å®¹å¾®ä¿¡ä¿å­˜çš„å¤„ç†
        function generateVideoAndShowResult() {
            if(recordedChunks.length === 0) {
                alert("å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©ºã€‚å¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰è·å–åˆ°ç”»é¢æˆ–å£°éŸ³ã€‚");
                document.getElementById("statusText").innerText = "âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
                document.getElementById("statusText").style.color = "var(--rabbit-red)";
                return;
            }

            try {
                const type = recordedMimeType || 'video/webm';
                finalBlob = new Blob(recordedChunks, { type });
                finalObjectURL = URL.createObjectURL(finalBlob);

                const preview = document.getElementById("previewVideo");
                preview.src = finalObjectURL;

                const downloadBtn = document.getElementById("downloadLink");
                const lowerType = type.toLowerCase();
                let ext = '.mp4';
                if (lowerType.includes('webm')) ext = '.webm';
                finalFilename = `Firstleap_Voice_${Date.now()}${ext}`;

                // é»˜è®¤è¡Œä¸ºï¼ˆå¾®ä¿¡å¤–ï¼‰ï¼šæ­£å¸¸ä¸‹è½½
                downloadBtn.href = finalObjectURL;
                downloadBtn.download = finalFilename;
                downloadBtn.target = "_blank";

                // å¾®ä¿¡å†…ä¼˜åŒ–ï¼šæ‹¦æˆªç‚¹å‡»ï¼Œæ”¹ä¸ºæ‰“å¼€ä¿å­˜å¼•å¯¼é¡µ
                if (isWeChat) {
                    downloadBtn.textContent = "ğŸ’¾ åœ¨å¾®ä¿¡ä¸­ä¿å­˜/åˆ†äº«";
                    downloadBtn.removeAttribute('download'); // é¿å…æ— æ•ˆ download å±æ€§
                    downloadBtn.onclick = function (e) {
                        e.preventDefault();
                        openWeChatSavePage();
                    };
                } else {
                    // éå¾®ä¿¡ï¼šä»å¯ç›´æ¥ä¸‹è½½
                    downloadBtn.onclick = null;
                }

                document.getElementById("actionBtn").style.display = "none";

                const resultArea = document.getElementById("resultArea");
                resultArea.style.display = "block";

                document.getElementById("waitingHint").style.display = "block";
                document.getElementById("downloadLink").style.display = "none";

                resultArea.scrollIntoView({behavior: "smooth"});
                document.getElementById("statusText").innerText = "ğŸ‰ åˆ¶ä½œæˆåŠŸï¼Excellent!";
                document.getElementById("statusText").style.color = "var(--rabbit-red)";

                // å°å»¶è¿Ÿåæ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                setTimeout(() => {
                    document.getElementById("waitingHint").style.display = "none";
                    document.getElementById("downloadLink").style.display = "flex";
                }, 2000);

            } catch(e) {
                console.error(e);
                alert("è§†é¢‘ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•");
                document.getElementById("statusText").innerText = "âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
                document.getElementById("statusText").style.color = "var(--rabbit-red)";
            }
        }

        // åœ¨å¾®ä¿¡ä¸­æ‰“å¼€ä¸€ä¸ªä»…åŒ…å«è§†é¢‘çš„é¡µé¢ï¼Œä¾¿äºé•¿æŒ‰ä¿å­˜æˆ–åˆ†äº«
        function openWeChatSavePage() {
            if (!finalObjectURL) {
                alert("æš‚æœªç”Ÿæˆå¯ä¿å­˜çš„è§†é¢‘ï¼Œè¯·å…ˆå®Œæˆé…éŸ³ã€‚");
                return;
            }
            // ä¼˜å…ˆå°è¯•æ–°çª—å£ï¼ˆå¤šæ•°åœºæ™¯ä¸‹ï¼Œåœ¨ç”¨æˆ·äº¤äº’ä¸‹å…è®¸ï¼‰
            const w = window.open('', '_blank');
            const pageTitle = 'é•¿æŒ‰ä¿å­˜è§†é¢‘ Â· åŠ±æ­¥å¥‡å£°å¦™æƒ³';
            const tipsHTML = `
                <div style="font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Helvetica Neue',sans-serif;
                            color:#fff; text-align:center; padding:14px 10px 6px; background:#111;">
                    <div style="font-weight:900; font-size:18px;">åœ¨å¾®ä¿¡ä¸­ä¿å­˜æˆ–åˆ†äº«è§†é¢‘</div>
                    <div style="font-size:13px; opacity:0.85; margin-top:6px;">
                        1) é•¿æŒ‰ä¸‹æ–¹è§†é¢‘ é€‰æ‹©â€œä¿å­˜åˆ°æ‰‹æœºâ€
                        <br>2) æˆ–ç‚¹å³ä¸Šè§’â€œ...â€ é€‰æ‹©â€œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€â€
                    </div>
                </div>
            `;
            const videoHTML = `
                <video controls playsinline webkit-playsinline x5-playsinline
                       style="width:100%; height:auto; background:#000;"
                       src="${finalObjectURL}"></video>
            `;
            const baseHTML = `
                <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
                <title>${pageTitle}</title>
                <body style="margin:0;background:#000;">${tipsHTML}${videoHTML}</body>
            `;
            if (w && typeof w.document !== 'undefined') {
                w.document.open();
                w.document.write(baseHTML);
                w.document.close();
            } else {
                // è‹¥è¢«æ‹¦æˆªï¼Œåˆ™åœ¨å½“å‰é¡µç”¨å…œåº•å±‚ç»™å‡ºé•¿æŒ‰ä¿å­˜æŒ‡å¼•
                const hintVideo = document.getElementById('wxHintVideo');
                hintVideo.src = finalObjectURL;
                document.getElementById('wxHintOverlay').style.display = 'flex';
            }
        }

        function closeWxHint() {
            const hint = document.getElementById('wxHintOverlay');
            const v = document.getElementById('wxHintVideo');
            v.pause();
            hint.style.display = 'none';
        }
    </script>
</body>
</html>
