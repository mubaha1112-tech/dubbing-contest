<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic</title>
  <style>
    /* --- æ ·å¼åŒºåŸŸ (ä¿æŒåŸæ ·ï¼Œæœªæ”¹åŠ¨) --- */
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* æ¬¢è¿é¡µåŠ¨ç”» */
    .welcome-screen {
      position: fixed;
      inset: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%);
      overflow: hidden;
      opacity: 1;
      transition: opacity .6s ease, visibility .6s ease;
      visibility: visible;
    }
    .welcome-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .welcome-bgvideo {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.1) contrast(1.05) brightness(0.9);
    }
    .welcome-overlay {
      position: relative;
      z-index: 2;
      text-align: center;
      color: #fff;
      padding: 20px;
    }
    .welcome-title {
      font-weight: 900;
      font-size: 34px;
      letter-spacing: 1px;
      text-shadow: 3px 3px 0 rgba(0,0,0,0.18);
      animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2);
    }
    .welcome-subtitle {
      margin-top: 8px;
      font-size: 16px;
      opacity: .95;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.12);
      animation: fadeIn .8s ease .2s both;
    }
    .welcome-cta {
      margin-top: 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      color: #fff;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,0.35);
      backdrop-filter: blur(6px);
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, background .2s ease;
      animation: fadeIn .8s ease .35s both;
    }
    .welcome-cta:active { transform: translateY(1px) scale(0.99); }
    .welcome-skip {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 3;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.5);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      backdrop-filter: blur(3px);
    }

    @keyframes titlePop {
      0% { transform: translateY(6px) scale(.92); opacity: 0; }
      60% { transform: translateY(-2px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px) }
      to { opacity: 1; transform: translateY(0) }
    }

    /* æ ‡é¢˜ */
    h1 {
      color: var(--rabbit-red);
      font-size: 26px;
      margin: 10px 0 25px;
      text-shadow: 2px 2px 0px #ffe3e3;
      font-weight: 900;
      letter-spacing: 1px;
      position: relative;
      display: inline-block;
    }
    h1::after {
      content: "âœ¨";
      position: absolute;
      right: -25px;
      top: 0;
      font-size: 20px;
      animation: bounce 2s infinite;
    }
    h1::before {
      content: "ğŸµ";
      position: absolute;
      left: -25px;
      top: 10px;
      font-size: 20px;
      animation: bounce 2s infinite reverse;
    }

    /* æ§ä»¶ */
    .step-label {
      text-align: left;
      margin: 15px 0 5px 5px;
      font-weight: bold;
      color: #888;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    .step-badge {
      background: var(--pear-yellow);
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 12px;
    }
    select {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      border: 2px solid #eee;
      border-radius: 18px;
      font-size: 16px;
      background: #fafafa;
      outline: none;
      transition: 0.3s;
      color: #555;
      font-weight: bold;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 18px;
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 25px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      color: white;
      margin-top: 15px;
      transition: all 0.2s;
      box-shadow: var(--shadow-3d);
      position: relative;
      overflow: hidden;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled {
      background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none;
    }
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play {
      background: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
      display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
    }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      animation: pulse 1.5s infinite; position: relative; z-index: 1002;
    }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }
    .btn-download {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      text-decoration: none; line-height: 1.5; flex: 1; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
      font-size: 18px; padding: 16px; border: none;
    }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* è§†é¢‘åŒºåŸŸ */
    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video {
      width: 100%;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      background: #000;
      outline: none;
      border: 4px solid #fff;
      object-fit: contain;
    }
    
    /* å½•åˆ¶æ¨¡å¼æ ·å¼è¦†ç›– */
    body.recording-mode video::-webkit-media-controls { display: none !important; }
    body.recording-mode video::-webkit-media-controls-enclosure { display: none !important; }
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container {
      max-width: 100%; height: 100vh;
      border-radius: 0; border: none;
      padding: calc(env(safe-area-inset-top, 0px) + 8px) 10px calc(env(safe-area-inset-bottom, 0px) + 80px);
      display: flex; flex-direction: column; align-items: center; background: #000;
    }
    body.recording-mode .step-label,
    body.recording-mode select,
    body.recording-mode #searchBtn,
    body.recording-mode #playBtn,
    body.recording-mode .tip,
    body.recording-mode .status-text,
    body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container {
      margin: 0; width: 100%; display: flex; flex: 1;
      flex-direction: column; align-items: center; justify-content: center; background: #000;
    }
    body.recording-mode #mainVideo { width: 100%; height: auto; max-height: 100%; border: none; box-shadow: none; }
    body.recording-mode #actionBtn { display: none; }

    /* è¾…åŠ©å…ƒç´  */
    #processCanvas { display: none; }
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }

    .preview-box {
      margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px;
      display: none; background: #fffcf0;
    }
    .tip {
      font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px;
      border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    .record-overlay {
      position: absolute; top: 8px; right: 8px; display: none; gap: 6px; z-index: 999; pointer-events: auto;
    }
    .record-overlay .btn { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 800; cursor: pointer; border: none; }
    .record-overlay .pause { background: #6c7dff; color: white; }

    /* Loading */
    .loader-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px);
    }
    .spinner {
      border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red);
      border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* å…¨å±é®ç½© */
    .overlay-fullscreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 142, 142, 0.95);
      z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column;
      backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box;
    }
    .countdown-number {
      font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
      font-family: "Arial Rounded MT Bold", "Comic Sans MS", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
    .progress-container {
      width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px;
    }
    .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease; }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    /* é”™è¯¯æç¤º */
    #micErrorOverlay {
      background: rgba(255, 82, 83, 0.95); font-family: sans-serif; padding: 30px; border-radius: 20px; max-width: 80%;
    }
    .monster-gift { font-size: 60px; animation: jumpHappy 1s infinite alternate; }
    @keyframes jumpHappy { 0% { transform: translateY(0) rotate(-10deg); } 100% { transform: translateY(-20px) rotate(10deg); } }

  </style>
</head>
<body class="welcome-active">
  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen" role="dialog" aria-modal="true" aria-label="æ¬¢è¿é¡µ">
    <button class="welcome-skip" id="welcomeSkipBtn" aria-label="è·³è¿‡">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop preload="auto" x5-video-player-type="h5-page" aria-hidden="true">
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic 112233</div>
      <div class="welcome-subtitle">é…éŸ³ç§€</div>
      <div><button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button></div>
    </div>
  </div>

  <!-- éº¦å…‹é£æƒé™é”™è¯¯æç¤º -->
  <div id="micAuthErrorOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.85); z-index: 99999;">
    <div id="micErrorOverlay">
      <div style="font-size: 60px; margin-bottom: 10px;">ğŸš«</div>
      <div class="overlay-text">éº¦å…‹é£æƒé™è¢«æ‹’ç»</div>
      <div style="font-size: 16px; margin-top: 10px; color: white; opacity: 0.9;">å½•éŸ³åŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­<br><b>å…è®¸è®¿é—®éº¦å…‹é£</b>åé‡è¯•ã€‚</div>
      <button class="btn btn-retry" onclick="closeMicErrorHint()" style="width:160px; margin-top:20px; background:#fff; color:#FF5253; box-shadow:none;">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- å€’è®¡æ—¶é®ç½© -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
  </div>

  <!-- å¤„ç†ä¸­é®ç½© -->
  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">è§†é¢‘åˆæˆä¸­...<br><span style="font-size:14px; opacity:0.8;">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
  </div>

  <!-- å½©è›‹ -->
  <div id="eggOverlay" class="overlay-fullscreen" style="background: rgba(0,0,0,0.9); z-index: 100001;">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
    <div class="overlay-text" style="color: #FFD700; font-size: 28px;">æ­å–œä½ å‘ç°å½©è›‹ï¼</div>
    <div style="display: flex; gap: 20px; margin: 20px 0;">
      <div class="monster-gift">ğŸ‘¾</div><div class="monster-gift" style="animation-delay: 0.1s">ğŸ‘¾</div><div class="monster-gift" style="animation-delay: 0.2s">ğŸ‘¾</div>
    </div>
    <div style="color: var(--monster-green); font-weight: bold; font-size: 24px; margin-bottom: 30px;">3 Monsters</div>
    <button class="btn btn-primary" onclick="closeEggOverlay()" style="width: 200px; background: linear-gradient(135deg, #FF8E8E, #EE5253); box-shadow: none;">å¤ªæ£’äº†ï¼</button>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="container">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <div id="video-container">
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
      </div>

      <!-- æ ¸å¿ƒè§†é¢‘å…ƒç´ ï¼šcrossOrigin="anonymous" éå¸¸å…³é”® -->
      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous" x5-video-player-type="h5-page">
        <source src="" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
      </video>

      <div id="recordOverlay" class="record-overlay">
        <button id="pauseToggleBtn" class="btn pause" onclick="togglePauseDuringRecording()">æš‚åœ</button>
      </div>

      <div class="tip" style="margin-top: 6px;">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·åŠ¡å¿…ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°ï¼</div>
      <div class="status-text" id="statusText"></div>

      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>

      <canvas id="processCanvas"></canvas>
    </div>

    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <p style="font-size:12px; color:#999; margin-bottom:15px;">å¦‚æœé¢„è§ˆå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>

      <video id="previewVideo" style="width:100%; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); background:#000;" controls playsinline webkit-playsinline x5-playsinline></video>

      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <button id="downloadLink" class="btn btn-download">ğŸ’¾ ä¸‹è½½è§†é¢‘ Download</button>
      </div>
      
      <div style="font-size:12px; color:#666; margin-top:15px; text-align:center; line-height:1.5; background:#eee; padding:10px; border-radius:10px;" id="saveTipText">
        ğŸ’¡ <b>å®‰å“ç”¨æˆ·æ³¨æ„ï¼š</b><br>å¦‚æœä¸‹è½½åç›¸å†Œæ— æ³•æ’­æ”¾ï¼Œè¯·å°è¯•ä½¿ç”¨ VLC æ’­æ”¾å™¨ï¼Œæˆ–ç›´æ¥åœ¨å¾®ä¿¡/QQä¸­å‘é€æ–‡ä»¶é¢„è§ˆã€‚
      </div>
    </div>
  </div>

  <script>
    // --- æ•°æ®æº ---
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4"],
      "K2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4"],
      "K3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4"],
      "K3B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4"],
      "G0": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"],
      "G1A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"],
      "G1B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"],
      "G2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4"],
      "G2B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4"],
      "G3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4"],
      "G3B": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4"],
      "G4A": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4","https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4"],
      "G4B": ["https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4","https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4"]
    };

    // å…¨å±€å˜é‡
    let mediaRecorder = null;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let dest = null;
    let micGainNode = null;
    let videoGainNode = null;
    let sourceMic = null;
    let sourceVideo = null;
    
    let isRecording = false;
    let isIntroMode = false;
    let introImageObj = null;
    let animationFrameId = null;
    let processingInterval = null;
    let processingProgress = 0;
    
    // å…³é”®ï¼šç”¨äºå­˜å‚¨æœ€ç»ˆæ–‡ä»¶çš„å®é™…ç±»å‹
    let finalBlob = null;
    let finalMimeType = ''; 
    let finalExtension = '';

    const levelSelect = document.getElementById("levelSelect");
    Object.keys(videoDatabase).forEach(lvl => {
      let option = document.createElement("option");
      option.value = lvl; option.text = lvl;
      levelSelect.appendChild(option);
    });

    // --- åˆå§‹åŒ–ä¸æƒé™ ---
    function initializeAudioContext() {
      if (!audioCtx || audioCtx.state === 'closed') {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
    }

    async function checkMicPermission() {
      initializeAudioContext();
      if (audioCtx.state === 'suspended') {
        try { await audioCtx.resume(); } catch(e) {}
      }
      if (micStream) return true;
      try {
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: { 
              echoCancellation: true, 
              noiseSuppression: true, 
              autoGainControl: true,
              channelCount: 1 
          }
        });
        return true;
      } catch (err) {
        document.getElementById('micAuthErrorOverlay').style.display = 'flex';
        return false;
      }
    }
    
    function closeMicErrorHint() { document.getElementById('micAuthErrorOverlay').style.display = 'none'; }

    // --- UI é€»è¾‘ ---
    // æ¬¢è¿é¡µ
    (function setupWelcome() {
      const welcome = document.getElementById('welcome');
      const enterBtn = document.getElementById('welcomeEnterBtn');
      const skipBtn = document.getElementById('welcomeSkipBtn');
      const wVideo = document.getElementById('welcomeVideo');

      const hideWelcome = () => {
        welcome.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        try { wVideo.pause(); } catch(e){}
        setTimeout(() => welcome.style.display = 'none', 650);
      };

      enterBtn.addEventListener('click', async () => {
        // ç”¨æˆ·ç‚¹å‡»æ—¶åˆå§‹åŒ– AudioContextï¼ˆç§»åŠ¨ç«¯å¿…é¡»ï¼‰
        await checkMicPermission(); 
        hideWelcome();
      });
      skipBtn.addEventListener('click', hideWelcome);
    })();

    // å½©è›‹
    let titleClickCount = 0;
    let titleClickTimer = null;
    document.querySelector('h1').addEventListener('click', function() {
      titleClickCount++;
      if (titleClickCount === 1) {
        titleClickTimer = setTimeout(() => { titleClickCount = 0; }, 2000);
      }
      if (titleClickCount === 3) {
        document.getElementById('eggOverlay').style.display = 'flex';
        titleClickCount = 0; clearTimeout(titleClickTimer);
      }
    });
    function closeEggOverlay() { document.getElementById('eggOverlay').style.display = 'none'; }

    // è§†é¢‘åŠ è½½
    function updateUnits() {
      const lvl = document.getElementById("levelSelect").value;
      const unitSelect = document.getElementById("unitSelect");
      // æ¸…ç©ºæ—§é€‰é¡¹ï¼Œä¿ç•™ placeholder
      unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ (Unit) --</option>';
      unitSelect.disabled = true;
      
      if (lvl && videoDatabase[lvl]) {
        videoDatabase[lvl].forEach((url, i) => {
          if(url) {
            let option = document.createElement("option");
            option.value = i; option.text = "Unit " + (i + 1);
            unitSelect.appendChild(option);
          }
        });
        unitSelect.disabled = false;
      }
    }

    function findVideo() {
      const lvl = document.getElementById("levelSelect").value;
      const unitIndex = document.getElementById("unitSelect").value;
      if (!lvl || unitIndex === "") { alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼"); return; }

      const url = videoDatabase[lvl][unitIndex];
      const video = document.getElementById("mainVideo");
      
      document.getElementById("resultArea").style.display = "none";
      document.getElementById("video-container").style.display = "block";
      document.getElementById("loaderOverlay").style.display = "flex";
      
      // å…³é”®ï¼šç¡®ä¿è·¨åŸŸé…ç½®
      video.crossOrigin = "anonymous";
      video.src = url;
      video.load();
      video.controls = true; 
      
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      actionBtn.style.display = "none";
      document.getElementById("playBtn").style.display = "none";

      video.oncanplaythrough = function() {
        document.getElementById("loaderOverlay").style.display = "none";
        document.getElementById("statusText").innerText = "âœ… è§†é¢‘åŠ è½½å®Œæ¯•";
        actionBtn.style.display = "block";
        document.getElementById("playBtn").style.display = "block";
        // é¢„è®¾ Canvas
        const canvas = document.getElementById("processCanvas");
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
      };

      video.onerror = function() {
        document.getElementById("loaderOverlay").style.display = "none";
        alert("è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
      };
    }

    function togglePreview() {
      const video = document.getElementById("mainVideo");
      const btn = document.getElementById("playBtn");
      if (video.paused) { video.play(); btn.innerText = "â¸ï¸ æš‚åœæ’­æ”¾"; }
      else { video.pause(); btn.innerText = "â–¶ï¸ é¢„è§ˆåŸç‰‡"; }
    }

    // --- æ ¸å¿ƒå½•åˆ¶é€»è¾‘ ---

    function toggleRecording() {
      if (isRecording) stopRecording();
      else startRecordingSequence();
    }

    async function startRecordingSequence() {
      const video = document.getElementById("mainVideo");
      if (!await checkMicPermission()) return;

      // å€’è®¡æ—¶
      video.controls = false;
      const overlay = document.getElementById('countdown-overlay');
      const text = document.getElementById('countdownText');
      let count = 3;
      overlay.style.display = 'flex';
      text.innerText = count;

      const timer = setInterval(() => {
        count--;
        if (count > 0) text.innerText = count;
        else {
          clearInterval(timer);
          text.innerText = "GO!";
          setTimeout(() => {
            overlay.style.display = 'none';
            enterFullscreen();
            initMediaRecorder();
          }, 500);
        }
      }, 1000);
    }

    function enterFullscreen() {
      document.body.classList.add('recording-mode');
      const el = document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if(el.webkitRequestFullScreen) el.webkitRequestFullScreen().catch(()=>{});
    }
    
    function exitFullscreen() {
      document.body.classList.remove('recording-mode');
      if(document.exitFullscreen) document.exitFullscreen().catch(()=>{});
      else if(document.webkitCancelFullScreen) document.webkitCancelFullScreen().catch(()=>{});
    }

    // --- å½•åˆ¶å™¨åˆå§‹åŒ–ï¼ˆæ ¸å¿ƒéš¾ç‚¹ï¼‰ ---
    async function initMediaRecorder() {
      const video = document.getElementById("mainVideo");
      const canvas = document.getElementById("processCanvas");
      const ctx = canvas.getContext("2d");
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // 1. éŸ³é¢‘æ··åˆ (Microphone + Video Sound)
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      dest = audioCtx.createMediaStreamDestination();
      
      micGainNode = audioCtx.createGain();
      videoGainNode = audioCtx.createGain();
      micGainNode.gain.value = 1.5; // äººå£°æ”¾å¤§
      videoGainNode.gain.value = 0.5; // åŸå£°å‡å°

      // éº¦å…‹é£æµ
      if (micStream) {
        sourceMic = audioCtx.createMediaStreamSource(micStream);
        sourceMic.connect(micGainNode);
        micGainNode.connect(dest);
      }
      
      // è§†é¢‘åŸå£° (å®¹é”™å¤„ç†)
      try {
        if (!sourceVideo && !video._hasHookedAudio) {
           // å¿…é¡»åœ¨æ­¤å¤„åˆ›å»ºï¼Œä¸”è§†é¢‘å¿…é¡»å…è®¸è·¨åŸŸ
           sourceVideo = audioCtx.createMediaElementSource(video);
           video._hasHookedAudio = true;
           sourceVideo.connect(videoGainNode);
           videoGainNode.connect(dest);
           videoGainNode.connect(audioCtx.destination); // ä¹Ÿè¦è¾“å‡ºåˆ°æ‰¬å£°å™¨
        }
      } catch (e) {
        console.warn("Audio Context Error (CORS or State):", e);
        // å¦‚æœæŠ“å–è§†é¢‘å£°éŸ³å¤±è´¥ï¼Œæˆ‘ä»¬è‡³å°‘è¿˜è¦å½•åˆ¶éº¦å…‹é£
      }

      // 2. è§†é¢‘æµæ•è·
      try {
        // 30 FPS, é«˜äº†æ‰‹æœºæ‰›ä¸ä½
        canvasStream = canvas.captureStream(30); 
      } catch(e) {
        alert("æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œæ— æ³•å½•åˆ¶ã€‚");
        return;
      }

      // 3. åˆæˆæœ€ç»ˆæµ
      const finalStream = new MediaStream([
        ...canvasStream.getVideoTracks(),
        ...dest.stream.getAudioTracks()
      ]);

      // 4. å…³é”®ï¼šMIME Type å—…æ¢ (ä¼˜å…ˆå¯»æ‰¾ MP4)
      const mimeTypes = [
        'video/mp4; codecs="avc1.42E01E, mp4a.40.2"', // æœ€ç†æƒ³ï¼šAndroid H.264
        'video/mp4', // å°è¯•é€šç”¨ MP4
        'video/webm; codecs=h264', // WebM å®¹å™¨ä½†ç”¨ H.264 ç¼–ç 
        'video/webm; codecs=vp9', // é«˜æ•ˆ WebM
        'video/webm; codecs=vp8', // å…¼å®¹ WebM
        'video/webm' // æœ€ç»ˆä¿åº•
      ];

      let selectedMimeType = '';
      for (let type of mimeTypes) {
        if (MediaRecorder.isTypeSupported(type)) {
          selectedMimeType = type;
          console.log("Selected MIME:", selectedMimeType);
          break;
        }
      }

      // 5. é…ç½® Recorder
      try {
        const options = {
            videoBitsPerSecond: 2500000 // 2.5Mbps ä¿è¯ç”»è´¨
        };
        if (selectedMimeType) {
            options.mimeType = selectedMimeType;
        }
        mediaRecorder = new MediaRecorder(finalStream, options);
      } catch(e) {
        console.error("Recorder init failed, trying default", e);
        mediaRecorder = new MediaRecorder(finalStream); // ç»æœ›çš„ä¿åº•
      }

      // ç¡®å®šå®é™…å½•åˆ¶çš„ç±»å‹å’Œåç¼€
      finalMimeType = mediaRecorder.mimeType;
      if (finalMimeType.includes('mp4')) {
          finalExtension = 'mp4';
      } else {
          finalExtension = 'webm'; // è¯šå®é¢å¯¹
      }

      recordedChunks = [];
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = finishRecordingProcess;

      // 6. å¼€å§‹
      mediaRecorder.start(100); // åˆ‡ç‰‡æ—¶é—´ 100msï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
      isRecording = true;
      isIntroMode = true;
      
      // Intro å›¾ç‰‡åŠ è½½
      introImageObj = new Image();
      introImageObj.crossOrigin = "anonymous";
      introImageObj.src = "intro.png"; 
      
      drawLoop(video, ctx, canvas);

      document.getElementById("actionBtn").innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ Stop";
      document.getElementById("actionBtn").className = "btn btn-stop";
      document.getElementById("statusText").innerText = "ğŸ¬ Intro...";
      
      // æ’­æ”¾é€»è¾‘
      setTimeout(() => {
        isIntroMode = false;
        video.currentTime = 0;
        video.play().then(() => {
           document.getElementById("statusText").innerText = "ğŸ”´ å½•åˆ¶ä¸­...";
        }).catch(e => {
           console.log("Auto play prevented", e);
        });
        
        video.onended = () => { if(isRecording) stopRecording(); };
      }, 3000);
    }

    function drawLoop(video, ctx, canvas) {
      if (!isRecording) return;
      
      if (isIntroMode) {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (introImageObj && introImageObj.complete) {
           // ç®€å•çš„å±…ä¸­ç»˜åˆ¶
           const ar = introImageObj.width / introImageObj.height;
           let dw = canvas.width;
           let dh = dw / ar;
           if (dh > canvas.height) { dh = canvas.height; dw = dh * ar; }
           ctx.drawImage(introImageObj, (canvas.width - dw)/2, (canvas.height - dh)/2, dw, dh);
        }
      } else {
        if (!video.paused && !video.ended) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
      }
      animationFrameId = requestAnimationFrame(() => drawLoop(video, ctx, canvas));
    }

    function togglePauseDuringRecording() {
        const v = document.getElementById("mainVideo");
        const btn = document.getElementById("pauseToggleBtn");
        if(v.paused) { v.play(); btn.innerText="æš‚åœ"; }
        else { v.pause(); btn.innerText="ç»§ç»­"; }
    }

    function stopRecording() {
      if (!mediaRecorder) return;
      isRecording = false;
      isIntroMode = false;
      cancelAnimationFrame(animationFrameId);
      
      const video = document.getElementById("mainVideo");
      video.pause();
      
      document.getElementById("processing-overlay").style.display = 'flex';
      processingProgress = 0;
      updateProgress();
      
      mediaRecorder.stop();
      if(canvasStream) canvasStream.getTracks().forEach(t => t.stop());
      
      exitFullscreen();
      document.getElementById("actionBtn").disabled = true;
    }

    function updateProgress() {
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');
      if (processingProgress < 95) {
        processingProgress += 3;
        bar.style.width = processingProgress + '%';
        text.innerText = processingProgress + '%';
        processingInterval = requestAnimationFrame(updateProgress);
      }
    }

    function finishRecordingProcess() {
      cancelAnimationFrame(processingInterval);
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('progressText').innerText = '100%';
      
      setTimeout(() => {
        document.getElementById("processing-overlay").style.display = 'none';
        generateResult();
      }, 600);
    }

    // --- ç»“æœç”Ÿæˆä¸ä¸‹è½½ ---

    function generateResult() {
        // ä½¿ç”¨ä¹‹å‰ç¡®å®šå¥½çš„ mimeType åˆ›å»º Blob
        const blob = new Blob(recordedChunks, { type: finalMimeType });
        finalBlob = blob;
        
        console.log("Result Type:", finalMimeType, "Size:", blob.size);

        if (blob.size < 1000) {
            alert("å½•åˆ¶ä¼¼ä¹å¤±è´¥äº†ï¼ˆæ•°æ®ä¸ºç©ºï¼‰ï¼Œè¯·é‡è¯•ã€‚");
            resetRecording();
            return;
        }

        const url = URL.createObjectURL(blob);
        
        const preview = document.getElementById("previewVideo");
        preview.src = url;
        preview.load();
        
        // åˆ‡æ¢ç•Œé¢
        document.getElementById("video-container").style.display = "none";
        document.getElementById("resultArea").style.display = "block";
        
        // æ ¹æ®æ ¼å¼æ˜¾ç¤ºæç¤º
        const tipEl = document.getElementById("saveTipText");
        if (finalExtension === 'mp4') {
            tipEl.innerHTML = "ğŸ’¡ <b>å®Œç¾ï¼</b> æ‚¨çš„æµè§ˆå™¨æ”¯æŒ MP4 å½•åˆ¶ï¼Œä¸‹è½½åå¯ç›´æ¥æ’­æ”¾ã€‚";
        } else {
            tipEl.innerHTML = "ğŸ’¡ <b>å®‰å“å…¼å®¹æ€§æç¤ºï¼š</b><br>å¦‚æœç³»ç»Ÿç›¸å†Œæ— æ³•æ’­æ”¾ä¸‹è½½çš„ .webm è§†é¢‘ï¼Œè¯·ä½¿ç”¨ VLC æ’­æ”¾å™¨æˆ–ç›´æ¥åœ¨å¾®ä¿¡ä¸­å‘é€æŸ¥çœ‹ã€‚";
        }

        // ç»‘å®šä¸‹è½½
        const dlBtn = document.getElementById("downloadLink");
        const newBtn = dlBtn.cloneNode(true);
        dlBtn.parentNode.replaceChild(newBtn, dlBtn);
        newBtn.onclick = handleDownload;
    }

    function handleDownload() {
        if (!finalBlob) return;

        const fileName = `Firstleap_Dub_${Date.now()}.${finalExtension}`;
        const url = URL.createObjectURL(finalBlob);
        
        const link = document.createElement('a');
        link.style.display = 'none';
        link.href = url;
        link.download = fileName;
        
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 10000); // å»¶æ—¶é‡Šæ”¾ï¼Œç¡®ä¿ç§»åŠ¨ç«¯ä¸‹è½½å¯åŠ¨
    }

    function resetRecording() {
      document.getElementById("resultArea").style.display = "none";
      document.getElementById("video-container").style.display = "block";
      
      const video = document.getElementById("mainVideo");
      video.controls = true;
      video.currentTime = 0;
      
      const actionBtn = document.getElementById("actionBtn");
      actionBtn.style.display = "block";
      actionBtn.className = "btn btn-record";
      actionBtn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
      actionBtn.disabled = false;
      
      document.getElementById("statusText").innerText = "ğŸ”„ é‡ç½®å®Œæˆ";
    }
  </script>
</body>
</html>
