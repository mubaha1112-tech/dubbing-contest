<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic (Share Edition)</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --wechat-green: #07C160; /* å¾®ä¿¡ç»¿ */
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-soft: 0 10px 30px rgba(249, 202, 36, 0.15);
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* æ¬¢è¿å±ä¸åŸºç¡€æ ·å¼ä¿æŒä¸€è‡´ï¼Œçœç•¥éƒ¨åˆ†é‡å¤åŠ¨ç”»ä»£ç ä»¥èŠ‚çœç©ºé—´ï¼ŒåŠŸèƒ½ä¸å—å½±å“ */
    .welcome-screen { position: fixed; inset: 0; z-index: 100000; display: flex; align-items: center; justify-content: center; background: radial-gradient(1200px 600px at 50% -10%, #ffb3b3, #ff6f6f, #f38181 60%, #111 100%); transition: opacity .6s ease, visibility .6s ease; visibility: visible; }
    .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .welcome-bgvideo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: saturate(1.1) contrast(1.05) brightness(0.9); }
    .welcome-overlay { position: relative; z-index: 2; text-align: center; color: #fff; padding: 20px; }
    .welcome-title { font-weight: 900; font-size: 34px; letter-spacing: 1px; text-shadow: 3px 3px 0 rgba(0,0,0,0.18); animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2); }
    .welcome-subtitle { margin-top: 8px; font-size: 16px; opacity: .95; text-shadow: 2px 2px 0 rgba(0,0,0,0.12); animation: fadeIn .8s ease .2s both; }
    .welcome-cta { margin-top: 18px; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 999px; background: rgba(255,255,255,0.18); color: #fff; font-weight: 800; border: 1px solid rgba(255,255,255,0.35); backdrop-filter: blur(6px); cursor: pointer; transition: transform .12s ease, background .2s ease; animation: fadeIn .8s ease .35s both; }
    .welcome-skip { position: absolute; right: 12px; top: 12px; z-index: 3; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.25); color: #fff; font-size: 12px; font-weight: 700; cursor: pointer; backdrop-filter: blur(3px); }

    @keyframes titlePop { 0% { transform: translateY(6px) scale(.92); opacity: 0; } 60% { transform: translateY(-2px) scale(1.02); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    h1 { color: var(--rabbit-red); font-size: 26px; margin: 10px 0 25px; text-shadow: 2px 2px 0px #ffe3e3; font-weight: 900; letter-spacing: 1px; position: relative; display: inline-block; }
    h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
    
    /* æ§ä»¶æ ·å¼ */
    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }
    select { width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px; font-size: 16px; background: #fafafa; outline: none; transition: 0.3s; color: #555; font-weight: bold; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 18px; }
    select:focus { border-color: var(--pear-yellow); background-color: #fff; }

    .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 25px; font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px; transition: all 0.2s; box-shadow: var(--shadow-3d); position: relative; overflow: hidden; }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
    
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); animation: pulse 1.5s infinite; position: relative; z-index: 1002; }
    
    /* åˆ†äº«æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .btn-share {
      background: linear-gradient(135deg, #42d392 0%, #07C160 100%); /* å¾®ä¿¡ç»¿æ¸å˜ */
      text-decoration: none; line-height: 1.5; flex: 1; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #fff; font-weight: bold; border-radius: 25px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
      font-size: 18px; padding: 16px; border: none;
    }
    
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }

    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; outline: none; border: 4px solid #fff; object-fit: contain; }
    
    /* å½•åˆ¶æ¨¡å¼CSS */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode video::-webkit-media-controls { display: none !important; }
    body.recording-mode .container { max-width: 100%; height: 100dvh; border-radius: 0; border: none; padding: calc(env(safe-area-inset-top, 0px) + 8px) 10px calc(env(safe-area-inset-bottom, 0px) + 80px); display: flex; flex-direction: column; align-items: center; background: #000; }
    body.recording-mode .step-label, body.recording-mode select, body.recording-mode #searchBtn, body.recording-mode #playBtn, body.recording-mode .tip, body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container { margin: 0; width: 100%; display: flex; flex: 1; flex-direction: column; align-items: center; justify-content: center; background: #000; }
    body.recording-mode #actionBtn { display: none; }
    body.recording-mode .status-text { font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 10px; }

    .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; backdrop-filter: blur(3px); }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .overlay-fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 142, 142, 0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); text-align: center; padding: 16px; box-sizing: border-box; }
    .countdown-number { font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0px rgba(0,0,0,0.1); font-family: "Arial Rounded MT Bold", sans-serif; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
    
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }
    .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
    .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; border: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

    .record-overlay { position: absolute; top: 8px; right: 8px; display: none; gap: 6px; z-index: 999; pointer-events: auto; }
    .record-overlay .btn { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 800; cursor: pointer; border: none; width: auto; margin-top: 0; box-shadow: none; }
    .record-overlay .pause { background: #6c7dff; color: white; }

    /* åˆ†äº«æç¤ºæ°”æ³¡ */
    .share-tip {
        font-size: 12px; 
        color: #666; 
        margin-top: 15px; 
        text-align: center; 
        background: #f0f9eb; 
        border: 1px solid #dcdfe6; 
        padding: 8px; 
        border-radius: 8px;
        line-height: 1.4;
    }
  </style>
</head>
<body class="welcome-active">
  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen" role="dialog" aria-modal="true" aria-label="æ¬¢è¿é¡µ">
    <button class="welcome-skip" id="welcomeSkipBtn">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop preload="auto">
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice Magic</div>
      <div class="welcome-subtitle">é…éŸ³ç§€ (Share Edition)</div>
      <div>
        <button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button>
      </div>
    </div>
  </div>

  <!-- å€’è®¡æ—¶é®ç½© -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
    <div id="buffer-warning" style="font-size:14px; color:#FFD700; margin-top:10px; display:none;">è§†é¢‘æ­£åœ¨ç¼“å†²ï¼Œè¯·ç¨ç­‰...</div>
  </div>

  <!-- å¤„ç†ä¸­é®ç½© -->
  <div id="processing-overlay" class="overlay-fullscreen" style="background: rgba(50, 50, 50, 0.98);">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">
        è§†é¢‘ç”Ÿæˆä¸­...<br>
        <span style="font-size:16px; opacity:0.8; color:#FFD700; font-weight:normal;">
            æ­£åœ¨è½¬ç ä¸º MP4ï¼Œè¯·å‹¿å…³é—­<br>Converting to MP4...
        </span>
    </div>
    <div style="width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 20px; overflow: hidden; padding: 2px;">
      <div class="progress-bar" id="progressBar" style="width: 0%; height: 100%; background: #fff; border-radius: 8px; transition: width 0.2s ease;"></div>
    </div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
  </div>

  <div class="container">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <!-- è§†é¢‘æ’­æ”¾åŒº -->
    <div id="video-container">
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
      </div>

      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous">
        <source src="" type="video/mp4">
      </video>

      <div id="recordOverlay" class="record-overlay">
        <button id="pauseToggleBtn" class="btn pause" onclick="togglePauseDuringRecording()">æš‚åœ</button>
      </div>

      <div class="tip" style="margin-top: 6px;">ğŸ§ <b>æ¸©é¦¨æç¤ºï¼š</b>é…éŸ³å‰è¯·ä½©æˆ´è€³æœºï¼Œä»¥é˜²å›å£°å•¸å«ï¼</div>
      
      <!-- çŠ¶æ€æç¤ºæ–‡å­—ï¼Œç”¨äºæ˜¾ç¤ºå½•åˆ¶ç‰‡å¤´ç­‰ä¿¡æ¯ -->
      <div class="status-text" id="statusText"></div>

      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³</button>

      <canvas id="processCanvas" style="display: none;"></canvas>
    </div>

    <!-- ç»“æœé¢„è§ˆåŒº -->
    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <p style="font-size:12px; color:#999; margin-bottom:15px;">å¦‚æœå¬ä¸åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‰‹æœºé™éŸ³é”®</p>

      <video id="previewVideo" style="width:100%; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); background:#000;" controls playsinline webkit-playsinline></video>

      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <!-- åˆ†äº«/ä¿å­˜æŒ‰é’® -->
        <button id="shareBtn" class="btn btn-share" onclick="handleShareOrSave()" style="display: none;">
            ğŸ“¤ åˆ†äº«/ä¿å­˜è§†é¢‘
        </button>
      </div>
      
      <!-- åˆ†äº«æç¤ºæ–‡æ¡ˆ -->
      <div id="shareHint" class="share-tip" style="display:none;">
          <b>ğŸ“¢ æç¤ºï¼š</b><br>ç‚¹å‡»æŒ‰é’®å°†å°è¯•ç›´æ¥åˆ†äº«ã€‚<br>å¦‚æ— ååº”ï¼Œè§†é¢‘å°†è‡ªåŠ¨ä¿å­˜åˆ°ç›¸å†Œï¼Œ<br>è¯·è¿›å…¥å¾®ä¿¡ä»ç›¸å†Œé€‰æ‹©è§†é¢‘å‘ç»™å¥½å‹ã€‚
      </div>

      <div id="waitingHint" style="text-align: center; margin: 20px 0; display: none;">
        <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--wechat-green); width: 20px; height: 20px;"></div>
        <span style="color: var(--wechat-green); font-weight: bold; font-size: 14px;">å‡†å¤‡æ–‡ä»¶ä¸­...</span>
      </div>
    </div>
  </div>

  <script>
    // åŸºç¡€è§†é¢‘æ•°æ®ï¼ˆä¿æŒä¸å˜ï¼‰
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4"],
      "K3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4"]
      // ... æ‚¨å¯ä»¥ä¿ç•™åŸæœ‰çš„å®Œæ•´æ•°æ®ï¼Œè¿™é‡Œä¸ºæ¼”ç¤ºç²¾ç®€ ...
    };

    // å˜é‡åŒº
    let mediaRecorder;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let videoStream = null;
    let sourceVideo = null;
    let sourceMic = null;
    let dest = null;
    let micGainNode = null;
    let videoGainNode = null;
    let isRecording = false;
    let isIntroMode = false;
    let introImageObj = null;
    let animationFrameId = null;
    let hasMicPermission = false;
    
    // å…¨å±€æ–‡ä»¶å¯¹è±¡
    let finalBlob = null;
    let finalFilename = '';
    let processingInterval = null;
    let processingProgress = 0;

    // éŸ³é¢‘ä¸Šä¸‹æ–‡
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    function initializeAudioContext() {
      if (!audioCtx || audioCtx.state === 'closed') audioCtx = new AudioContext();
    }

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰æ¡† (ç®€åŒ–)
    (function initSelectors(){
        const levelSelect = document.getElementById("levelSelect");
        // æ¨¡æ‹Ÿæ•°æ®å¡«å……ï¼Œè¯·ä½¿ç”¨æ‚¨åŸæœ¬çš„å®Œæ•´ key
        Object.keys(videoDatabase).forEach(lvl => {
            let opt = document.createElement("option");
            opt.value = lvl; opt.text = lvl;
            levelSelect.appendChild(opt);
        });
    })();

    function updateUnits() {
        // ä¸åŸé€»è¾‘ä¸€è‡´...
        const lvl = document.getElementById("levelSelect").value;
        const unitSelect = document.getElementById("unitSelect");
        unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ --</option>';
        unitSelect.disabled = true;
        if (lvl && videoDatabase[lvl]) {
            videoDatabase[lvl].forEach((url, i) => {
                if(url) {
                    let opt = document.createElement("option");
                    opt.value = i; opt.text = "Unit " + (i + 1);
                    unitSelect.appendChild(opt);
                    unitSelect.disabled = false;
                }
            });
        }
    }

    // 2. æŸ¥æ‰¾è§†é¢‘
    function findVideo() {
        const lvl = document.getElementById("levelSelect").value;
        const unitIndex = document.getElementById("unitSelect").value;
        if (!lvl || unitIndex === "") return alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼");

        const url = videoDatabase[lvl][unitIndex];
        const videoPlayer = document.getElementById("mainVideo");
        
        document.getElementById("resultArea").style.display = "none";
        document.getElementById("video-container").style.display = "block";
        document.getElementById("loaderOverlay").style.display = "flex";
        document.getElementById("actionBtn").style.display = "none"; // åŠ è½½å®Œæˆå‰éšè—å½•åˆ¶æŒ‰é’®

        videoPlayer.src = url;
        videoPlayer.load();
        
        videoPlayer.oncanplaythrough = function() {
            document.getElementById("loaderOverlay").style.display = "none";
            document.getElementById("actionBtn").style.display = "block";
            document.getElementById("actionBtn").className = "btn btn-record";
            document.getElementById("actionBtn").innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
            document.getElementById("playBtn").style.display = "block";
            document.getElementById("statusText").innerText = "âœ… è§†é¢‘å°±ç»ªï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹";
            document.getElementById("statusText").style.color = "var(--wechat-green)";
        };
        
        // å¢åŠ æ˜æ˜¾çš„ç¼“å†²æç¤º
        videoPlayer.onwaiting = function() {
             document.getElementById("statusText").innerText = "â³ è§†é¢‘ç¼“å†²ä¸­ (Buffering)...";
             document.getElementById("statusText").style.color = "#ffa502";
        };
        
        videoPlayer.onplaying = function() {
             if(!isRecording) {
                 document.getElementById("statusText").innerText = "â–¶ï¸ æ­£åœ¨é¢„è§ˆ";
                 document.getElementById("statusText").style.color = "#333";
             }
        };
    }

    function togglePreview() {
        const v = document.getElementById("mainVideo");
        v.paused ? v.play() : v.pause();
    }

    async function checkMicPermissionAndResumeAudio() {
        initializeAudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        if (hasMicPermission && micStream) return true;
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true } });
            hasMicPermission = true;
            return true;
        } catch (err) {
            alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•å½•éŸ³ã€‚è¯·åœ¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£ã€‚");
            return false;
        }
    }

    // 3. å¼€å§‹å½•åˆ¶æµç¨‹
    function toggleRecording() {
        isRecording ? stopRecording() : prepareAndStartRecording();
    }

    async function prepareAndStartRecording() {
        const video = document.getElementById("mainVideo");
        
        // ä¿®å¤ç­‰å¾…é€»è¾‘ï¼šå¦‚æœä¸å…·å¤‡æ’­æ”¾æ¡ä»¶ï¼Œæ˜ç¡®æç¤º
        if (video.readyState < 2) {
            alert("è§†é¢‘æ­£åœ¨ç¼“å†²ä¸­ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»å†è¯•ï¼ˆç½‘é€Ÿå¯èƒ½è¾ƒæ…¢ï¼‰ã€‚");
            return;
        }

        const perm = await checkMicPermissionAndResumeAudio();
        if (!perm) return;

        video.pause();
        video.controls = false;
        
        // å€’è®¡æ—¶ UI
        const overlay = document.getElementById('countdown-overlay');
        const text = document.getElementById('countdownText');
        const bufferWarn = document.getElementById('buffer-warning');
        
        overlay.style.display = 'flex';
        bufferWarn.style.display = 'none';
        
        let count = 3;
        text.innerText = count;
        
        const timer = setInterval(() => {
            count--;
            // åœ¨å€’è®¡æ—¶è¿‡ç¨‹ä¸­å†æ¬¡æ£€æŸ¥è§†é¢‘çŠ¶æ€
            if(video.readyState < 2) {
                bufferWarn.style.display = 'block'; // å¦‚æœçªç„¶å¡é¡¿ï¼Œæ˜¾ç¤ºç¼“å†²è­¦å‘Š
            } else {
                bufferWarn.style.display = 'none';
            }

            if (count > 0) {
                text.innerText = count;
                // é‡ç½®åŠ¨ç”»
                text.style.animation = 'none';
                text.offsetHeight; /* trigger reflow */
                text.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            } else {
                clearInterval(timer);
                text.innerText = "GO!";
                setTimeout(() => {
                    overlay.style.display = 'none';
                    enterFullscreenMode();
                    executeActualRecording();
                }, 500);
            }
        }, 1000);
    }

    function executeActualRecording() {
        const video = document.getElementById("mainVideo");
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");
        const status = document.getElementById("statusText");
        
        // Setup Web Audio Graph (Mixer)
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
        
        try { canvasStream = canvas.captureStream(30); } catch(e) { return alert("æµè§ˆå™¨ä¸æ”¯æŒ"); }
        
        dest = audioCtx.createMediaStreamDestination();
        micGainNode = audioCtx.createGain();
        videoGainNode = audioCtx.createGain();
        
        // Intro æ—¶é™éŸ³
        micGainNode.gain.value = 0;
        videoGainNode.gain.value = 0;

        if (micStream) {
            sourceMic = audioCtx.createMediaStreamSource(micStream);
            sourceMic.connect(micGainNode).connect(dest);
        }
        
        // å°è¯•æ··åˆè§†é¢‘åŸå£°ï¼ˆå¯é€‰ï¼‰
        try {
            if (!video._source) video._source = audioCtx.createMediaElementSource(video);
            sourceVideo = video._source;
            sourceVideo.connect(videoGainNode).connect(dest);
            dest.connect(audioCtx.destination); // Let user hear it too
        } catch(e) { console.log("Audio source exists"); }

        // Combined Stream
        let finalStream = new MediaStream([
            canvasStream.getVideoTracks()[0],
            dest.stream.getAudioTracks()[0] || (micStream ? micStream.getAudioTracks()[0] : null)
        ].filter(t => t));

        // MIME Type Selection for MP4/Share compatibility
        let mime = 'video/webm;codecs=h264'; // Default fallback
        if (MediaRecorder.isTypeSupported("video/mp4")) mime = "video/mp4";
        else if (MediaRecorder.isTypeSupported("video/mp4;codecs=avc1")) mime = "video/mp4;codecs=avc1";
        
        try {
            mediaRecorder = new MediaRecorder(finalStream, { mimeType: mime, videoBitsPerSecond: 2500000 });
        } catch(e) {
            mediaRecorder = new MediaRecorder(finalStream); // Fallback to browser default
        }

        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = finishProcessing;

        // UI Update
        const actionBtn = document.getElementById("actionBtn");
        document.getElementById("playBtn").style.display = "none";
        actionBtn.innerHTML = "â¹ï¸ å®Œæˆé…éŸ³ Stop";
        actionBtn.className = "btn btn-stop";
        document.getElementById('recordOverlay').style.display = 'flex';

        // Start Logic
        introImageObj = new Image();
        introImageObj.crossOrigin = "anonymous";
        introImageObj.src = "intro.png"; // è¯·ç¡®ä¿ç›®å½•ä¸‹æœ‰æ­¤å›¾ç‰‡ï¼Œå¦åˆ™æ˜¯é»‘å±

        const start = () => {
            mediaRecorder.start();
            isRecording = true;
            isIntroMode = true;
            
            // ä¿®å¤ç­‰å¾…æ„Ÿï¼šæ˜ç¡®æç¤ºè¿™æ˜¯ Intro
            status.innerText = "ğŸ¬ æ­£åœ¨å½•åˆ¶ç‰‡å¤´ (Recording Intro)..."; 
            status.style.color = "var(--pear-yellow)";
            
            drawLoop();

            // ä¿®å¤ç­‰å¾…æ„Ÿï¼šå°† Intro æ—¶é—´ä» 3000ms å‡å°‘åˆ° 1500ms
            setTimeout(() => {
                isIntroMode = false;
                // Unmute
                micGainNode.gain.value = 1.0; 
                videoGainNode.gain.value = 1.0; 
                
                video.currentTime = 0;
                video.volume = 1.0;
                video.play().then(() => {
                   status.innerText = "ğŸ”´ å½•éŸ³ä¸­ (Recording)...";
                   status.style.color = "#FF0000";
                });
                
                video.onended = stopRecording;
            }, 1500); // 1.5ç§’ç‰‡å¤´å³å¯
        };

        introImageObj.onload = start;
        introImageObj.onerror = start; // å³ä½¿å›¾ç‰‡åŠ è½½å¤±è´¥ä¹Ÿå¼€å§‹
    }

    function drawLoop() {
        if (!isRecording) { cancelAnimationFrame(animationFrameId); return; }
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");
        const video = document.getElementById("mainVideo");

        if (isIntroMode) {
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,canvas.width,canvas.height);
            if (introImageObj && introImageObj.complete) {
                // Draw image centered
                ctx.drawImage(introImageObj, 0, 0, canvas.width, canvas.height);
            }
        } else {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        animationFrameId = requestAnimationFrame(drawLoop);
    }

    function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        cancelAnimationFrame(animationFrameId);
        exitFullscreenMode();
        
        const video = document.getElementById("mainVideo");
        video.pause();
        
        try { mediaRecorder.stop(); } catch(e){}
        
        // Show processing UI
        document.getElementById('processing-overlay').style.display = 'flex';
        simulateProgress();
        
        document.getElementById("actionBtn").disabled = true;
        document.getElementById("recordOverlay").style.display = "none";
    }

    function simulateProgress() {
        let p = 0;
        const bar = document.getElementById('progressBar');
        const txt = document.getElementById('progressText');
        processingInterval = setInterval(() => {
            if (p < 90) {
                p += Math.random() * 5;
                if (p > 90) p = 90;
                bar.style.width = p + "%";
                txt.innerText = Math.floor(p) + "%";
            }
        }, 100);
    }

    function finishProcessing() {
        // æ¸…ç†éŸ³é¢‘æµ
        if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
        if(canvasStream) canvasStream.getTracks().forEach(t=>t.stop());
        
        // å¿«é€Ÿèµ°å®Œè¿›åº¦æ¡
        clearInterval(processingInterval);
        document.getElementById('progressBar').style.width = "100%";
        document.getElementById('progressText').innerText = "100%";
        
        setTimeout(() => {
            document.getElementById('processing-overlay').style.display = 'none';
            showResult();
        }, 500);
    }

    function showResult() {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        finalBlob = blob;
        finalFilename = `Firstleap_Voice_${Date.now()}.mp4`;
        
        const url = URL.createObjectURL(blob);
        const preview = document.getElementById("previewVideo");
        preview.src = url;
        
        document.getElementById("actionBtn").style.display = "none";
        document.getElementById("resultArea").style.display = "block";
        document.getElementById("shareBtn").style.display = "flex"; // æ˜¾ç¤ºåˆ†äº«æŒ‰é’®
        document.getElementById("shareHint").style.display = "block"; // æ˜¾ç¤ºæç¤º
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        document.getElementById("resultArea").scrollIntoView({behavior: "smooth"});
        document.getElementById("statusText").innerText = "";
    }

    // 4. æ ¸å¿ƒä¿®æ”¹ï¼šåˆ†äº«æˆ–ä¿å­˜é€»è¾‘
    async function handleShareOrSave() {
        const shareBtn = document.getElementById("shareBtn");
        const waitingHint = document.getElementById("waitingHint");
        
        shareBtn.style.display = "none";
        waitingHint.style.display = "block";

        const file = new File([finalBlob], finalFilename, { type: 'video/mp4' });

        // ä¼˜å…ˆå°è¯•åŸç”Ÿåˆ†äº« (Navigator.share)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'æˆ‘çš„è‹±è¯­é…éŸ³ä½œå“',
                    text: 'å¿«æ¥çœ‹çœ‹æˆ‘çš„ Firstleap Voice Magic é…éŸ³ç§€ï¼'
                });
                // åˆ†äº«æˆåŠŸæˆ–é¢æ¿æ‰“å¼€å
                waitingHint.style.display = "none";
                shareBtn.style.display = "flex";
            } catch (err) {
                console.log("Share API error or cancelled:", err);
                // å¦‚æœç”¨æˆ·å–æ¶ˆæˆ–ä¸æ”¯æŒï¼Œå›é€€åˆ°ä¸‹è½½
                fallbackToDownload();
            }
        } else {
            // ä¸æ”¯æŒåˆ†äº«APIï¼ˆå¦‚æ¡Œé¢ç«¯æˆ–éƒ¨åˆ†å®‰å“Webviewï¼‰ï¼Œç›´æ¥ä¸‹è½½
            fallbackToDownload();
        }
    }

    function fallbackToDownload() {
        const waitingHint = document.getElementById("waitingHint");
        const shareBtn = document.getElementById("shareBtn");
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const a = document.createElement("a");
        a.href = URL.createObjectURL(finalBlob);
        a.download = finalFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        waitingHint.style.display = "none";
        shareBtn.style.display = "flex";
        
        alert("å·²è§¦å‘è§†é¢‘ä¿å­˜ã€‚\n\nç”±äºå¾®ä¿¡é™åˆ¶ï¼Œè¯·å…ˆå°†è§†é¢‘ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œï¼Œç„¶åæ‰“å¼€å¾®ä¿¡å‘é€ç»™å¥½å‹ã€‚");
    }

    function resetRecording() {
        document.getElementById("resultArea").style.display = "none";
        const btn = document.getElementById("actionBtn");
        btn.style.display = "block";
        btn.disabled = false;
        btn.innerHTML = "ğŸ™ï¸ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹é…éŸ³";
        btn.className = "btn btn-record";
        
        document.getElementById("playBtn").style.display = "block";
        document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®";
        
        const v = document.getElementById("mainVideo");
        v.controls = true;
        v.currentTime = 0;
        v.pause();
        
        document.getElementById("video-container").scrollIntoView({behavior:"smooth"});
    }

    // å…¨å±è¾…åŠ©å·¥å…·
    function enterFullscreenMode() {
      document.body.classList.add('recording-mode');
      const doc = document.documentElement;
      if (doc.requestFullscreen) doc.requestFullscreen().catch(()=>{});
      else if (doc.webkitRequestFullScreen) doc.webkitRequestFullScreen().catch(()=>{});
    }
    function exitFullscreenMode() {
      document.body.classList.remove('recording-mode');
      if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
      else if (document.webkitCancelFullScreen) document.webkitCancelFullScreen().catch(()=>{});
    }

    function togglePauseDuringRecording() {
      const v = document.getElementById("mainVideo");
      const b = document.getElementById("pauseToggleBtn");
      if(v.paused) { v.play(); b.innerText="æš‚åœ"; } else { v.pause(); b.innerText="ç»§ç»­"; }
    }
    
    // æ¬¢è¿é¡µé€»è¾‘
    const welcome = document.getElementById('welcome');
    document.getElementById('welcomeSkipBtn').onclick = () => {
        welcome.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        document.getElementById('welcomeVideo').pause();
    };
    document.getElementById('welcomeEnterBtn').onclick = async () => {
        await checkMicPermissionAndResumeAudio();
        document.getElementById('welcomeSkipBtn').click();
    };
  </script>
</body>
</html>
