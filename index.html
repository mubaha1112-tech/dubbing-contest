<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic (Instant Edition)</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --wechat-green: #07C160;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }

    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
    }

    .container {
      background: var(--card-white);
      padding: 25px 20px;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
      transition: all 0.3s ease;
    }

    /* æ¬¢è¿å± */
    .welcome-screen { position: fixed; inset: 0; z-index: 100000; display: flex; align-items: center; justify-content: center; background: #000; transition: opacity .6s ease, visibility .6s ease; visibility: visible; }
    .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .welcome-bgvideo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
    .welcome-overlay { position: relative; z-index: 2; text-align: center; color: #fff; padding: 20px; }
    .welcome-title { font-weight: 900; font-size: 34px; margin-bottom: 10px; animation: titlePop .9s cubic-bezier(.2,.9,.2,1.2); }
    .welcome-cta { padding: 10px 20px; border-radius: 999px; background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.4); backdrop-filter: blur(5px); cursor: pointer; font-weight: bold; }
    .welcome-skip { position: absolute; right: 15px; top: 15px; z-index: 3; padding: 6px 12px; border-radius: 20px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #fff; font-size: 12px; }

    @keyframes titlePop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

    h1 { color: var(--rabbit-red); font-size: 26px; margin: 10px 0 25px; text-shadow: 2px 2px 0px #ffe3e3; font-weight: 900; letter-spacing: 1px; position: relative; display: inline-block; }
    h1::after { content: "âœ¨"; position: absolute; right: -25px; top: 0; font-size: 20px; animation: bounce 2s infinite; }
    
    .step-label { text-align: left; margin: 15px 0 5px 5px; font-weight: bold; color: #888; font-size: 14px; display: flex; align-items: center; }
    .step-badge { background: var(--pear-yellow); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; }
    select { width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 18px; font-size: 16px; background: #fafafa; outline: none; -webkit-appearance: none; }
    
    .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 25px; font-size: 18px; font-weight: 800; cursor: pointer; color: white; margin-top: 15px; transition: all 0.2s; box-shadow: var(--shadow-3d); }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn:disabled { background: #ccc; box-shadow: none; transform: none; }
    
    .btn-primary { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
    .btn-play { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); display: none; margin-bottom: 10px; }
    .btn-record { background: linear-gradient(to right, #ff5f6d, #ffc371); display: none; }
    .btn-stop { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); animation: pulse 1.5s infinite; position: relative; z-index: 1002; }
    .btn-share { background: linear-gradient(135deg, #42d392 0%, #07C160 100%); display: none; }
    .btn-retry { background: #dfe6e9; color: #636e72; box-shadow: 0 4px 0 #b2bec3; flex: 1; }
    .btn-group { display: flex; gap: 15px; margin-top: 15px; }

    #video-container { margin-top: 25px; display: none; position: relative; min-height: 200px; }
    video { width: 100%; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: #000; border: 4px solid #fff; object-fit: contain; }
    
    /* å½•åˆ¶æ¨¡å¼ */
    body.recording-mode { overflow: hidden; background: #000; padding: 0; }
    body.recording-mode .container { max-width: 100%; height: 100dvh; border-radius: 0; border: none; padding: calc(env(safe-area-inset-top) + 10px) 10px 80px; display: flex; flex-direction: column; background: #000; }
    body.recording-mode .step-label, body.recording-mode select, body.recording-mode #searchBtn, body.recording-mode #playBtn, body.recording-mode .tip, body.recording-mode h1 { display: none !important; }
    body.recording-mode #video-container { margin: 0; width: 100%; display: flex; flex: 1; flex-direction: column; justify-content: center; background: #000; }
    body.recording-mode #actionBtn { display: none; } /* éšè—åŸæ¥çš„æŒ‰é’®ï¼Œä½¿ç”¨æµ®åŠ¨åœæ­¢ */
    body.recording-mode video::-webkit-media-controls { display: none !important; }

    /* æµ®åŠ¨åœæ­¢æŒ‰é’® (å½•åˆ¶æ¨¡å¼ä¸‹ä½¿ç”¨) */
    .floating-stop-btn {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        width: 70px; height: 70px; border-radius: 50%;
        background: #EE5253; border: 4px solid #fff;
        box-shadow: 0 0 15px rgba(238, 82, 83, 0.6);
        z-index: 1003; display: none;
        align-items: center; justify-content: center;
        font-size: 24px; color: white; cursor: pointer;
        animation: pulse 1.5s infinite;
    }
    body.recording-mode .floating-stop-btn { display: flex; }

    .loader-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 20px; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--rabbit-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* å€’è®¡æ—¶é®ç½© */
    .overlay-fullscreen { position: fixed; inset: 0; background: rgba(255, 142, 142, 0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
    .countdown-number { font-size: 150px; color: #fff; font-weight: 900; text-shadow: 4px 4px 0 rgba(0,0,0,0.1); animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .overlay-text { font-size: 24px; color: #fff; margin-top: 20px; font-weight: bold; }
    
    .status-text { margin-top: 15px; font-weight: bold; color: var(--rabbit-red); min-height: 24px; font-size: 15px; }
    .preview-box { margin-top: 25px; padding: 20px; border: 3px dashed var(--pear-yellow); border-radius: 20px; display: none; background: #fffcf0; }
    .tip { font-size: 13px; color: #e67e22; margin-top: 12px; background: #fff3e0; padding: 12px; border-radius: 15px; }

    /* è¿›åº¦æ¡å¤„ç†é®ç½© */
    #processing-overlay { background: rgba(30, 30, 30, 0.98); }
    .progress-bar-container { width: 80%; max-width: 300px; height: 16px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-top: 20px; overflow: hidden; }
    .progress-bar { width: 0%; height: 100%; background: var(--monster-green); border-radius: 8px; transition: width 0.2s; }
  </style>
</head>
<body class="welcome-active">

  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome" class="welcome-screen">
    <button class="welcome-skip" id="welcomeSkipBtn">è·³è¿‡</button>
    <video id="welcomeVideo" class="welcome-bgvideo" muted autoplay playsinline loop>
      <source src="opener.mp4" type="video/mp4">
    </video>
    <div class="welcome-overlay">
      <div class="welcome-title">Firstleap Voice</div>
      <div style="margin-bottom:20px;">Magic Dubbing</div>
      <button id="welcomeEnterBtn" class="welcome-cta">è¿›å…¥ä½“éªŒ â–¶</button>
    </div>
  </div>

  <!-- å€’è®¡æ—¶ (åŒæ—¶ä¹Ÿæ˜¯åå°å½•åˆ¶ç‰‡å¤´çš„æ—¶é—´) -->
  <div id="countdown-overlay" class="overlay-fullscreen">
    <div class="countdown-number" id="countdownText">3</div>
    <div class="overlay-text">Ready?</div>
    <div style="font-size:14px; color:#FFD700; margin-top:10px; opacity: 0.8;">
        (ç‰‡å¤´å½•åˆ¶ä¸­... Recording Intro)
    </div>
  </div>

  <!-- å¤„ç†ä¸­ -->
  <div id="processing-overlay" class="overlay-fullscreen">
    <div style="font-size: 60px;">âš™ï¸</div>
    <div class="overlay-text">ç”Ÿæˆè§†é¢‘ä¸­...<br><span style="font-size:14px; font-weight:normal; opacity:0.8;">Making Magic...</span></div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div style="color:white; margin-top:10px; font-weight:bold;" id="progressText">0%</div>
  </div>

  <!-- æµ®åŠ¨åœæ­¢æŒ‰é’® -->
  <div class="floating-stop-btn" onclick="stopRecording()" id="floatingStopBtn">â¹</div>

  <div class="container">
    <h1>Firstleap Voice Magic<br><span style="font-size:18px; color:#888; font-weight:normal;">é…éŸ³ç§€</span></h1>

    <div class="step-label"><span class="step-badge">1</span>é€‰æ‹©çº§åˆ«</div>
    <select id="levelSelect" onchange="updateUnits()">
      <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
    </select>

    <div class="step-label"><span class="step-badge">2</span>é€‰æ‹©å•å…ƒ</div>
    <select id="unitSelect" disabled>
      <option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option>
    </select>

    <button class="btn btn-primary" id="searchBtn" onclick="findVideo()">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>

    <!-- è§†é¢‘æ’­æ”¾åŒº -->
    <div id="video-container">
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #555; font-weight: bold;">åŠ è½½ä¸­ Loading...</div>
      </div>

      <!-- éšè—çš„Canvasç”¨äºåˆæˆ -->
      <canvas id="processCanvas" style="display: none;"></canvas>

      <video id="mainVideo" playsinline webkit-playsinline x5-playsinline controls controlsList="nodownload" crossOrigin="anonymous">
        <source src="" type="video/mp4">
      </video>

      <div class="status-text" id="statusText"></div>
      <div class="tip">ğŸ§ <b>Tipï¼š</b>è¯·ä½©æˆ´è€³æœºä»¥è·å¾—æœ€ä½³æ•ˆæœ (Use Headphones)</div>

      <button class="btn btn-play" id="playBtn" onclick="togglePreview()">â–¶ï¸ é¢„è§ˆåŸç‰‡ Preview</button>
      <button class="btn btn-record" id="actionBtn" onclick="toggleRecording()">ğŸ™ï¸ å¼€å§‹é…éŸ³ Start Dubbing</button>
    </div>

    <!-- ç»“æœé¢„è§ˆåŒº -->
    <div id="resultArea" class="preview-box">
      <h3 style="color:var(--rabbit-red); margin-top:0;">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</h3>
      <video id="previewVideo" style="width:100%; border-radius:15px; background:#000;" controls playsinline></video>

      <div class="btn-group">
        <button class="btn btn-retry" onclick="resetRecording()">ğŸ”„ é‡å½• Retry</button>
        <button id="shareBtn" class="btn btn-share" onclick="handleShareOrSave()" style="flex:1;">ğŸ“¤ ä¿å­˜è§†é¢‘ Save</button>
      </div>
      <div id="shareHint" style="font-size:12px; color:#666; margin-top:10px; display:none;">
          è§†é¢‘å°†ä¿å­˜åˆ°ç›¸å†Œï¼Œè¯·ä»ç›¸å†Œå‘é€ç»™è€å¸ˆã€‚
      </div>
    </div>
  </div>

  <script>
    // åŸºç¡€æ•°æ®
    const videoDatabase = {
      "K2A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4"],
      "K3A": ["https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4"]
    };

    // å…¨å±€å˜é‡
    let mediaRecorder;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let canvasStream = null;
    let videoStream = null; // ç”¨äºCanvasæ•è·çš„æµ
    let sourceVideo = null;
    let sourceMic = null;
    let dest = null;
    let micGainNode = null;
    let videoGainNode = null;
    let isRecording = false;
    let isIntroMode = false; // æ˜¯å¦å¤„äºç‰‡å¤´å½•åˆ¶é˜¶æ®µ
    let introImageObj = null;
    let animationFrameId = null;
    let hasMicPermission = false;
    let finalBlob = null;
    let processingInterval = null;

    // é¢„åŠ è½½ç‰‡å¤´å›¾ç‰‡
    const introImg = new Image();
    introImg.crossOrigin = "anonymous";
    introImg.src = "intro.png"; // è¯·ç¡®ä¿ç›®å½•ä¸‹æœ‰æ­¤å›¾ç‰‡ï¼Œæˆ–æ›¿æ¢ä¸ºåœ¨çº¿URL

    const AudioContext = window.AudioContext || window.webkitAudioContext;

    // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    (function initSelectors(){
        const levelSelect = document.getElementById("levelSelect");
        Object.keys(videoDatabase).forEach(lvl => {
            let opt = document.createElement("option");
            opt.value = lvl; opt.text = lvl;
            levelSelect.appendChild(opt);
        });
    })();

    function updateUnits() {
        const lvl = document.getElementById("levelSelect").value;
        const unitSelect = document.getElementById("unitSelect");
        unitSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•å…ƒ --</option>';
        unitSelect.disabled = true;
        if (lvl && videoDatabase[lvl]) {
            videoDatabase[lvl].forEach((url, i) => {
                if(url) {
                    let opt = document.createElement("option");
                    opt.value = i; opt.text = "Unit " + (i + 1);
                    unitSelect.appendChild(opt);
                    unitSelect.disabled = false;
                }
            });
        }
    }

    function findVideo() {
        const lvl = document.getElementById("levelSelect").value;
        const unitIndex = document.getElementById("unitSelect").value;
        if (!lvl || unitIndex === "") return alert("è¯·å…ˆé€‰æ‹©çº§åˆ«å’Œå•å…ƒï¼");

        const url = videoDatabase[lvl][unitIndex];
        const videoPlayer = document.getElementById("mainVideo");
        
        document.getElementById("resultArea").style.display = "none";
        document.getElementById("video-container").style.display = "block";
        document.getElementById("loaderOverlay").style.display = "flex";
        document.getElementById("actionBtn").style.display = "none"; 

        videoPlayer.src = url;
        videoPlayer.load();
        
        videoPlayer.oncanplaythrough = function() {
            document.getElementById("loaderOverlay").style.display = "none";
            document.getElementById("actionBtn").style.display = "block";
            document.getElementById("actionBtn").className = "btn btn-record";
            document.getElementById("actionBtn").innerHTML = "ğŸ™ï¸ å¼€å§‹é…éŸ³ Start Dubbing";
            document.getElementById("playBtn").style.display = "block";
            document.getElementById("statusText").innerText = "";
        };
    }

    function togglePreview() {
        const v = document.getElementById("mainVideo");
        v.paused ? v.play() : v.pause();
    }

    async function checkMicPermissionAndResumeAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        if (hasMicPermission && micStream) return true;
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true } });
            hasMicPermission = true;
            return true;
        } catch (err) {
            alert("éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½é…éŸ³ã€‚è¯·åœ¨è®¾ç½®ä¸­å…è®¸ã€‚");
            return false;
        }
    }

    // --- æ ¸å¿ƒå½•åˆ¶é€»è¾‘ ---

    function toggleRecording() {
        if(isRecording) stopRecording();
        else startRecordingSequence();
    }

    async function startRecordingSequence() {
        const video = document.getElementById("mainVideo");
        if (video.readyState < 2) return alert("è§†é¢‘ç¼“å†²ä¸­...");

        const perm = await checkMicPermissionAndResumeAudio();
        if (!perm) return;

        // è¿›å…¥å…¨å±å½•åˆ¶æ¨¡å¼
        enterFullscreenMode();

        // 1. åˆå§‹åŒ–å½•åˆ¶ä¸Šä¸‹æ–‡ï¼ˆCanvas, AudioNodeç­‰ï¼‰
        setupRecordingContext();

        // 2. ç«‹å³å¼€å§‹ MediaRecorder å½•åˆ¶ï¼ˆæ­¤æ—¶æ˜¯ç‰‡å¤´æ¨¡å¼ï¼‰
        // è¿™é‡Œæ˜¯ä¼˜åŒ–çš„å…³é”®ï¼šæˆ‘ä»¬åœ¨å€’è®¡æ—¶å¼€å§‹æ—¶ï¼Œå°±å·²ç»åœ¨å½•åˆ¶äº†
        isRecording = true;
        isIntroMode = true;
        mediaRecorder.start(); 
        
        // åˆå§‹çŠ¶æ€ï¼šé™éŸ³ï¼ˆä¸å½•å…¥å€’è®¡æ—¶å£°éŸ³ï¼‰ã€ç”»é¢ç»˜åˆ¶ Intro å›¾ç‰‡
        if(micGainNode) micGainNode.gain.value = 0;
        if(videoGainNode) videoGainNode.gain.value = 0;
        
        // å¼€å¯ç»˜å›¾å¾ªç¯ (Intro -> Video)
        drawLoop();

        // 3. æ˜¾ç¤ºå€’è®¡æ—¶ UI (3ç§’)
        // è¿™3ç§’é’Ÿå†…ï¼Œåå°æ­£åœ¨å½•åˆ¶ intro.png
        const overlay = document.getElementById('countdown-overlay');
        const countText = document.getElementById('countdownText');
        overlay.style.display = 'flex';
        
        let count = 3;
        countText.innerText = count;
        
        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                countText.innerText = count;
                // é‡ç½®åŠ¨ç”»
                countText.style.animation = 'none';
                countText.offsetHeight; 
                countText.style.animation = 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            } else {
                clearInterval(timer);
                countText.innerText = "GO!";
                
                // å€’è®¡æ—¶ç»“æŸï¼Œåˆ‡æ¢çŠ¶æ€
                setTimeout(() => {
                    overlay.style.display = 'none';
                    startDubbingPhase(); // åˆ‡æ¢åˆ°æ­£ç‰‡å½•åˆ¶
                }, 800);
            }
        }, 1000); // æ¯ä¸€ç§’è·³ä¸€æ¬¡ï¼Œå…±çº¦ 3-4 ç§’ï¼Œè¶³å¤Ÿå±•ç¤ºç‰‡å¤´
    }

    function setupRecordingContext() {
        const video = document.getElementById("mainVideo");
        const canvas = document.getElementById("processCanvas");
        
        // è®¾ç½®Canvaså°ºå¯¸åŒ¹é…è§†é¢‘
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
        
        // è·å–Canvasæµ
        canvasStream = canvas.captureStream(30);
        
        // éŸ³é¢‘æ··åˆ
        dest = audioCtx.createMediaStreamDestination();
        micGainNode = audioCtx.createGain();
        videoGainNode = audioCtx.createGain();
        
        // éº¦å…‹é£æº
        if (micStream) {
            sourceMic = audioCtx.createMediaStreamSource(micStream);
            sourceMic.connect(micGainNode).connect(dest);
        }
        
        // è§†é¢‘éŸ³é¢‘æº (å¦‚æœè§†é¢‘æœ‰å£°éŸ³)
        try {
            if (!video._source) video._source = audioCtx.createMediaElementSource(video);
            sourceVideo = video._source;
            sourceVideo.connect(videoGainNode).connect(dest);
        } catch(e) { console.log("Audio source exists"); }

        dest.connect(audioCtx.destination); // ä¸ºäº†è®©ç”¨æˆ·ä¹Ÿèƒ½å¬åˆ°è§†é¢‘å£°

        // åˆå¹¶æµ
        let finalStream = new MediaStream([
            canvasStream.getVideoTracks()[0],
            dest.stream.getAudioTracks()[0]
        ]);

        let mime = 'video/webm;codecs=h264';
        if (MediaRecorder.isTypeSupported("video/mp4")) mime = "video/mp4";
        
        recordedChunks = [];
        try {
            mediaRecorder = new MediaRecorder(finalStream, { mimeType: mime, videoBitsPerSecond: 2500000 });
        } catch (e) {
            mediaRecorder = new MediaRecorder(finalStream);
        }
        
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = finishProcessing;
    }

    // ç»˜åˆ¶å¾ªç¯ï¼šè´Ÿè´£æŠŠ å›¾ç‰‡ æˆ– è§†é¢‘ ç”»åˆ° Canvas ä¸Š
    function drawLoop() {
        if (!isRecording && !isIntroMode) { cancelAnimationFrame(animationFrameId); return; }
        
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");
        const video = document.getElementById("mainVideo");

        if (isIntroMode) {
            // ç»˜åˆ¶ç‰‡å¤´
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,canvas.width,canvas.height);
            // ä¿æŒæ¯”ä¾‹ç»˜åˆ¶å›¾ç‰‡å±…ä¸­
            if (introImg.complete) {
                const ratio = Math.min(canvas.width / introImg.width, canvas.height / introImg.height);
                const w = introImg.width * ratio;
                const h = introImg.height * ratio;
                ctx.drawImage(introImg, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
            } else {
                ctx.fillStyle = "#FF8E8E";
                ctx.font = "bold 40px Arial";
                ctx.textAlign = "center";
                ctx.fillText("Firstleap Voice Magic", canvas.width/2, canvas.height/2);
            }
        } else {
            // ç»˜åˆ¶è§†é¢‘
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        
        animationFrameId = requestAnimationFrame(drawLoop);
    }

    function startDubbingPhase() {
        const video = document.getElementById("mainVideo");
        const status = document.getElementById("statusText");

        // åˆ‡æ¢æ ‡å¿—ä½ï¼šdrawLoop ç°åœ¨å¼€å§‹ç”»è§†é¢‘å¸§äº†
        isIntroMode = false;

        // æ’­æ”¾è§†é¢‘
        video.currentTime = 0;
        video.play().then(() => {
            // å¼€å¯å£°éŸ³å½•åˆ¶
            micGainNode.gain.value = 1.0; 
            videoGainNode.gain.value = 1.0; 
            
            status.innerText = "ğŸ”´ å½•éŸ³ä¸­ Recording...";
            status.style.color = "#FF0000";
            
            // è§†é¢‘ç»“æŸè‡ªåŠ¨åœæ­¢
            video.onended = () => {
                // å»¶è¿Ÿä¸€ç‚¹ç‚¹åœæ­¢ï¼Œé¿å…æœ€åä¸€å¥è¢«åˆ‡æ‰
                setTimeout(stopRecording, 500);
            };
        }).catch(e => {
            console.error(e);
            status.innerText = "âŒ æ’­æ”¾å¤±è´¥";
        });
    }

    function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        
        const video = document.getElementById("mainVideo");
        video.pause();
        video.onended = null;
        
        cancelAnimationFrame(animationFrameId);
        exitFullscreenMode();
        
        // åœæ­¢å½•åˆ¶
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        // UI åˆ‡æ¢
        document.getElementById('processing-overlay').style.display = 'flex';
        simulateProgress();
    }

    function simulateProgress() {
        let p = 0;
        const bar = document.getElementById('progressBar');
        const txt = document.getElementById('progressText');
        processingInterval = setInterval(() => {
            if (p < 95) {
                p += Math.random() * 8;
                if (p > 95) p = 95;
                bar.style.width = p + "%";
                txt.innerText = Math.floor(p) + "%";
            }
        }, 150);
    }

    function finishProcessing() {
        // æ¸…ç†æµ
        if(canvasStream) canvasStream.getTracks().forEach(t=>t.stop());
        // æ³¨æ„ï¼šä¸è¦åœæ­¢ micStreamï¼Œå¦åˆ™é‡å½•éœ€è¦é‡æ–°ç”³è¯·æƒé™ï¼Œåªéœ€æ–­å¼€è¿æ¥æˆ–mute

        clearInterval(processingInterval);
        document.getElementById('progressBar').style.width = "100%";
        document.getElementById('progressText').innerText = "100%";
        
        setTimeout(() => {
            document.getElementById('processing-overlay').style.display = 'none';
            showResult();
        }, 600);
    }

    function showResult() {
        finalBlob = new Blob(recordedChunks, { type: 'video/mp4' });
        const url = URL.createObjectURL(finalBlob);
        
        const preview = document.getElementById("previewVideo");
        preview.src = url;
        
        document.getElementById("video-container").style.display = "none";
        document.getElementById("resultArea").style.display = "block";
        document.getElementById("shareBtn").style.display = "flex";
        document.getElementById("shareHint").style.display = "block";
        
        document.getElementById("statusText").innerText = "";
    }

    function resetRecording() {
        document.getElementById("resultArea").style.display = "none";
        document.getElementById("video-container").style.display = "block";
        
        const btn = document.getElementById("actionBtn");
        btn.style.display = "block";
        btn.innerHTML = "ğŸ™ï¸ å¼€å§‹é…éŸ³ Start Dubbing";
        
        document.getElementById("statusText").innerText = "ğŸ”„ å·²é‡ç½®";
        
        const v = document.getElementById("mainVideo");
        v.controls = true;
        v.currentTime = 0;
        v.pause();
    }

    function handleShareOrSave() {
        if(!finalBlob) return;
        const filename = `Firstleap_Voice_${Date.now()}.mp4`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(finalBlob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert("è§†é¢‘å·²ä¿å­˜åˆ°ç›¸å†Œï¼\nè¯·æ‰“å¼€å¾®ä¿¡ï¼Œä»ç›¸å†Œé€‰æ‹©è§†é¢‘å‘é€ã€‚");
    }

    // è¾…åŠ©åŠŸèƒ½
    function enterFullscreenMode() {
      document.body.classList.add('recording-mode');
      const doc = document.documentElement;
      if (doc.requestFullscreen) doc.requestFullscreen().catch(()=>{});
    }
    function exitFullscreenMode() {
      document.body.classList.remove('recording-mode');
      if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
    }

    // æ¬¢è¿é¡µé€»è¾‘
    const welcome = document.getElementById('welcome');
    document.getElementById('welcomeSkipBtn').onclick = () => {
        welcome.classList.add('hidden');
        document.body.classList.remove('welcome-active');
        document.getElementById('welcomeVideo').pause();
    };
    document.getElementById('welcomeEnterBtn').onclick = async () => {
        await checkMicPermissionAndResumeAudio();
        document.getElementById('welcomeSkipBtn').click();
    };
  </script>
</body>
</html>
