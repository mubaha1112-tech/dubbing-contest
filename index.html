</think>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ±æ­¥-å¥‡å£°å¦™æƒ³ Firstleap Voice Magic - å†…åµŒæ’­æ”¾å™¨ç‰ˆ</title>
    <style>
        :root{
            --bg-cream:#F9F6E8;
            --card-white:#fff;
            --monster-green:#7BC043;
            --rabbit-pink:#FF8E8E;
            --rabbit-red:#EE5253;
            --pear-yellow:#F9CA24;
            --text-dark:#2d3436;
            --shadow-soft:0 10px 30px rgba(249,202,36,.15);
            --shadow-3d:0 6px 0 rgba(0,0,0,.1);
            --primary-grad:linear-gradient(135deg,#a8e063 0%,#56ab2f 100%);
            --rec-grad:linear-gradient(to right,#ff5f6d,#ffc371);
            --play-grad:linear-gradient(135deg,#fce38a 0%,#f38181 100%);
            --blue-grad:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
        }
        body{
            font-family:"Chalkboard SE","Comic Sans MS",-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-cream);
            margin:0; padding:20px 10px; color:var(--text-dark);
        }
        .page{ max-width:860px; margin:0 auto; }
        .header{ text-align:center; margin-bottom:14px; }
        .header h1{
            color:var(--rabbit-red); font-size:26px; margin:8px 0 6px;
            text-shadow:2px 2px 0 #ffe3e3; font-weight:900; position:relative; display:inline-block;
        }
        .header h1::after{content:"âœ¨"; position:absolute; right:-24px; top:0; animation:bounce 2s infinite;}
        .header h1::before{content:"ğŸµ"; position:absolute; left:-24px; top:10px; animation:bounce 2s infinite reverse;}
        .header .sub{color:#888; font-size:14px}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

        /* Cute Player */
        .cute-player{
            background:var(--card-white);
            border-radius:24px;
            border:5px solid #fff;
            box-shadow:0 15px 40px rgba(0,0,0,.08);
            padding:14px;
        }
        .player-wrap{
            position:relative;
            background:#000;
            border-radius:18px;
            overflow:hidden;
        }
        video{
            width:100%; height:auto; display:block;
            object-fit:contain; background:#000;
            outline:none; border:0;
        }

        /* Overlays inside player */
        .overlay-center,
        .overlay-full{
            position:absolute; inset:0;
            display:none; align-items:center; justify-content:center;
        }
        .loader-overlay{
            background:rgba(255,255,255,.92);
            backdrop-filter:blur(3px);
            flex-direction:column;
            gap:10px;
        }
        .spinner{border:5px solid #f3f3f3; border-top:5px solid var(--rabbit-red); border-radius:50%;
            width:45px; height:45px; animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        .countdown{
            background:rgba(255,142,142,.95);
            backdrop-filter:blur(5px);
            flex-direction:column; color:#fff; text-align:center;
        }
        .countdown-num{
            font-size:120px; font-weight:900; text-shadow:4px 4px 0 rgba(0,0,0,.1);
            animation:popIn .8s cubic-bezier(.175,.885,.32,1.275);
        }
        .countdown-txt{font-size:20px; margin-top:6px}
        @keyframes popIn{0%{transform:scale(.5);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

        .processing{
            background:rgba(50,50,50,.98);
            flex-direction:column; color:#fff; text-align:center; gap:12px;
        }
        .progress-box{width:76%; max-width:340px; height:16px; background:rgba(255,255,255,.3);
            border-radius:10px; overflow:hidden; padding:2px; margin:0 auto}
        .progress-bar{height:100%; width:0%; background:#fff; border-radius:8px; transition:width .2s ease}

        /* Top-right recording controls */
        .topbar{
            position:absolute; top:10px; left:10px; right:10px;
            display:flex; align-items:center; justify-content:space-between; pointer-events:none;
        }
        .rec-badge{
            pointer-events:auto;
            background:var(--rec-grad); color:#fff; font-weight:900; font-size:12px;
            padding:6px 10px; border-radius:999px; box-shadow:var(--shadow-3d);
            display:none; align-items:center; gap:6px;
        }
        .rec-dot{width:8px; height:8px; border-radius:50%; background:#ff1f1f; animation:pulse 1.2s infinite}
        @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}

        .record-ctrls{ pointer-events:auto; display:none; gap:8px; }
        .pill-btn{
            border:none; border-radius:999px; font-weight:800; cursor:pointer; color:#fff;
            padding:8px 14px; box-shadow:var(--shadow-3d); font-size:14px;
        }
        .btn-stop{background:linear-gradient(135deg,#f6d365 0%,#fda085 100%)}
        .btn-pause{background:linear-gradient(135deg,#fce38a 0%,#f38181 100%)}
        .btn-resume{background:var(--monster-green)}

        /* Status tip bottom-left */
        .status-tip{
            position:absolute; left:10px; bottom:10px;
            background:rgba(0,0,0,.55); color:#fff; font-size:12px;
            padding:6px 10px; border-radius:12px; display:none;
        }

        /* Control bar */
        .controls{
            display:flex; gap:10px; flex-wrap:wrap;
            padding:12px 8px 0; align-items:center;
        }
        .select{ flex:1 1 160px; position:relative; }
        select{
            width:100%; padding:10px 34px 10px 12px; border:2px solid #eee; border-radius:18px;
            font-size:14px; background:#fafafa; outline:none; color:#555; font-weight:700;
            -webkit-appearance:none; appearance:none;
            background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23FF9966' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat:no-repeat; background-position:right 10px center; background-size:18px;
        }
        select:disabled{background:#f4f4f4; color:#aaa}

        .btn{
            border:none; border-radius:18px; padding:10px 14px; font-weight:800;
            cursor:pointer; color:#fff; box-shadow:var(--shadow-3d); font-size:14px;
        }
        .btn:disabled{background:#e0e0e0; color:#aaa; box-shadow:none; cursor:not-allowed}
        .btn-green{background:var(--primary-grad)}
        .btn-rec{background:var(--rec-grad)}
        .btn-blue{background:var(--blue-grad)}
        .btn-gray{background:#dfe6e9; color:#636e72; box-shadow:0 4px 0 #b2bec3}

        .timegroup{display:flex; align-items:center; gap:8px; flex:1 1 220px}
        .time{ display:flex; align-items:center; gap:8px; flex:1; }
        .timeline{flex:1}
        input[type="range"]{width:100%}
        .volgroup{display:flex; align-items:center; gap:6px}
        .volgroup input[type="range"]{width:100px}

        .tip{
            font-size:12px; color:#e67e22; margin:8px 0 0; background:#fff3e0; padding:10px; border-radius:14px;
        }

        /* Result (new overlay version) */
        .finish-overlay{
            background:rgba(255,255,255,.97);
            backdrop-filter:blur(2px);
            flex-direction:column; color:var(--text-dark); text-align:center; gap:12px; padding:16px;
        }
        .finish-card{
            width:92%; max-width:780px; margin:0 auto;
            background:#fff; border-radius:20px; padding:16px;
            box-shadow:var(--shadow-soft);
            display:flex; flex-direction:column; align-items:center; gap:12px;
        }
        .finish-title{ font-weight:900; font-size:22px; color:var(--rabbit-red); }
        .finish-sub{ font-size:12px; color:#999; }
        .finish-video{ width:100%; max-height:60vh; border-radius:12px; background:#000; }

        .btn-group{display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; justify-content:center}
        .btn.disabled, .btn[aria-disabled="true"]{
            background:#e0e0e0 !important; color:#aaa !important; box-shadow:none !important;
            cursor:not-allowed !important; pointer-events:none !important;
        }

        /* Fullscreen center record overlay */
        .rec-overlay{
            background:rgba(0,0,0,.35);
            backdrop-filter:blur(2px);
        }
        .big-rec-btn{
            border:none; cursor:pointer; font-weight:900; font-size:20px; color:#fff;
            padding:18px 28px; border-radius:999px;
            background:var(--rec-grad); box-shadow:0 10px 24px rgba(0,0,0,.25);
        }
        .big-rec-btn:active{transform:translateY(1px)}

        /* When finished, hide in-player UI parts */
        .cute-player.is-finished .controls{ display:none; }
        .cute-player.is-finished .topbar{ display:none; }
        .cute-player.is-finished .status-tip{ display:none !important; }
        .cute-player.is-finished .tip{ display:none; }

        /* Small utility */
        .hidden{display:none !important;}
    </style>
</head>
<body>
<div class="page">
    <div class="header">
        <h1>Firstleap Voice Magic</h1>
        <div class="sub">å¥‡å£°å¦™æƒ³é…éŸ³ç§€ï¼ˆå†…åµŒæ’­æ”¾å™¨ç‰ˆï¼‰</div>
    </div>

    <div class="cute-player" id="playerShell">
        <div class="player-wrap" id="playerWrap">
            <video id="mainVideo" playsinline crossorigin="anonymous" controlslist="nodownload"></video>

            <!-- Top bar: REC + pause/stop -->
            <div class="topbar">
                <div class="rec-badge" id="recBadge"><span class="rec-dot"></span> REC</div>
                <div class="record-ctrls" id="recordCtrls">
                    <button class="pill-btn btn-pause" id="pauseRecBtn">â¸ï¸ æš‚åœ</button>
                    <button class="pill-btn btn-stop" id="stopRecBtn">â¹ï¸ ç»“æŸ</button>
                </div>
            </div>

            <!-- Status bottom-left -->
            <div class="status-tip" id="statusTip">å‡†å¤‡å°±ç»ª</div>

            <!-- Loader -->
            <div class="overlay-center loader-overlay" id="loaderOverlay">
                <div class="spinner"></div>
                <div id="loadingText" style="color:#555;font-weight:700">åŠ è½½ä¸­ Loading...</div>
            </div>

            <!-- Countdown -->
            <div class="overlay-full countdown" id="countdownOverlay">
                <div class="countdown-num" id="countNum">3</div>
                <div class="countdown-txt">Ready?</div>
            </div>

            <!-- Processing -->
            <div class="overlay-full processing" id="processingOverlay">
                <div style="font-size:56px">âš™ï¸</div>
                <div style="font-weight:800">è§†é¢‘åˆæˆä¸­...<br><span style="font-size:14px;opacity:.8">è¯·å‹¿å…³é—­æµè§ˆå™¨</span></div>
                <div class="progress-box"><div class="progress-bar" id="progressBar"></div></div>
                <div id="progressText" style="font-weight:800">0%</div>
            </div>

            <!-- Fullscreen Center Record Button -->
            <div class="overlay-center rec-overlay" id="recordOverlay">
                <button class="big-rec-btn" id="centerRecordBtn">ğŸ™ï¸ å¼€å§‹é…éŸ³</button>
            </div>

            <!-- Finished Overlay (replace entire video UI after recording) -->
            <div class="overlay-full finish-overlay" id="finishOverlay">
                <div class="finish-card">
                    <div class="finish-title">ğŸ‰ é…éŸ³å®Œæˆï¼Amazing!</div>
                    <div class="finish-sub" id="finishSub">å¯é¢„è§ˆé…éŸ³æƒ…å†µï¼Œä¸‹è½½ä»éœ€ç­‰å¾…...</div>
                    <video id="finishPreview" class="finish-video" controls playsinline></video>
                    <div class="btn-group">
                        <button class="btn btn-gray" id="finishRetryBtn">ğŸ”„ é‡å½• Retry</button>
                        <a class="btn btn-blue disabled" id="finishDownload" aria-disabled="true">ğŸ’¾ ä¿å­˜è§†é¢‘</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control bar -->
        <div class="controls">
            <div class="select">
                <select id="levelSelect">
                    <option value="">é€‰æ‹©çº§åˆ« Level</option>
                </select>
            </div>
            <div class="select">
                <select id="unitSelect" disabled>
                    <option value="">é€‰æ‹©å•å…ƒ Unit</option>
                </select>
            </div>

            <button class="btn btn-green" id="playPauseBtn" disabled>â–¶ï¸ æ’­æ”¾</button>

            <div class="timegroup">
                <div class="time">
                    <span id="curTime">00:00</span>
                    <input type="range" class="timeline" id="timeline" min="0" max="100" value="0" step="0.1">
                    <span id="durTime">00:00</span>
                </div>
            </div>

            <div class="volgroup">
                <span>ğŸ”Š</span>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
            </div>

            <button class="btn btn-rec" id="recordBtn">ğŸ™ï¸ å¼€å§‹é…éŸ³</button>
            <button class="btn btn-blue" id="fsBtn">â›¶ å…¨å±</button>
        </div>

        <div class="tip">ğŸ§ æ¸©é¦¨æç¤ºï¼šé…éŸ³æ—¶å»ºè®®ä½©æˆ´è€³æœºï¼Œå‡å°‘å›å£°ä¸å•¸å«ã€‚</div>
    </div>
</div>

<script>
/* ================= è§†é¢‘åº“ ================= */
const videoDatabase = {
    "K2A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630119516450a277c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763012048115b61f0f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2b63bb6d3c08490db6dd9d2b4fe656d7/teacher-homework/1763012051505623f0e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/cc581b40f6b342ab8766ecb497b0593c/teacher-homework/17630120579742d4c02.mp4",
        "", "", ""
    ],
    "K2B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/19d99dbee57a4f91a48ce6ce7bb974b4/teacher-homework/1763012082809a8b161.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/6ca4b573c3a74e009339b0d119d2c6b2/teacher-homework/17630121046921c4cc5.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301780297880646f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178108970b8c1a.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301781737859c176.mp4",
        "", "", ""
    ],
    "K3A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630178328878ac20f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/87f8ebf82ac44720a8ed695edc81d7db/teacher-homework/17630178426408a59d8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/06f5c3edcb4d4d87ad1b0cd1d2993d27/teacher-homework/17630178665677d79d3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160538592e2c49d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/63972810b527498d9402d45faea7bf43/teacher-homework/17630179827650c9812.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/00a0f094ef8244389261d996abd604b4/teacher-homework/1763017985597814ea5.mp4",
        "", "", ""
    ],
    "K3B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018186532db70f3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176301818877214d863.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018191225723509.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018193813bf765d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018196433b9f19e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018210633b0c5c5.mp4",
        "", "", ""
    ],
    "G0":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018230212beeb84.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018576703e8a76d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018581832b7e3ea.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018585472d3a0b3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018589064cbe157.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018591548a9cde4.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630186018727ef726.mp4"
    ],
    "G1A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763020933347b4721b.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302093584897e05c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158748310d16322.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/813136336eb34eb9a086f0e4c74fad8f/teacher-homework/1764158754953d7e3aa.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c693f13409b0418aa30b61775fb667f2/teacher-homework/176415875781008bc3f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/efe922c6dad3478194454c6f20e83594/teacher-homework/176415876014857f8ce.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764161806814c6027c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/620f34d23da24485b7b3ebecf0d49715/teacher-homework/1764161810873e2ec8d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/61ec2562d76343898d1a4d622dfe53ba/teacher-homework/1764158765004679961.mp4"
    ],
    "G1B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021337298aae2a8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302134040302afa2.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021343327574ffe.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021345500e16489.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021348021750704.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023453394e0d4dd.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302135256081bc9e.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021362061eb0385.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763021363940857b8e.mp4"
    ],
    "G2A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160519134278b5d.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160529270565a19.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9083ce4b5f4242bdac85816e04e0bc56/teacher-homework/1763021929116e2169c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9af16032c9154a31bf2a95b3b15d1025/teacher-homework/176302193109956c2ed.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/51ae315a5c2b4260ba674f0dd1bdf11f/teacher-homework/17641618194078a0e28.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160535355cf6285.mp4",
        ""
    ],
    "G2B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c273f4a79c2845a59ed38b42b95f07c9/teacher-homework/1763022250827a260c7.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/2d998f0708574253aa892ba9d2ad0aea/teacher-homework/17630222531960ecf7c.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630222556756ffc34.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302225764940fec6.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157788986ab1382.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764157791475e09b7e.mp4",
        "", "", ""
    ],
    "G3A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160084181f102c7.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/4402ca889ef3400b839ef84cb23d12d3/teacher-homework/1763022952100285191.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764160086821b8d9e2.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/fdceaef6e31e4c638822a048c10725f8/teacher-homework/1764160089326b7fb73.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/17641600922812b7bff.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/a8c7a19a8cba42edaf6986b94969b197/teacher-homework/176416009474092babe.mp4",
        "", "", ""
    ],
    "G3B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302346811779ef05.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/176302347129269b324.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023473567337000.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023475693e477da.mp4",
        "", "", "", "", ""
    ],
    "G4A":[
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/c03eed96e6704a3f9e2e69aa87c5d129/teacher-homework/1763023607589e0edf8.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/eddede32bb134a7b9b459da4a265cb3d/teacher-homework/176302361198451fd60.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/058ccf2fb9b44db9b36af29fa2a3d049/teacher-homework/1763023619529830ebc.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/b2f0f75f1b734391a001882ca73c60cb/teacher-homework/17630236219657ae294.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251126/1764158042333492fc3.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763023992804c614a5.mp4",
        "", "", ""
    ],
    "G4B":[
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/ea4be2c59c024dea923d9806e1f7250a/teacher-homework/176302071175214eb09.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/f5abe75bd2ba4a03aecc16901b13e497/teacher-homework/1763020714062726936.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/7a60f558b9ac4428b9aa08f196cdbc20/teacher-homework/17630207163663000fa.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/febd1d55be274f3e911b4cc9aa9d7f88/teacher-homework/176302072522770462f.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/22a7ca3d786c495c96226e04473035cd/teacher-homework/176302072735125fd25.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/9c4b0954c98c4568a47cd7078e27cc6f/teacher-homework/176302072937414367d.mp4",
        "", "", ""
    ]
};

/* ================= çŠ¶æ€å˜é‡ ================= */
let audioCtx = null;
let micStream = null;
let videoStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let recordedMimeType = '';
let isRecording = false;
let processingInterval = null;
let processingProgress = 0;
let sourceMic = null, sourceVideo = null, dest = null, micGainNode = null, videoGainNode = null;
// å½“å‰åˆæˆè§†é¢‘çš„å¯¹è±¡URLï¼ˆfinish é¢„è§ˆä¸ä¸‹è½½å…¬ç”¨ï¼›ç»Ÿä¸€é‡Šæ”¾ï¼‰
let composedURL = '';

/* ================= å…ƒç´ è·å– ================= */
const video = document.getElementById('mainVideo');
const levelSelect = document.getElementById('levelSelect');
const unitSelect = document.getElementById('unitSelect');

const playPauseBtn = document.getElementById('playPauseBtn');
const recordBtn = document.getElementById('recordBtn');
const pauseRecBtn = document.getElementById('pauseRecBtn');
const stopRecBtn = document.getElementById('stopRecBtn');
const fsBtn = document.getElementById('fsBtn');

const curTimeEl = document.getElementById('curTime');
const durTimeEl = document.getElementById('durTime');
const timeline = document.getElementById('timeline');
const volume = document.getElementById('volume');

const statusTip = document.getElementById('statusTip');
const loaderOverlay = document.getElementById('loaderOverlay');
const loadingText = document.getElementById('loadingText');
const countdownOverlay = document.getElementById('countdownOverlay');
const countNum = document.getElementById('countNum');
const processingOverlay = document.getElementById('processingOverlay');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

const recBadge = document.getElementById('recBadge');
const recordCtrls = document.getElementById('recordCtrls');

const playerWrap = document.getElementById('playerWrap');
const playerShellEl = document.getElementById('playerShell');
const controlsBar = document.querySelector('.controls');

const recordOverlay = document.getElementById('recordOverlay');
const centerRecordBtn = document.getElementById('centerRecordBtn');

// Finished overlay elements
const finishOverlay = document.getElementById('finishOverlay');
const finishPreview = document.getElementById('finishPreview');
const finishDownload = document.getElementById('finishDownload');
const finishRetryBtn = document.getElementById('finishRetryBtn');
const finishSub = document.getElementById('finishSub');

/* ================= åˆå§‹åŒ–çº§åˆ«åˆ—è¡¨ ================= */
(function initLevels(){
    Object.keys(videoDatabase).forEach(lvl=>{
        const opt = document.createElement('option');
        opt.value = lvl; opt.textContent = lvl;
        levelSelect.appendChild(opt);
    });
})();

/* ================= å®ç”¨å‡½æ•° ================= */
function fmt(t){
    if (isNaN(t) || !isFinite(t)) return "00:00";
    const m = Math.floor(t/60); const s = Math.floor(t%60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function showStatus(msg, show=true){
    statusTip.textContent = msg;
    statusTip.style.display = show ? 'inline-flex' : 'none';
}
function showLoader(show){
    loaderOverlay.style.display = show ? 'flex' : 'none';
}
function beginProcessing(){
    // å¼€å§‹â€œå‹åˆ¶/åˆæˆä¸­â€é˜¶æ®µ
    hideFinishUI(); // éšè—å®Œæˆç•Œé¢ï¼ˆè‹¥æ­¤å‰å­˜åœ¨ï¼‰
    processingProgress = 0; progressBar.style.width='0%'; progressText.textContent='0%';
    processingOverlay.style.display='flex';
    if (processingInterval) clearInterval(processingInterval);
    processingInterval = setInterval(()=>{
        if (processingProgress < 90){
            const step = Math.max(1, Math.round((90 - processingProgress)/12));
            processingProgress = Math.min(90, processingProgress + step);
            progressBar.style.width = processingProgress + '%';
            progressText.textContent = processingProgress + '%';
        }
    }, 120);
}
function endProcessingThen(cb){
    if (processingInterval){ clearInterval(processingInterval); processingInterval = null; }
    const stepper = setInterval(()=>{
        processingProgress = Math.min(100, processingProgress + 4);
        progressBar.style.width = processingProgress + '%';
        progressText.textContent = processingProgress + '%';
        if (processingProgress >= 100){
            clearInterval(stepper);
            processingOverlay.style.display='none';
            cb && cb();
            updateOverlays();
        }
    }, 30);
}
function bestMime(){
    const types = [
        "video/mp4;codecs=avc1",
        "video/mp4",
        "video/webm;codecs=h264",
        "video/webm;codecs=vp9",
        "video/webm"
    ];
    for (const t of types){
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
    }
    return "";
}
function clearComposedURL(){
    if (composedURL){
        try{ URL.revokeObjectURL(composedURL); }catch(e){}
        if (finishPreview.src === composedURL){ finishPreview.src=''; }
        composedURL = '';
    }
}
function disableDownload(msg){
    finishDownload.classList.add('disabled');
    finishDownload.setAttribute('aria-disabled','true');
    if (msg) finishSub.textContent = msg;
}
function enableDownload(){
    finishDownload.classList.remove('disabled');
    finishDownload.removeAttribute('aria-disabled');
    finishSub.textContent = 'âœ… è§†é¢‘å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ä¸‹è½½å•¦';
}
function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement);
}
function isFinishVisible(){
    return finishOverlay.style.display === 'flex';
}
function canShowCenterRecord(){
    const hasSel = !!(levelSelect.value && unitSelect.value !== "");
    const videoReady = video.readyState >= 2;
    const busy = processingOverlay.style.display === 'flex' || countdownOverlay.style.display === 'flex';
    return isFullscreen() && !isRecording && !busy && !isFinishVisible() && hasSel && videoReady && !recordBtn.disabled;
}
function updateOverlays(){
    // ä¸­å¤®é…éŸ³æŒ‰é’®ä»…åœ¨å…¨å±ä¸”æœªåœ¨å®Œæˆç•Œé¢/å½•åˆ¶/å€’è®¡æ—¶/å¤„ç†ä¸­æ—¶æ˜¾ç¤º
    recordOverlay.style.display = canShowCenterRecord() ? 'flex' : 'none';
    if (isFullscreen() && !isRecording){
        recordBtn.style.display = recordOverlay.style.display === 'flex' ? 'none' : (isFinishVisible() ? 'none' : 'block');
    }else if(!isRecording){
        recordBtn.style.display = isFinishVisible() ? 'none' : 'block';
    }
}

/* ================= å®Œæˆç•Œé¢æ§åˆ¶ ================= */
function showFinishUI(){
    playerShellEl.classList.add('is-finished');
    finishOverlay.style.display = 'flex';
    // éšè—çŠ¶æ€æ¡ä»¥å…å åŠ 
    showStatus('', false);
    updateOverlays();
}
function hideFinishUI(){
    playerShellEl.classList.remove('is-finished');
    finishOverlay.style.display = 'none';
    // æ¸…ç†é¢„è§ˆæ’­æ”¾å™¨ï¼ˆé¿å…æ®‹ç•™å¯¹è±¡URLï¼‰
    if (finishPreview.src){
        if (!composedURL || finishPreview.src !== composedURL){
            try{ URL.revokeObjectURL(finishPreview.src); }catch(e){}
        }
        finishPreview.src = '';
    }
    disableDownload(''); // ä¿æŒæŒ‰é’®ä¸ºç¦ç”¨æ ·å¼ï¼Œæ–‡æœ¬ç”±åç»­æµç¨‹è®¾ç½®
}

/* ================= çº§åˆ«&å•å…ƒè”åŠ¨ ================= */
function updateUnits(){
    unitSelect.innerHTML = '<option value="">é€‰æ‹©å•å…ƒ Unit</option>';
    unitSelect.disabled = true;
    hideFinishUI();
    clearComposedURL();

    recordBtn.disabled = true;
    playPauseBtn.disabled = true;
    showStatus('è¯·é€‰æ‹©çº§åˆ«ä¸å•å…ƒ');
    const lvl = levelSelect.value;
    if (!lvl || !videoDatabase[lvl]){ updateOverlays(); return; }
    let has = false;
    videoDatabase[lvl].forEach((url, idx)=>{
        if (url){
            const opt = document.createElement('option');
            opt.value = String(idx);
            opt.textContent = `Unit ${idx+1}`;
            unitSelect.appendChild(opt);
            has = true;
        }
    });
    unitSelect.disabled = !has;
    updateOverlays();
}
levelSelect.addEventListener('change', updateUnits);

function loadSelectedVideo(){
    hideFinishUI();
    clearComposedURL();

    const lvl = levelSelect.value;
    const u = unitSelect.value;
    if (!lvl || u === ""){ alert('è¯·å…ˆé€‰æ‹©çº§åˆ«ä¸å•å…ƒ'); updateOverlays(); return; }
    const url = videoDatabase[lvl][Number(u)];
    if (!url){ alert('è¯¥å•å…ƒæš‚æ— è§†é¢‘'); updateOverlays(); return; }

    showLoader(true);
    showStatus('è§†é¢‘åŠ è½½ä¸­...');
    playPauseBtn.disabled = true;
    recordBtn.disabled = true;

    // æ¸…ç†æ—§ç›‘å¬å™¨
    video.oncanplaythrough = null;
    video.onprogress = null;
    video.onerror = null;
    video.onended = null;

    video.src = url;
    video.load();
    video.muted = false;
    video.volume = Number(volume.value);

    video.onprogress = ()=>{
        try {
            if (video.buffered.length>0 && isFinite(video.duration) && video.duration>0){
                const percent = Math.min(100, Math.floor(video.buffered.end(video.buffered.length-1) / video.duration * 100));
                loadingText.textContent = 'è§†é¢‘ç¼“å†²ä¸­ ' + percent + '%';
            }
        }catch(e){}
    };
    video.oncanplaythrough = ()=>{
        showLoader(false);
        playPauseBtn.disabled = false;
        recordBtn.disabled = false;
        showStatus('âœ… è§†é¢‘å·²å°±ç»ªï¼Œç‚¹å‡»æ’­æ”¾æˆ–å¼€å§‹é…éŸ³');
        durTimeEl.textContent = fmt(video.duration);
        timeline.value = 0;
        timeline.max = video.duration || 0;
        updateOverlays();
    };
    video.onerror = ()=>{
        showLoader(false);
        showStatus('âŒ è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–CORS', true);
        alert("è§†é¢‘åŠ è½½å¤±è´¥ã€‚å¯èƒ½æ˜¯ç½‘ç»œæˆ–è·¨åŸŸé™åˆ¶ã€‚è‹¥æŒç»­å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é…ç½®CORSã€‚");
        updateOverlays();
    };
    video.onended = ()=>{
        playPauseBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
        updateOverlays();
    };
}
unitSelect.addEventListener('change', loadSelectedVideo);

/* ================= æ’­æ”¾å™¨åŸºæœ¬æ§åˆ¶ ================= */
playPauseBtn.addEventListener('click', ()=>{
    if (video.paused){ video.play(); } else { video.pause(); }
});
video.addEventListener('play', ()=>{ playPauseBtn.textContent='â¸ï¸ æš‚åœ'; });
video.addEventListener('pause', ()=>{ playPauseBtn.textContent='â–¶ï¸ æ’­æ”¾'; });

video.addEventListener('loadedmetadata', ()=>{
    durTimeEl.textContent = fmt(video.duration);
    timeline.max = video.duration || 0;
    updateOverlays();
});
video.addEventListener('timeupdate', ()=>{
    curTimeEl.textContent = fmt(video.currentTime);
    if (!timeline.disabled) timeline.value = video.currentTime;
});
timeline.addEventListener('input', ()=>{
    if (!isRecording){ video.currentTime = Number(timeline.value); }
});
volume.addEventListener('input', ()=>{
    video.volume = Number(volume.value);
});
fsBtn.addEventListener('click', ()=>{
    const el = document.getElementById('playerShell');
    if (!document.fullscreenElement && !document.webkitFullscreenElement){
        const req = el.requestFullscreen || el.webkitRequestFullscreen;
        req && req.call(el);
    }else{
        const exit = document.exitFullscreen || document.webkitExitFullscreen;
        exit && exit.call(document);
    }
});

/* ================= å…¨å±å˜åŒ–æ—¶ï¼Œæ§åˆ¶ä¸­å¤®â€œå¼€å§‹é…éŸ³â€æŒ‰é’®æ˜¾ç¤º ================= */
['fullscreenchange','webkitfullscreenchange'].forEach(evt=>{
    document.addEventListener(evt, updateOverlays);
});

/* ================= é…éŸ³æ§åˆ¶ ================= */
recordBtn.addEventListener('click', startDubbingFlow);
centerRecordBtn.addEventListener('click', startDubbingFlow);
finishRetryBtn.addEventListener('click', ()=>{
    // è¿”å›åˆ°å½•åˆ¶å‰çŠ¶æ€ï¼ˆæ¢å¤åŸç‰‡ï¼‰
    hideFinishUI();
    clearComposedURL();
    showStatus('å·²é‡ç½®ï¼Œå¯å†æ¬¡å¼€å§‹é…éŸ³');
    recordBtn.style.display = 'block';
    recordBtn.disabled = false;
    loadSelectedVideo();
    updateOverlays();
});
pauseRecBtn.addEventListener('click', togglePauseRecording);
stopRecBtn.addEventListener('click', stopRecording);

async function startDubbingFlow(){
    if (video.readyState < 2){ alert('è¯·ç­‰å¾…è§†é¢‘åŠ è½½å®Œæ¯•'); return; }
    // è·å–éº¦å…‹é£
    try{
        micStream = await navigator.mediaDevices.getUserMedia({
            audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }
        });
    }catch(e){
        alert('æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·åœ¨ç³»ç»Ÿ/æµè§ˆå™¨ä¸­å…è®¸éº¦å…‹é£ã€‚');
        return;
    }
    // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºæš‚åœ/ç»“æŸæŒ‰é’®
    recordBtn.style.display = 'none';
    recordOverlay.style.display = 'none';
    
    // å€’è®¡æ—¶
    countdown(3, async ()=>{
        await executeRecording();
    });
}
function countdown(sec, done){
    countNum.textContent = sec;
    countdownOverlay.style.display='flex';
    const t = setInterval(()=>{
        sec--;
        if (sec>0){
            countNum.style.animation='none'; void countNum.offsetHeight;
            countNum.style.animation='popIn .8s cubic-bezier(.175,.885,.32,1.275)';
            countNum.textContent = sec;
        }else{
            clearInterval(t);
            countNum.textContent='GO!';
            setTimeout(()=>{
                countdownOverlay.style.display='none';
                done && done();
            }, 400);
        }
    }, 1000);
}

async function executeRecording(){
    // ç¡®ä¿ AudioContext
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!audioCtx || audioCtx.state==='closed'){ audioCtx = new AC(); }
    else if (audioCtx.state==='suspended'){ await audioCtx.resume(); }

    // å‡†å¤‡è§†é¢‘
    video.currentTime = 0;
    video.muted = true; // é™éŸ³è§†é¢‘è‡ªèº«ï¼Œé˜²æ­¢å’Œæ··éŸ³è¾“å‡ºå åŠ 
    video.controls = false;

    try{ await video.play(); }
    catch(e){ alert('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»å±å¹•æ’­æ”¾åå†è¯•'); video.controls=true; return; }

    // captureStream è·å–è§†é¢‘ç”»é¢ä¸éŸ³è½¨
    videoStream = null;
    try{
        if (typeof video.captureStream === 'function') videoStream = video.captureStream();
        else if (typeof video.mozCaptureStream === 'function') videoStream = video.mozCaptureStream();
    }catch(e){ console.warn('captureStream error', e); }
    if (!videoStream){
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥å½•åˆ¶è§†é¢‘ç”»é¢ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome / Edge / Safariã€‚');
        cleanupStreams();
        return;
    }
    const vTracks = videoStream.getVideoTracks();
    if (!vTracks || !vTracks.length){
        alert('æœªè·å–åˆ°è§†é¢‘ç”»é¢è½¨é“ï¼Œè¯·é‡è¯•');
        cleanupStreams();
        return;
    }

    // Web Audio æ··éŸ³ï¼šéº¦å…‹é£ + åŸè§†é¢‘éŸ³é¢‘ -> MediaStreamDestination
    dest = audioCtx.createMediaStreamDestination();
    micGainNode = audioCtx.createGain(); micGainNode.gain.value = 3.0; // æ”¾å¤§äººå£°
    videoGainNode = audioCtx.createGain(); videoGainNode.gain.value = 0.2; // é™ä½åŸç‰‡éŸ³

    sourceMic = audioCtx.createMediaStreamSource(micStream);
    sourceMic.connect(micGainNode); micGainNode.connect(dest);

    try{
        if (videoStream.getAudioTracks().length>0){
            sourceVideo = audioCtx.createMediaStreamSource(videoStream);
            sourceVideo.connect(videoGainNode); videoGainNode.connect(dest);
            // ç›‘å¬åŸç‰‡éŸ³åˆ°æ‰¬å£°å™¨ï¼ˆå»ºè®®ä½©æˆ´è€³æœºï¼‰
            sourceVideo.connect(audioCtx.destination);
        }
    }catch(e){ console.error('Audio routing error:', e); }

    const mixedAudioTrack = dest.stream.getAudioTracks()[0];
    if (!mixedAudioTrack){ alert('æ— æ³•è·å–æ··åˆéŸ³é¢‘è½¨é“ï¼Œè¯·é‡è¯•'); cleanupStreams(); return; }

    const combinedStream = new MediaStream([ vTracks[0], mixedAudioTrack ]);

    // åˆå§‹åŒ–å½•åˆ¶å™¨
    recordedMimeType = bestMime();
    try{
        mediaRecorder = recordedMimeType
            ? new MediaRecorder(combinedStream, { mimeType: recordedMimeType, videoBitsPerSecond: 2500000 })
            : new MediaRecorder(combinedStream, { videoBitsPerSecond: 2500000 });
    }catch(e){
        try{ mediaRecorder = new MediaRecorder(combinedStream); }
        catch(e2){
            alert('æ­¤è®¾å¤‡/æµè§ˆå™¨æš‚ä¸æ”¯æŒç½‘é¡µå½•åˆ¶ï¼Œè¯·æ›´æ¢ Chrome æˆ– Safariã€‚');
            cleanupStreams();
            return;
        }
    }

    recordedChunks = [];
    mediaRecorder.ondataavailable = ev=>{
        if (ev.data && ev.data.size>0){ recordedChunks.push(ev.data); }
    };
    mediaRecorder.onerror = e=>{ console.error('MediaRecorder error:', e); };
    mediaRecorder.onstop = ()=>{
        preparePreviewThenReveal();
    };

    try{ mediaRecorder.start(500); }
    catch(e){ alert('å¯åŠ¨å½•åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ›´æ¢æµè§ˆå™¨'); cleanupStreams(); return; }

    // åˆ‡æ¢ UI çŠ¶æ€ä¸ºå½•åˆ¶ä¸­
    isRecording = true;
    recBadge.style.display = 'inline-flex';
    recordCtrls.style.display = 'flex';
    recordBtn.disabled = true;
    timeline.disabled = true;
    showStatus('ğŸ”´ å½•åˆ¶ä¸­...', true);

    // å¼€å§‹åä»…æ˜¾ç¤ºå³ä¸Šè§’æš‚åœ/ç»“æŸ
    recordOverlay.style.display = 'none';
    recordBtn.style.display = 'none';

    video.onended = ()=>{ stopRecording(); };
}

function togglePauseRecording(){
    if (!mediaRecorder || !isRecording) return;
    try{
        if (mediaRecorder.state === 'recording'){
            mediaRecorder.pause();
            video.pause();
            pauseRecBtn.textContent = 'â–¶ï¸ ç»§ç»­';
            pauseRecBtn.classList.remove('btn-pause');
            pauseRecBtn.classList.add('btn-resume');
            showStatus('â¸ï¸ å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­');
        }else if (mediaRecorder.state === 'paused'){
            mediaRecorder.resume();
            video.play().catch(()=>{});
            pauseRecBtn.textContent = 'â¸ï¸ æš‚åœ';
            pauseRecBtn.classList.remove('btn-resume');
            pauseRecBtn.classList.add('btn-pause');
            showStatus('ğŸ”´ å½•åˆ¶ä¸­...');
        }
    }catch(e){
        console.warn('pause/resume failed', e);
    }
}

function stopRecording(){
    if (!isRecording) return;
    isRecording = false;

    // æ˜¾ç¤ºâ€œåˆæˆä¸­â€è¿›åº¦
    beginProcessing();

    try{
        if (mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
    }catch(e){ console.warn('stop recorder error', e); }

    // æ¢å¤è§†é¢‘æ§åˆ¶
    try{ video.pause(); }catch(e){}
    video.controls = false; // ä½¿ç”¨è‡ªå®šä¹‰æ§ä»¶
    video.muted = false;
    timeline.disabled = false;
    playPauseBtn.disabled = false;

    // éšè—å½•åˆ¶æ§ä»¶
    recBadge.style.display = 'none';
    recordCtrls.style.display = 'none';
    pauseRecBtn.textContent = 'â¸ï¸ æš‚åœ';
    pauseRecBtn.classList.remove('btn-resume');
    pauseRecBtn.classList.add('btn-pause');

    // å…³é—­é‡‡é›†æµ
    cleanupStreams();
}

function cleanupStreams(){
    try{
        if (micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
        if (videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
        if (dest){ dest=null; }
        sourceMic=null; sourceVideo=null; micGainNode=null; videoGainNode=null;
    }catch(e){}
}

/* å½•åˆ¶åœæ­¢åï¼šå°è£… Blobï¼Œå¹¶ä»¥â€œå®Œæˆç•Œé¢â€æ›¿æ¢æ•´ä¸ªè§†é¢‘ç•Œé¢ï¼›é¢„è§ˆå¯çœ‹ä½†ä¸‹è½½å¾… ready æ‰å¯ç”¨ */
function preparePreviewThenReveal(){
    if (!recordedChunks.length){
        alert('å½•åˆ¶å¤±è´¥ï¼šæ•°æ®ä¸ºç©º');
        showStatus('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', true);
        processingOverlay.style.display='none';
        updateOverlays();
        return;
    }
    try{
        const type = recordedMimeType || 'video/webm';
        const blob = new Blob(recordedChunks, { type });
        const url = URL.createObjectURL(blob);

        // é‡Šæ”¾æ—§çš„åˆæˆURLå¹¶ä¿å­˜æ–°çš„
        clearComposedURL();
        composedURL = url;

        // ç»‘å®šå®Œæˆç•Œé¢
        finishPreview.src = composedURL;
        const isWebm = (type || '').toLowerCase().includes('webm');
        const ext = isWebm ? '.webm' : '.mp4';
        const filename = `Firstleap_Voice_${Date.now()}${ext}`;
        finishDownload.href = composedURL;
        finishDownload.download = filename;

        // æç¤ºä¸ç¦ç”¨ä¸‹è½½ï¼ˆæ»¡è¶³â‘¡ï¼‰
        disableDownload('å¯é¢„è§ˆé…éŸ³æƒ…å†µï¼Œä¸‹è½½ä»éœ€ç­‰å¾…...');

        // ç»“æŸâ€œåˆæˆä¸­â€æç¤ºï¼Œå±•ç¤ºå®Œæˆç•Œé¢ï¼ˆæ»¡è¶³â‘ ï¼šæ›¿æ¢æ•´ä¸ªè§†é¢‘ç•Œé¢ï¼‰
        if (processingInterval){ clearInterval(processingInterval); processingInterval=null; }
        processingOverlay.style.display='none';
        showFinishUI();
        // åœæ­¢ä¸»æ’­æ”¾å™¨ç”»é¢
        try{ video.pause(); }catch(e){}

        // é¢„è§ˆå°±ç»ªåå¼€æ”¾ä¸‹è½½ï¼ˆåŠ è½½å®Œæˆå‰ç°è‰²ï¼‰
        const onReady = ()=>{
            finishPreview.removeEventListener('canplaythrough', onReady);
            finishPreview.removeEventListener('loadeddata', onReady);
            enableDownload();
        };
        finishPreview.addEventListener('canplaythrough', onReady);
        finishPreview.addEventListener('loadeddata', onReady);
        // å…œåº•ï¼š8ç§’åä»æœªè§¦å‘ä¹Ÿå…è®¸ä¸‹è½½ï¼Œé¿å…æç«¯è®¾å¤‡ä¸€ç›´ç¦ç”¨
        setTimeout(()=>{ if (finishDownload.getAttribute('aria-disabled')==='true') enableDownload(); }, 8000);

        updateOverlays();
    }catch(e){
        console.error(e);
        alert('è§†é¢‘ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•');
        showStatus('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', true);
        processingOverlay.style.display='none';
        updateOverlays();
    }
}

/* ================= å…¶å®ƒç›‘å¬ ================= */
video.addEventListener('seeking', ()=>{
    if (!isRecording && !isFinishVisible()) showStatus('â³ è·³è½¬ä¸­...', true);
});
video.addEventListener('seeked', ()=>{
    if (!isRecording && !isFinishVisible()) showStatus('âœ… å°±ç»ª', true);
});
document.addEventListener('keydown', (e)=>{
    // ç©ºæ ¼æ’­æ”¾/æš‚åœï¼ˆé¿å…è¾“å…¥æ¡†å†²çªï¼‰
    if (e.code==='Space' && !e.target.matches('input,select,textarea,button,a')){
        e.preventDefault();
        if (playPauseBtn.disabled || isFinishVisible()) return;
        if (video.paused) video.play(); else video.pause();
    }
});

// åˆå§‹åˆ·æ–°ä¸€æ¬¡ä¸­å¤®å¼€å§‹é…éŸ³æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
updateOverlays();
</script>
</body>
</html>
