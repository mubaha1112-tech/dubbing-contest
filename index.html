<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ±æ­¥ - Firstleap Voice Magic</title>
  <style>
    :root {
      --bg-cream: #F9F6E8;
      --card-white: #ffffff;
      --monster-green: #7BC043;
      --rabbit-pink: #FF8E8E;
      --rabbit-red: #EE5253;
      --pear-yellow: #F9CA24;
      --text-dark: #2d3436;
      --shadow-3d: 0 6px 0 rgba(0,0,0,0.1);
    }
    body {
      font-family: "Chalkboard SE", "Comic Sans MS", -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-cream);
      margin: 0;
      padding: 20px 10px;
      text-align: center;
      color: var(--text-dark);
      overflow-x: hidden;
    }
    .container {
      background: var(--card-white);
      padding: 22px 20px;
      border-radius: 28px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.08);
      max-width: 720px;
      margin: 0 auto;
      position: relative;
      border: 5px solid #fff;
    }
    h1 { color: var(--rabbit-red); font-size: 26px; margin: 10px 0 12px; font-weight: 900; }
    .viewport {
      position: relative;
      width: 100%;
      height: auto;
      aspect-ratio: 16/9;       /* ç»Ÿä¸€æ¯”ä¾‹ï¼Œé€‚é…ç§»åŠ¨ç«¯ */
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 14px;
    }
    /* æºè§†é¢‘ç”¨äºè§£ç ï¼Œä½†å¯¹ç”¨æˆ·ä¸å¯è§ï¼›ä¿æŒè§£ç æµç•…ï¼Œé¿å…é»‘å± */
    #sourceVideo {
      position: absolute;
      width: 100%; height: 100%;
      left: 0; top: 0;
      opacity: 0.999;          /* è¿‘ä¼¼é€æ˜ä½†ç¡®ä¿è§£ç æ´»è·ƒ */
      pointer-events: none;
      z-index: 1;
    }
    /* Canvas ä½œä¸ºæœ€ç»ˆæ˜¾ç¤º+å½•åˆ¶ç”»é¢ */
    #displayCanvas {
      position: absolute;
      width: 100%; height: 100%;
      left: 0; top: 0;
      z-index: 2;
    }
    #previewVideo { width: 100%; height: auto; display: none; margin-top: 12px; border-radius: 12px; background:#000; }
    select {
      width: 100%; padding: 12px; margin: 10px 0; border-radius: 18px;
      border: 2px solid #eee; font-size: 16px; background: #fff; font-weight: bold;
    }
    .btn { display: block; width: 100%; padding: 14px; border-radius: 999px; border: none; font-size: 16px; font-weight: 900;
           cursor: pointer; color: #fff; margin-top: 12px; background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); box-shadow: var(--shadow-3d); }
    .btn-record { background: linear-gradient(135deg, #ff5f6d, #ffc371); }
    .btn-stop { background: linear-gradient(135deg, #f36a6a, #f59e57); animation: pulse 1.6s infinite; }
    .btn-download { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }

    .status { margin-top: 8px; font-weight: bold; min-height: 20px; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .overlay .box { background: #fff; padding: 20px; border-radius: 12px; text-align: center; color: #333; max-width: 80%; }
    .countdown { font-size: 64px; font-weight: 900; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Firstleap Voice Magic</h1>
    <div style="text-align:left; margin:0 auto 8px; max-width:680px;">
      <div class="step-label" style="font-weight:800; color:#888; margin:6px 0 6px 0;">1. é€‰æ‹©çº§åˆ«</div>
      <select id="levelSelect" onchange="loadUnits()">
        <option value="">è¯·é€‰æ‹©çº§åˆ« (Level)</option>
      </select>
      <div class="step-label" style="font-weight:800; color:#888; margin:14px 0 6px 0;">2. é€‰æ‹©å•å…ƒ</div>
      <select id="unitSelect" disabled><option value="">è¯·å…ˆé€‰æ‹©çº§åˆ«</option></select>
      <button class="btn btn-record" id="loadBtn" onclick="loadVideo()" style="display:none;">ğŸ¬ æŸ¥æ‰¾è§†é¢‘ Find Video</button>
    </div>

    <div class="viewport" id="videoViewport" aria-label="è§†é¢‘åŒºåŸŸ">
      <!-- æºè§†é¢‘ï¼Œè´Ÿè´£è§£ç ï¼Œéšè—ä½†å¿…é¡»å¤„äºæ–‡æ¡£ä¸­ä»¥ç¡®ä¿è§£ç æ´»è·ƒ -->
      <video id="sourceVideo" playsinline webkit-playsinline crossOrigin="anonymous" preload="metadata"></video>
      <!-- ç”»å¸ƒä½œä¸ºæ¸²æŸ“ä¸å½•åˆ¶çš„å®é™…ç”»é¢ -->
      <canvas id="displayCanvas"></canvas>

      <div class="status" id="statusText">å°±ç»ªï¼Œè¯·å…ˆé€‰æ‹©çº§åˆ«/å•å…ƒ</div>
      <video id="previewVideo" playsinline webkit-playsinline controls style="display:none; margin-top:8px;"></video>
    </div>

    <button id="startBtn" class="btn" style="display:none;" onclick="startProcedure()">ğŸ™ï¸ å¼€å§‹é…éŸ³</button>
    <button id="pauseBtn" class="btn" style="display:none;" onclick="togglePause()">â¸ï¸ æš‚åœ/ç»§ç»­</button>
    <button id="stopBtn" class="btn btn-stop" style="display:none;" onclick="stopRecording()">â¹ï¸ å®Œæˆé…éŸ³ Stop</button>

    <div id="downloadArea" style="display:none; margin-top:12px;">
      <a id="downloadLink" class="btn-download" href="#" download="" style="text-decoration:none;">ğŸ’¾ ä¿å­˜/ä¸‹è½½è§†é¢‘</a>
    </div>

    <div class="overlay" id="overlayIntro">
      <div class="box">
        <div class="countdown" id="countdownText">3</div>
        <div>Ready? Go!</div>
      </div>
    </div>

    <div class="overlay" id="overlayError">
      <div class="box" id="errorBox">
        <div style="font-size:28px; font-weight:900; color:#e74c3c;">éº¦å…‹é£æƒé™è¢«æ‹’ç»</div>
        <div style="margin-top:8px; font-size:14px;">è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æœ¬ç½‘ç«™è®¿é—®éº¦å…‹é£ï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚</div>
        <button class="btn" style="margin-top:12px;" onclick="closeError()">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>

    <div class="overlay" id="overlayProcessing">
      <div class="box">
        <div style="font-size:40px; margin-bottom:6px;">âš™ï¸</div>
        <div>è§†é¢‘åˆæˆä¸­ï¼Œè¯·ç¨å€™...</div>
        <div class="status" id="progressText" style="margin-top:8px;">0%</div>
      </div>
    </div>
  </div>

  <script>
    // æ•°æ®æºï¼ˆå°½é‡ä¿ç•™åŸæœ‰ç»“æ„çš„è¦ç‚¹ï¼Œä½†ç®€åŒ–å±•ç¤ºï¼‰
    const videoDatabase = {
      "K2A": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011941537284494.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763011945233cae631.mp4",
        ""
      ],
      "K2B": [
        "https://file-aliyun.firstleap.cn/homework/teacher/transcoded/75c7beb9392e4cf9960c6eede634c52c/teacher-homework/17630120691122d5403.mp4",
        ""
      ],
      "G0": [
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/17630182202811ca8fd.mp4",
        "https://file-aliyun.firstleap.cn/homework/teacher/video/20251113/1763018228073dedc05.mp4",
        ""
      ],
      // çœŸå®ç¯å¢ƒè¯·æ›¿æ¢ä¸ºå®Œæ•´æ•°æ®é›†
    };

    // å…¨å±€å˜é‡
    let mediaRecorder = null;
    let recordedChunks = [];
    let audioCtx = null;
    let micStream = null;
    let destStream = null;
    let canvasStream = null;
    let sourceVideoObj = null;
    let isRecording = false;
    let isIntro = false;
    let introImage = null;
    let animationFrameId = null;

    // æœ€ç»ˆè¾“å‡º
    let finalMimeType = ''; // å®é™…å†™å…¥çš„ mimeType
    let finalExtension = '';  // è¾“å‡ºåç¼€åï¼ˆwebm/mp4ç­‰ï¼‰
    let finalBlob = null;
    let finalObjectURL = '';

    const levelSelect = document.getElementById('levelSelect');
    const unitSelect = document.getElementById('unitSelect');
    const sourceVideo = document.getElementById('sourceVideo');
    const displayCanvas = document.getElementById('displayCanvas');
    const videoViewport = document.getElementById('videoViewport');
    const ctx = displayCanvas.getContext('2d', { alpha: false });

    // åˆå§‹åŒ–ï¼šå¡«å……çº§åˆ«
    (function initLevels() {
      Object.keys(videoDatabase).forEach(level => {
        const opt = new Option(level, level);
        levelSelect.appendChild(opt);
      });
    })();

    // è½½å…¥å•å…ƒ
    function loadUnits() {
      const level = levelSelect.value;
      unitSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å•å…ƒ</option>';
      unitSelect.disabled = true;
      if (!level) return;
      const arr = videoDatabase[level] || [];
      arr.forEach((url, idx) => {
        if (url && url.length) {
          const opt = new Option("Unit " + (idx + 1), url);
          unitSelect.appendChild(opt);
        }
      });
      // æ˜¾ç¤ºæˆ–éšè—åŠ è½½æŒ‰é’®
      if (arr.filter(u => u).length > 0) {
        document.getElementById('loadBtn').style.display = 'block';
      }
    }

    // è½½å…¥è§†é¢‘
    function loadVideo() {
      const videoURL = unitSelect.value;
      if (!videoURL) return;
      // è®¾ç½®æºè§†é¢‘
      sourceVideo.src = videoURL;
      sourceVideo.crossOrigin = 'anonymous';
      sourceVideo.load();

      // Canvas å°ºå¯¸åŸºäºè§†é¢‘
      sourceVideo.onloadeddata = () => {
        const w = sourceVideo.videoWidth || 1280;
        const h = sourceVideo.videoHeight || 720;
        displayCanvas.width = w;
        displayCanvas.height = h;
        // åˆå§‹ç»˜åˆ¶
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, displayCanvas.width, displayCanvas.height);
        // å¯åŠ¨ç»˜åˆ¶å¾ªç¯ï¼Œç¡®ä¿ç”»é¢æŒç»­æ¸²æŸ“
        requestAnimationFrame(drawFrame);
      };

      // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('startBtn').textContent = 'ğŸ™ï¸ å‡†å¤‡é…éŸ³';
      document.getElementById('downloadArea').style.display = 'none';
      document.getElementById('statusText').textContent = 'è§†é¢‘å°±ç»ªï¼Œå¯ç‚¹å‡»â€œå¼€å§‹é…éŸ³â€';
    }

    // ç»˜åˆ¶å¾ªç¯ï¼šç¡®ä¿ç”»é¢ä¸ä¸ºç©ºç™½ï¼ˆ1ç§’é»‘å±å¸¸è§åŸå› æ˜¯è§†é¢‘æœªå°±ç»ª/æœªç»˜åˆ¶ï¼‰
    function drawFrame() {
      if (sourceVideo.readyState >= 2) {
        ctx.drawImage(sourceVideo, 0, 0, displayCanvas.width, displayCanvas.height);
      } else {
        // è‹¥å°šæœªå°±ç»ªï¼Œæ¸…ç©ºä¸ºé»‘è‰²
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, displayCanvas.width, displayCanvas.height);
      }
      animationFrameId = requestAnimationFrame(drawFrame);
    }

    // åˆå§‹åŒ–éŸ³é¢‘ç¯å¢ƒ
    async function ensureAudioEnv() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // éº¦å…‹é£
        if (!micStream) {
          micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } });
        }

        // æ··éŸ³ç›®æ ‡
        destStream = audioCtx.createMediaStreamDestination();

        // å°†éº¦å…‹é£è¾“å…¥è·¯ç”±åˆ° dest
        const micSource = audioCtx.createMediaStreamSource(micStream);
        const micGain = audioCtx.createGain();
        micGain.gain.value = 1.8;
        micSource.connect(micGain);
        micGain.connect(destStream);

        // å°†è§†é¢‘åŸå£°è·¯ç”±åˆ° destï¼ˆå¦‚å…è®¸è·¨åŸŸï¼‰
        try {
          if (!sourceVideo._audioNode) {
            const vsrc = audioCtx.createMediaElementSource(sourceVideo);
            sourceVideo._audioNode = vsrc;
            const vGain = audioCtx.createGain();
            vGain.gain.value = 0.4;
            vsrc.connect(vGain);
            vGain.connect(destStream);
            vGain.connect(audioCtx.destination);
          }
        } catch (e) {
          // å¸¸è§è·¨åŸŸé—®é¢˜ï¼Œå¿½ç•¥ï¼šä»…éº¦å…‹é£å‚ä¸å½•åˆ¶
          console.warn('è§†é¢‘åŸå£°æ··éŸ³å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸé™åˆ¶', e);
        }

        // é™é»˜æŒ¯è¡å™¨ï¼Œç¡®ä¿æ—¶é—´æˆ³ç¨³å®šï¼ˆå¤šæ•°è®¾å¤‡éœ€è¦æœ‰éŸ³é¢‘ä¸Šä¸‹æ–‡æ´»è·ƒæ‰ä¼šæŒç»­è¾“å‡ºæ—¶é—´æˆ³ï¼‰
        const osc = audioCtx.createOscillator();
        const oscGain = audioCtx.createGain();
        oscGain.gain.value = 0.0001; // æå°ï¼Œè‚‰çœ¼ä¸å¯é—»
        osc.connect(oscGain);
        oscGain.connect(destStream);
        osc.start();
        // ä¸éœ€è¦ä¿ç•™å¼•ç”¨ï¼Œç¡®ä¿èµ„æºå›æ”¶
      } catch (err) {
        console.error('åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥ï¼š', err);
      }
    }

    // å¼€å§‹æµç¨‹
    async function startProcedure() {
      await ensureAudioEnv();
      // å€’è®¡æ—¶
      overlayIntro.style.display = 'flex';
      let t = 3;
      document.getElementById('countdownText').textContent = t;
      const iv = setInterval(() => {
        t--;
        if (t > 0) {
          document.getElementById('countdownText').textContent = t;
        } else {
          clearInterval(iv);
          overlayIntro.style.display = 'none';
          startRecording();
        }
      }, 1000);
    }

    // å…¨å±/å‡†å¤‡å½•åˆ¶
    function startRecording() {
      // å°† canvas ç”»é¢è¾“å‡ºä¸ºè§†é¢‘æµ
      canvasStream = displayCanvas.captureStream(25);

      // å– destStream çš„éŸ³é¢‘è½¨
      const audioTracks = destStream ? destStream.stream.getAudioTracks() : [];
      const videoTracks = canvasStream.getVideoTracks();
      const finalStream = new MediaStream([...videoTracks, ...audioTracks]);

      // MIME Type æ´—ç‰Œï¼šå°½é‡é€‰æœ€å…¼å®¹çš„ WebM
      const mimeOptions = [
        'video/webm; codecs=vp9',
        'video/webm; codecs=vp8',
        'video/webm'
      ];
      let chosenMime = '';
      for (const t of mimeOptions) {
        if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
          chosenMime = t;
          break;
        }
      }
      if (!chosenMime) {
        // å…œåº•ï¼šå°è¯•ä¸ä¼  mimeTypeï¼Œæµè§ˆå™¨è‡ªè¡Œå†³å®š
        chosenMime = '';
      }

      try {
        const opts = chosenMime ? { mimeType: chosenMime, videoBitsPerSecond: 2000000 } : { videoBitsPerSecond: 2000000 };
        mediaRecorder = new MediaRecorder(finalStream, opts);
      } catch (e) {
        console.error('MediaRecorder åˆå§‹åŒ–å¤±è´¥ï¼š', e);
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•åˆ¶æ­¤æ ¼å¼ï¼Œè¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ã€‚');
        return;
      }

      recordedChunks = [];
      mediaRecorder.ondataavailable = (ev) => {
        if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
      };
      mediaRecorder.onerror = (ev) => console.error('éŒ²åˆ¶é”™è¯¯', ev);
      mediaRecorder.onstop = onRecordingStop;

      finalMimeType = mediaRecorder.mimeType || '';
      finalExtension = (finalMimeType.includes('webm')) ? 'webm' : 'bin';
      finalBlob = null;
      finalObjectURL = '';

      // æ˜¾ç¤ºæ§åˆ¶
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'block';
      document.getElementById('stopBtn').style.display = 'block';
      document.getElementById('loadingText').innerText = 'å½•åˆ¶ä¸­...';
      document.getElementById('overlayProcessing').style.display = 'flex';
      // å¯åŠ¨å½•åˆ¶
      mediaRecorder.start(100); // 100ms åˆ†æ®µ
      isRecording = true;
      isIntro = true;

      // åŒæ­¥æ’­æ”¾è§†é¢‘
      sourceVideo.play().catch(()=>{});
      // å¼€å§‹ç»˜åˆ¶å¾ªç¯
      drawFrame();
    }

    function drawFrame() {
      if (!isRecording) return;
      if (sourceVideo.readyState >= 2) {
        ctx.drawImage(sourceVideo, 0, 0, displayCanvas.width, displayCanvas.height);
      } else {
        // æœªå°±ç»ªï¼Œä¿æŒé»‘å±
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,displayCanvas.width, displayCanvas.height);
      }
      animationFrameId = requestAnimationFrame(drawFrame);
    }

    function onRecordingStop() {
      // ç”Ÿæˆæœ€ç»ˆ Blob
      if (recordedChunks.length === 0) {
        alert('å½•åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        resetUI();
        return;
      }
      finalMimeType = mediaRecorder.mimeType || 'video/webm';
      finalBlob = new Blob(recordedChunks, { type: finalMimeType });
      finalObjectURL = URL.createObjectURL(finalBlob);

      // å±•ç¤ºé¢„è§ˆ
      const preview = document.getElementById('previewVideo');
      preview.src = finalObjectURL;
      preview.style.display = 'block';
      // ä¸‹è½½é“¾æ¥
      const dl = document.getElementById('downloadLink');
      const ext = finalMimeType.includes('webm') ? 'webm' : 'mp4';
      dl.href = finalObjectURL;
      dl.download = `Firstleap_Voice_${Date.now()}.${ext}`;
      document.getElementById('downloadArea').style.display = 'block';
      document.getElementById('overlayProcessing').style.display = 'none';
    }

    function stopRecording() {
      if (!mediaRecorder || isRecording === false) return;
      isRecording = false;
      try { mediaRecorder.stop(); } catch (e) { console.warn(e); }
      // ç»“æŸåæ¸…ç†ç”»é¢
      cancelAnimationFrame(animationFrameId);
      sourceVideo.pause();
    }

    function loadError() {
      document.getElementById('overlayError').style.display = 'flex';
    }
    function closeError() {
      document.getElementById('overlayError').style.display = 'none';
    }

    function resetUI() {
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('downloadArea').style.display = 'none';
      document.getElementById('previewVideo').style.display = 'none';
      document.getElementById('statusText').textContent = 'å°±ç»ª';
    }

    // æŒ‰é’®äº‹ä»¶
    function togglePause() {
      const v = sourceVideo;
      if (!v) return;
      if (v.paused) {
        v.play().catch(()=>{});
        document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
      } else {
        v.pause();
        document.getElementById('pauseBtn').textContent = 'â–¶ï¸ ç»§ç»­';
      }
    }

    // åˆå§‹åŒ–é¡µé¢äº‹ä»¶ç»‘å®š
    window.onload = function() {
      // ç»‘å®šäº‹ä»¶
      document.getElementById('levelSelect').addEventListener('change', loadUnits);
      // å®ç°ç®€å•çš„ç»Ÿä¸€å…¥å£ï¼ˆè‹¥è¦å¿«é€Ÿæµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥æŠŠ loadVideo è°ƒç”¨æ”¾åœ¨è¿™é‡Œï¼‰
      // è§¦å‘åˆå§‹çŠ¶æ€
      resetUI();
    };

  </script>
</body>
</html>
